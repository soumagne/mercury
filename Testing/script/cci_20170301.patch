diff -uNr cci-2.0/config/autogen_found_items.m4 cci-2.0-patch/config/autogen_found_items.m4
--- cci-2.0/config/autogen_found_items.m4	2016-06-28 12:57:48.000000000 -0500
+++ cci-2.0-patch/config/autogen_found_items.m4	2017-03-02 00:36:52.561850308 -0600
@@ -19,28 +19,28 @@
 AC_SUBST([PLUGINS_cci_FRAMEWORKS_SUBDIRS])
 
 dnl Plugins in the cci / ctp framework and their corresponding subdirectories
-m4_define([plugins_cci_ctp_m4_config_plugin_list], [verbs, eth, gni, sm])
+m4_define([plugins_cci_ctp_m4_config_plugin_list], [gni, sm, eth, verbs])
 m4_define([plugins_cci_ctp_no_config_plugin_list], [sock, tcp])
-PLUGINS_cci_ctp_ALL_PLUGINS="verbs eth sock gni tcp sm "
+PLUGINS_cci_ctp_ALL_PLUGINS="gni sm sock eth tcp verbs "
 AC_SUBST([PLUGINS_cci_ctp_ALL_PLUGINS])
-PLUGINS_cci_ctp_ALL_SUBDIRS="plugins/ctp/verbs plugins/ctp/eth plugins/ctp/sock plugins/ctp/gni plugins/ctp/tcp plugins/ctp/sm "
+PLUGINS_cci_ctp_ALL_SUBDIRS="plugins/ctp/gni plugins/ctp/sm plugins/ctp/sock plugins/ctp/eth plugins/ctp/tcp plugins/ctp/verbs "
 AC_SUBST([PLUGINS_cci_ctp_ALL_SUBDIRS])
 
 dnl ---------------------------------------------------------------------------
 
 dnl List of configure.m4 files to include
-m4_include([src/plugins/ctp/verbs/configure.m4])
-m4_include([src/plugins/ctp/eth/configure.m4])
 m4_include([src/plugins/ctp/gni/configure.m4])
 m4_include([src/plugins/ctp/sm/configure.m4])
+m4_include([src/plugins/ctp/eth/configure.m4])
+m4_include([src/plugins/ctp/verbs/configure.m4])
 
 dnl ---------------------------------------------------------------------------
 
 dnl List files to output
 AC_CONFIG_FILES([src/plugins/ctp/Makefile])
-AC_CONFIG_FILES([src/plugins/ctp/verbs/Makefile])
-AC_CONFIG_FILES([src/plugins/ctp/eth/Makefile])
-AC_CONFIG_FILES([src/plugins/ctp/sock/Makefile])
 AC_CONFIG_FILES([src/plugins/ctp/gni/Makefile])
-AC_CONFIG_FILES([src/plugins/ctp/tcp/Makefile])
 AC_CONFIG_FILES([src/plugins/ctp/sm/Makefile])
+AC_CONFIG_FILES([src/plugins/ctp/sock/Makefile])
+AC_CONFIG_FILES([src/plugins/ctp/eth/Makefile])
+AC_CONFIG_FILES([src/plugins/ctp/tcp/Makefile])
+AC_CONFIG_FILES([src/plugins/ctp/verbs/Makefile])
diff -uNr cci-2.0/config/config.guess cci-2.0-patch/config/config.guess
--- cci-2.0/config/config.guess	2016-06-28 12:58:04.000000000 -0500
+++ cci-2.0-patch/config/config.guess	2017-03-02 00:37:06.797928439 -0600
@@ -1,8 +1,8 @@
 #! /bin/sh
 # Attempt to guess a canonical system name.
-#   Copyright 1992-2014 Free Software Foundation, Inc.
+#   Copyright 1992-2015 Free Software Foundation, Inc.
 
-timestamp='2014-11-04'
+timestamp='2015-01-01'
 
 # This file is free software; you can redistribute it and/or modify it
 # under the terms of the GNU General Public License as published by
@@ -50,7 +50,7 @@
 GNU config.guess ($timestamp)
 
 Originally written by Per Bothner.
-Copyright 1992-2014 Free Software Foundation, Inc.
+Copyright 1992-2015 Free Software Foundation, Inc.
 
 This is free software; see the source for copying conditions.  There is NO
 warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE."
diff -uNr cci-2.0/config/config.sub cci-2.0-patch/config/config.sub
--- cci-2.0/config/config.sub	2016-06-28 12:58:04.000000000 -0500
+++ cci-2.0-patch/config/config.sub	2017-03-02 00:37:06.799928450 -0600
@@ -1,8 +1,8 @@
 #! /bin/sh
 # Configuration validation subroutine script.
-#   Copyright 1992-2014 Free Software Foundation, Inc.
+#   Copyright 1992-2015 Free Software Foundation, Inc.
 
-timestamp='2014-12-03'
+timestamp='2015-01-01'
 
 # This file is free software; you can redistribute it and/or modify it
 # under the terms of the GNU General Public License as published by
@@ -68,7 +68,7 @@
 version="\
 GNU config.sub ($timestamp)
 
-Copyright 1992-2014 Free Software Foundation, Inc.
+Copyright 1992-2015 Free Software Foundation, Inc.
 
 This is free software; see the source for copying conditions.  There is NO
 warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE."
@@ -260,7 +260,7 @@
 	| c4x | c8051 | clipper \
 	| d10v | d30v | dlx | dsp16xx \
 	| epiphany \
-	| fido | fr30 | frv \
+	| fido | fr30 | frv | ft32 \
 	| h8300 | h8500 | hppa | hppa1.[01] | hppa2.0 | hppa2.0[nw] | hppa64 \
 	| hexagon \
 	| i370 | i860 | i960 | ia64 \
@@ -1025,7 +1025,7 @@
 		;;
 	ppc64)	basic_machine=powerpc64-unknown
 		;;
-	ppc64-*) basic_machine=powerpc64-`echo $basic_machine | sed 's/^[^-]*-//'`
+	ppc64-* | ppc64p7-*) basic_machine=powerpc64-`echo $basic_machine | sed 's/^[^-]*-//'`
 		;;
 	ppc64le | powerpc64little | ppc64-le | powerpc64-little)
 		basic_machine=powerpc64le-unknown
diff -uNr cci-2.0/config/libtool.m4 cci-2.0-patch/config/libtool.m4
--- cci-2.0/config/libtool.m4	2016-06-28 12:57:59.000000000 -0500
+++ cci-2.0-patch/config/libtool.m4	2017-03-02 00:37:02.657905718 -0600
@@ -956,7 +956,7 @@
 echo "$lt_simple_compile_test_code" >conftest.$ac_ext
 eval "$ac_compile" 2>&1 >/dev/null | $SED '/^$/d; /^ *+/d' >conftest.err
 _lt_compiler_boilerplate=`cat conftest.err`
-$RM -r conftest*
+$RM conftest*
 ])# _LT_COMPILER_BOILERPLATE
 
 
@@ -1606,7 +1606,7 @@
        $2=yes
      fi
    fi
-   $RM -r conftest*
+   $RM conftest*
 ])
 
 if test yes = "[$]$2"; then
@@ -2090,14 +2090,14 @@
      fi
    fi
    chmod u+w . 2>&AS_MESSAGE_LOG_FD
-   $RM -r conftest*
+   $RM conftest*
    # SGI C++ compiler will create directory out/ii_files/ for
    # template instantiation
    test -d out/ii_files && $RM out/ii_files/* && rmdir out/ii_files
    $RM out/* && rmdir out
    cd ..
    $RM -r conftest
-   $RM -r conftest*
+   $RM conftest*
 ])
 _LT_TAGDECL([compiler_c_o], [lt_cv_prog_compiler_c_o], [1],
 	[Does compiler simultaneously support -c and -o options?])
@@ -2117,7 +2117,7 @@
   # do not overwrite the value of need_locks provided by the user
   AC_MSG_CHECKING([if we can lock with hard links])
   hard_links=yes
-  $RM -r conftest*
+  $RM conftest*
   ln conftest.a conftest.b 2>/dev/null && hard_links=no
   touch conftest.a
   ln conftest.a conftest.b 2>&5 || hard_links=no
@@ -2867,6 +2867,9 @@
   # before this can be enabled.
   hardcode_into_libs=yes
 
+  # Add ABI-specific directories to the system library path.
+  sys_lib_dlsearch_path_spec="/lib64 /usr/lib64 /lib /usr/lib"
+
   # Ideally, we could use ldconfig to report *all* directores which are
   # searched for libraries, however this is still not possible.  Aside from not
   # being certain /sbin/ldconfig is available, command
@@ -2875,7 +2878,7 @@
   # appending ld.so.conf contents (and includes) to the search path.
   if test -f /etc/ld.so.conf; then
     lt_ld_extra=`awk '/^include / { system(sprintf("cd /etc; cat %s 2>/dev/null", \[$]2)); skip = 1; } { if (!skip) print \[$]0; skip = 0; }' < /etc/ld.so.conf | $SED -e 's/#.*//;/^[	 ]*hwcap[	 ]/d;s/[:,	]/ /g;s/=[^=]*$//;s/=[^= ]* / /g;s/"//g;/^$/d' | tr '\n' ' '`
-    sys_lib_dlsearch_path_spec="/lib /usr/lib $lt_ld_extra"
+    sys_lib_dlsearch_path_spec="$sys_lib_dlsearch_path_spec $lt_ld_extra"
   fi
 
   # We used to test for /lib/ld.so.1 and disable shared libraries on
@@ -3747,7 +3750,7 @@
   if $GREP 'External.*some_variable' conftest.out > /dev/null; then
     lt_cv_nm_interface="MS dumpbin"
   fi
-  rm -rf conftest*])
+  rm -f conftest*])
 ])# LT_PATH_NM
 
 # Old names:
@@ -3811,7 +3814,7 @@
   if $GREP 'Manifest Tool' conftest.out > /dev/null; then
     lt_cv_path_mainfest_tool=yes
   fi
-  rm -rf conftest*])
+  rm -f conftest*])
 if test yes != "$lt_cv_path_mainfest_tool"; then
   MANIFEST_TOOL=:
 fi
@@ -4035,7 +4038,7 @@
   # Check to see that the pipe works correctly.
   pipe_works=no
 
-  rm -rf conftest*
+  rm -f conftest*
   cat > conftest.$ac_ext <<_LT_EOF
 #ifdef __cplusplus
 extern "C" {
@@ -6078,7 +6081,7 @@
       # to ld, don't add -lc before -lgcc.
       AC_CACHE_CHECK([whether -lc should be explicitly linked in],
 	[lt_cv_]_LT_TAGVAR(archive_cmds_need_lc, $1),
-	[$RM -r conftest*
+	[$RM conftest*
 	echo "$lt_simple_compile_test_code" > conftest.$ac_ext
 
 	if AC_TRY_EVAL(ac_compile) 2>conftest.err; then
@@ -6105,7 +6108,7 @@
 	else
 	  cat conftest.err 1>&5
 	fi
-	$RM -r conftest*
+	$RM conftest*
 	])
       _LT_TAGVAR(archive_cmds_need_lc, $1)=$lt_cv_[]_LT_TAGVAR(archive_cmds_need_lc, $1)
       ;;
diff -uNr cci-2.0/configure cci-2.0-patch/configure
--- cci-2.0/configure	2016-06-28 12:58:03.000000000 -0500
+++ cci-2.0-patch/configure	2017-03-02 00:37:05.423920898 -0600
@@ -662,6 +662,14 @@
 PLUGINS_cci_FRAMEWORK_PLUGIN_ALL_SUBDIRS
 PLUGINS_cci_ctp_DSO_SUBDIRS
 PLUGINS_cci_ctp_DSO_PLUGINS
+CCI_BUILD_cci_ctp_verbs_DSO_FALSE
+CCI_BUILD_cci_ctp_verbs_DSO_TRUE
+ctp_verbs_LIBS
+ctp_verbs_LDFLAGS
+ctp_verbs_CPPFLAGS
+ctp_verbs_CFLAGS
+CCI_BUILD_cci_ctp_eth_DSO_FALSE
+CCI_BUILD_cci_ctp_eth_DSO_TRUE
 CCI_BUILD_cci_ctp_sm_DSO_FALSE
 CCI_BUILD_cci_ctp_sm_DSO_TRUE
 ctp_sm_LIBS
@@ -674,14 +682,6 @@
 ctp_gni_LDFLAGS
 ctp_gni_CPPFLAGS
 ctp_gni_CFLAGS
-CCI_BUILD_cci_ctp_eth_DSO_FALSE
-CCI_BUILD_cci_ctp_eth_DSO_TRUE
-CCI_BUILD_cci_ctp_verbs_DSO_FALSE
-CCI_BUILD_cci_ctp_verbs_DSO_TRUE
-ctp_verbs_LIBS
-ctp_verbs_LDFLAGS
-ctp_verbs_CPPFLAGS
-ctp_verbs_CFLAGS
 CCI_BUILD_cci_ctp_tcp_DSO_FALSE
 CCI_BUILD_cci_ctp_tcp_DSO_TRUE
 CCI_BUILD_cci_ctp_sock_DSO_FALSE
@@ -810,8 +810,6 @@
 enable_valgrind
 enable_visibility
 enable_plugins_no_build
-with_verbs
-with_verbs_libdir
 with_gni
 with_gni_libdir
 with_gni_ptag
@@ -820,6 +818,8 @@
 with_sm_libdir
 with_sm_xpmem
 with_sm_cma
+with_verbs
+with_verbs_libdir
 enable_shared
 enable_static
 with_ltdl_include
@@ -1486,10 +1486,6 @@
 Optional Packages:
   --with-PACKAGE[=ARG]    use PACKAGE [ARG=yes]
   --without-PACKAGE       do not use PACKAGE (same as --with-PACKAGE=no)
-  --with-verbs(=DIR)      Build verbs support, optionally adding DIR/include,
-                          DIR/lib, and DIR/lib64 to the search path for
-                          headers and libraries
-  --with-verbs-libdir=DIR Search for the verbs libraries in DIR
   --with-gni(=DIR)        Build gni support, optionally adding DIR/include,
                           DIR/lib, and DIR/lib64 to the search path for
                           headers and libraries
@@ -1502,6 +1498,10 @@
   --with-sm-libdir=DIR    Search for the sm libraries in DIR
   --with-sm-xpmem=DIR     Build xpmem support in sm
   --with-sm-cma           Build cma support in sm
+  --with-verbs(=DIR)      Build verbs support, optionally adding DIR/include,
+                          DIR/lib, and DIR/lib64 to the search path for
+                          headers and libraries
+  --with-verbs-libdir=DIR Search for the verbs libraries in DIR
   --with-ltdl-include=DIR use the ltdl headers installed in DIR
   --with-ltdl-lib=DIR     use the ltdl library installed in DIR
   --with-included-ltdl=DIR
@@ -3693,12 +3693,12 @@
 done
 
 
-for ac_header in include/ltdl.h
+for ac_header in ltdl.h
 do :
-  ac_fn_c_check_header_mongrel "$LINENO" "include/ltdl.h" "ac_cv_header_include_ltdl_h" "$ac_includes_default"
-if test "x$ac_cv_header_include_ltdl_h" = xyes; then :
+  ac_fn_c_check_header_mongrel "$LINENO" "ltdl.h" "ac_cv_header_ltdl_h" "$ac_includes_default"
+if test "x$ac_cv_header_ltdl_h" = xyes; then :
   cat >>confdefs.h <<_ACEOF
-#define HAVE_INCLUDE_LTDL_H 1
+#define HAVE_LTDL_H 1
 _ACEOF
 
 fi
@@ -9041,9 +9041,9 @@
 
 
 
-PLUGINS_cci_ctp_ALL_PLUGINS="verbs eth sock gni tcp sm "
+PLUGINS_cci_ctp_ALL_PLUGINS="gni sm sock eth tcp verbs "
 
-PLUGINS_cci_ctp_ALL_SUBDIRS="plugins/ctp/verbs plugins/ctp/eth plugins/ctp/sock plugins/ctp/gni plugins/ctp/tcp plugins/ctp/sm "
+PLUGINS_cci_ctp_ALL_SUBDIRS="plugins/ctp/gni plugins/ctp/sm plugins/ctp/sock plugins/ctp/eth plugins/ctp/tcp plugins/ctp/verbs "
 
 
 
@@ -9062,14 +9062,13 @@
 #
 #     PLUGINS_cci_<type>_<your_plugin_name>_CONFIG
 #
-# PLUGINS_cci_ctp_verbs_CONFIG([action-if-can-compile],
-#                                  [action-if-cant-compile])
+# PLUGINS_cci_ctp_gni_CONFIG([action-if-can-compile],
+#                             [action-if-cant-compile])
 # ------------------------------------------------
 
 # -*- shell-script -*-
 #
-# Copyright (c) 2010 Cisco Systems, Inc.  All rights reserved.
-# Copyright © 2012 Inria.  All rights reserved.
+# Copyright (c) 2013 UT-Battelle, LLC.  All rights reserved.
 #
 # $COPYRIGHT$
 #
@@ -9082,13 +9081,14 @@
 #
 #     PLUGINS_cci_<type>_<your_plugin_name>_CONFIG
 #
-# PLUGINS_cci_ctp_eth_CONFIG([action-if-can-compile],
-#                            [action-if-cant-compile])
+# PLUGINS_cci_ctp_sm_CONFIG([action-if-can-compile],
+#                                  [action-if-cant-compile])
 # ------------------------------------------------
 
 # -*- shell-script -*-
 #
 # Copyright (c) 2010 Cisco Systems, Inc.  All rights reserved.
+# Copyright © 2012 Inria.  All rights reserved.
 #
 # $COPYRIGHT$
 #
@@ -9101,13 +9101,13 @@
 #
 #     PLUGINS_cci_<type>_<your_plugin_name>_CONFIG
 #
-# PLUGINS_cci_ctp_gni_CONFIG([action-if-can-compile],
-#                             [action-if-cant-compile])
+# PLUGINS_cci_ctp_eth_CONFIG([action-if-can-compile],
+#                            [action-if-cant-compile])
 # ------------------------------------------------
 
 # -*- shell-script -*-
 #
-# Copyright (c) 2013 UT-Battelle, LLC.  All rights reserved.
+# Copyright (c) 2010 Cisco Systems, Inc.  All rights reserved.
 #
 # $COPYRIGHT$
 #
@@ -9120,7 +9120,7 @@
 #
 #     PLUGINS_cci_<type>_<your_plugin_name>_CONFIG
 #
-# PLUGINS_cci_ctp_sm_CONFIG([action-if-can-compile],
+# PLUGINS_cci_ctp_verbs_CONFIG([action-if-can-compile],
 #                                  [action-if-cant-compile])
 # ------------------------------------------------
 
@@ -9128,17 +9128,17 @@
 
 ac_config_files="$ac_config_files src/plugins/ctp/Makefile"
 
-ac_config_files="$ac_config_files src/plugins/ctp/verbs/Makefile"
+ac_config_files="$ac_config_files src/plugins/ctp/gni/Makefile"
 
-ac_config_files="$ac_config_files src/plugins/ctp/eth/Makefile"
+ac_config_files="$ac_config_files src/plugins/ctp/sm/Makefile"
 
 ac_config_files="$ac_config_files src/plugins/ctp/sock/Makefile"
 
-ac_config_files="$ac_config_files src/plugins/ctp/gni/Makefile"
+ac_config_files="$ac_config_files src/plugins/ctp/eth/Makefile"
 
 ac_config_files="$ac_config_files src/plugins/ctp/tcp/Makefile"
 
-ac_config_files="$ac_config_files src/plugins/ctp/sm/Makefile"
+ac_config_files="$ac_config_files src/plugins/ctp/verbs/Makefile"
 
 
 
@@ -9283,8 +9283,8 @@
 $as_echo "sock, tcp" >&6; }
     { $as_echo "$as_me:${as_lineno-$LINENO}: checking for m4 configure plugins in framework ctp" >&5
 $as_echo_n "checking for m4 configure plugins in framework ctp... " >&6; }
-    { $as_echo "$as_me:${as_lineno-$LINENO}: result: verbs, eth, gni, sm" >&5
-$as_echo "verbs, eth, gni, sm" >&6; }
+    { $as_echo "$as_me:${as_lineno-$LINENO}: result: gni, sm, eth, verbs" >&5
+$as_echo "gni, sm, eth, verbs" >&6; }
 
     # configure plugins that don't have any plugin-specific
     # configuration.  See comment in CONFIGURE_PROJECT about the
@@ -9643,7 +9643,7 @@
 
 
 
-    cci_show_subsubsubtitle "cci plugin ctp:verbs (m4 configuration macro)"
+    cci_show_subsubsubtitle "cci plugin ctp:gni (m4 configuration macro)"
 
 
 
@@ -9656,7 +9656,7 @@
 
     project_root=src
     framework=ctp
-    plugin=verbs
+    plugin=gni
     plugin_path="$srcdir/$project_root/plugins/$framework/$plugin"
     want_plugin=1
 
@@ -9688,7 +9688,7 @@
 
     project=cci
     framework=ctp
-    plugin=verbs
+    plugin=gni
 
     # Is this plugin going to built staic or shared?  $plugin
     # might not be known until configure time, so have to use eval
@@ -9713,39 +9713,39 @@
 
 
     # Sadly, m4 does not allow comments in between each parameter, so
-    # they can'tbe documented inline.  :-( See a lengthy comment at
+    # they can't be documented inline. See a lengthy comment at
     # the top of config/cci_setup_plugin_package.m4 for a description
     # of what this macro does and what each of the parameters are.
 
 
-# Check whether --with-verbs was given.
-if test "${with_verbs+set}" = set; then :
-  withval=$with_verbs;
+# Check whether --with-gni was given.
+if test "${with_gni+set}" = set; then :
+  withval=$with_gni;
 fi
 
 
-    { $as_echo "$as_me:${as_lineno-$LINENO}: checking --with-verbs value" >&5
-$as_echo_n "checking --with-verbs value... " >&6; }
-    if test "$with_verbs" = "yes" -o "$with_verbs" = "no" -o "x$with_verbs" = "x"; then :
+    { $as_echo "$as_me:${as_lineno-$LINENO}: checking --with-gni value" >&5
+$as_echo_n "checking --with-gni value... " >&6; }
+    if test "$with_gni" = "yes" -o "$with_gni" = "no" -o "x$with_gni" = "x"; then :
   { $as_echo "$as_me:${as_lineno-$LINENO}: result: simple ok (unspecified)" >&5
 $as_echo "simple ok (unspecified)" >&6; }
 else
-  if test ! -d "$with_verbs"; then :
+  if test ! -d "$with_gni"; then :
   { $as_echo "$as_me:${as_lineno-$LINENO}: result: not found" >&5
 $as_echo "not found" >&6; }
-                  { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: Directory $with_verbs not found" >&5
-$as_echo "$as_me: WARNING: Directory $with_verbs not found" >&2;}
+                  { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: Directory $with_gni not found" >&5
+$as_echo "$as_me: WARNING: Directory $with_gni not found" >&2;}
                   as_fn_error $? "Cannot continue" "$LINENO" 5
 else
-  if test "x`ls $with_verbs/include/rdma/rdma_cma.h 2> /dev/null`" = "x"; then :
+  if test "x`ls $with_gni/include/gni_pub.h 2> /dev/null`" = "x"; then :
   { $as_echo "$as_me:${as_lineno-$LINENO}: result: not found" >&5
 $as_echo "not found" >&6; }
-                         { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: Expected file $with_verbs/include/rdma/rdma_cma.h not found" >&5
-$as_echo "$as_me: WARNING: Expected file $with_verbs/include/rdma/rdma_cma.h not found" >&2;}
+                         { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: Expected file $with_gni/include/gni_pub.h not found" >&5
+$as_echo "$as_me: WARNING: Expected file $with_gni/include/gni_pub.h not found" >&2;}
                          as_fn_error $? "Cannot continue" "$LINENO" 5
 else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: sanity check ok ($with_verbs)" >&5
-$as_echo "sanity check ok ($with_verbs)" >&6; }
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: sanity check ok ($with_gni)" >&5
+$as_echo "sanity check ok ($with_gni)" >&6; }
 
 fi
 
@@ -9756,34 +9756,34 @@
 fi
 
 
-# Check whether --with-verbs-libdir was given.
-if test "${with_verbs_libdir+set}" = set; then :
-  withval=$with_verbs_libdir;
+# Check whether --with-gni-libdir was given.
+if test "${with_gni_libdir+set}" = set; then :
+  withval=$with_gni_libdir;
 fi
 
 
-    { $as_echo "$as_me:${as_lineno-$LINENO}: checking --with-verbs-libdir value" >&5
-$as_echo_n "checking --with-verbs-libdir value... " >&6; }
-    if test "$with_verbs_libdir" = "yes" -o "$with_verbs_libdir" = "no" -o "x$with_verbs_libdir" = "x"; then :
+    { $as_echo "$as_me:${as_lineno-$LINENO}: checking --with-gni-libdir value" >&5
+$as_echo_n "checking --with-gni-libdir value... " >&6; }
+    if test "$with_gni_libdir" = "yes" -o "$with_gni_libdir" = "no" -o "x$with_gni_libdir" = "x"; then :
   { $as_echo "$as_me:${as_lineno-$LINENO}: result: simple ok (unspecified)" >&5
 $as_echo "simple ok (unspecified)" >&6; }
 else
-  if test ! -d "$with_verbs_libdir"; then :
+  if test ! -d "$with_gni_libdir"; then :
   { $as_echo "$as_me:${as_lineno-$LINENO}: result: not found" >&5
 $as_echo "not found" >&6; }
-                  { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: Directory $with_verbs_libdir not found" >&5
-$as_echo "$as_me: WARNING: Directory $with_verbs_libdir not found" >&2;}
+                  { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: Directory $with_gni_libdir not found" >&5
+$as_echo "$as_me: WARNING: Directory $with_gni_libdir not found" >&2;}
                   as_fn_error $? "Cannot continue" "$LINENO" 5
 else
-  if test "x`ls $with_verbs_libdir/librdmacm* 2> /dev/null`" = "x"; then :
+  if test "x`ls $with_gni_libdir/libugni* 2> /dev/null`" = "x"; then :
   { $as_echo "$as_me:${as_lineno-$LINENO}: result: not found" >&5
 $as_echo "not found" >&6; }
-                         { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: Expected file $with_verbs_libdir/librdmacm* not found" >&5
-$as_echo "$as_me: WARNING: Expected file $with_verbs_libdir/librdmacm* not found" >&2;}
+                         { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: Expected file $with_gni_libdir/libugni* not found" >&5
+$as_echo "$as_me: WARNING: Expected file $with_gni_libdir/libugni* not found" >&2;}
                          as_fn_error $? "Cannot continue" "$LINENO" 5
 else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: sanity check ok ($with_verbs_libdir)" >&5
-$as_echo "sanity check ok ($with_verbs_libdir)" >&6; }
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: sanity check ok ($with_gni_libdir)" >&5
+$as_echo "sanity check ok ($with_gni_libdir)" >&6; }
 
 fi
 
@@ -9794,28 +9794,28 @@
 fi
 
 
-    if test ! -z "$with_verbs" -a "$with_verbs" != "yes"; then :
-  ctp_verbs_dir="$with_verbs"
+    if test ! -z "$with_gni" -a "$with_gni" != "yes"; then :
+  ctp_gni_dir="$with_gni"
 fi
-    if test ! -z "$with_verbs_libdir" -a "$with_verbs_libdir" != "yes"; then :
-  ctp_verbs_libdir="$with_verbs_libdir"
+    if test ! -z "$with_gni_libdir" -a "$with_gni_libdir" != "yes"; then :
+  ctp_gni_libdir="$with_gni_libdir"
 fi
 
-    if test "$with_verbs" = "no"; then :
-  ctp_verbs_happy="no"
+    if test "$with_gni" = "no"; then :
+  ctp_gni_happy="no"
 else
-  ctp_verbs_happy="yes"
+  ctp_gni_happy="yes"
 fi
 
-    if test "$ctp_verbs_happy" = "yes"; then :
+    if test "$ctp_gni_happy" = "yes"; then :
 
-    cci_check_package_ctp_verbs_save_CPPFLAGS="$CPPFLAGS"
-    cci_check_package_ctp_verbs_save_LDFLAGS="$LDFLAGS"
-    cci_check_package_ctp_verbs_save_LIBS="$LIBS"
+    cci_check_package_ctp_gni_save_CPPFLAGS="$CPPFLAGS"
+    cci_check_package_ctp_gni_save_LDFLAGS="$LDFLAGS"
+    cci_check_package_ctp_gni_save_LIBS="$LIBS"
 
-    cci_check_package_ctp_verbs_orig_CPPFLAGS="$ctp_verbs_CPPFLAGS"
-    cci_check_package_ctp_verbs_orig_LDFLAGS="$ctp_verbs_LDFLAGS"
-    cci_check_package_ctp_verbs_orig_LIBS="$ctp_verbs_LIBS"
+    cci_check_package_ctp_gni_orig_CPPFLAGS="$ctp_gni_CPPFLAGS"
+    cci_check_package_ctp_gni_orig_LDFLAGS="$ctp_gni_LDFLAGS"
+    cci_check_package_ctp_gni_orig_LIBS="$ctp_gni_LIBS"
 
 
     # This is stolen from autoconf to peek under the covers to get the
@@ -9826,15 +9826,15 @@
     # so this sucks, but there's no way to get through the progression
     # of header includes without killing off the cache variable and trying
     # again...
-    unset ac_cv_header_rdma_rdma_cma_h
+    unset ac_cv_header_gni_pub_h
 
     cci_check_package_header_happy="no"
-    if test "$ctp_verbs_dir" = "/usr" -o "$ctp_verbs_dir" = "/usr/local"; then :
+    if test "$ctp_gni_dir" = "/usr" -o "$ctp_gni_dir" = "/usr/local"; then :
    # try as is...
             { $as_echo "$as_me:${as_lineno-$LINENO}: result: looking for header without includes" >&5
 $as_echo "looking for header without includes" >&6; }
-            ac_fn_c_check_header_mongrel "$LINENO" "rdma/rdma_cma.h" "ac_cv_header_rdma_rdma_cma_h" "$ac_includes_default"
-if test "x$ac_cv_header_rdma_rdma_cma_h" = xyes; then :
+            ac_fn_c_check_header_mongrel "$LINENO" "gni_pub.h" "ac_cv_header_gni_pub_h" "$ac_includes_default"
+if test "x$ac_cv_header_gni_pub_h" = xyes; then :
   cci_check_package_header_happy="yes"
 else
   cci_check_package_header_happy="no"
@@ -9843,36 +9843,36 @@
 
             if test "$cci_check_package_header_happy" = "no"; then :
   # no go on the as is - reset the cache and try again
-                   unset ac_cv_header_rdma_rdma_cma_h
+                   unset ac_cv_header_gni_pub_h
 fi
 fi
 
     if test "$cci_check_package_header_happy" = "no"; then :
-  if test "$ctp_verbs_dir" != ""; then :
-  ctp_verbs_CPPFLAGS="$ctp_verbs_CPPFLAGS -I$ctp_verbs_dir/include"
-                  CPPFLAGS="$CPPFLAGS -I$ctp_verbs_dir/include"
+  if test "$ctp_gni_dir" != ""; then :
+  ctp_gni_CPPFLAGS="$ctp_gni_CPPFLAGS -I$ctp_gni_dir/include"
+                  CPPFLAGS="$CPPFLAGS -I$ctp_gni_dir/include"
 fi
-           ac_fn_c_check_header_mongrel "$LINENO" "rdma/rdma_cma.h" "ac_cv_header_rdma_rdma_cma_h" "$ac_includes_default"
-if test "x$ac_cv_header_rdma_rdma_cma_h" = xyes; then :
+           ac_fn_c_check_header_mongrel "$LINENO" "gni_pub.h" "ac_cv_header_gni_pub_h" "$ac_includes_default"
+if test "x$ac_cv_header_gni_pub_h" = xyes; then :
 
     # This is stolen from autoconf to peek under the covers to get the
     # cache variable for the library check.  one should not copy this
     # code into other places unless you want much pain and suffering
 
     # see comment above
-    unset ac_cv_lib_rdmacm_rdma_create_id
+    unset ac_cv_lib_ugni_GNI_CdmCreate
     cci_check_package_lib_happy="no"
-    if test "$ctp_verbs_libdir" != ""; then :
+    if test "$ctp_gni_libdir" != ""; then :
    # libdir was specified - search only there
-           ctp_verbs_LDFLAGS="$ctp_verbs_LDFLAGS -L$ctp_verbs_libdir"
-           LDFLAGS="$LDFLAGS -L$ctp_verbs_libdir"
-           { $as_echo "$as_me:${as_lineno-$LINENO}: checking for rdma_create_id in -lrdmacm" >&5
-$as_echo_n "checking for rdma_create_id in -lrdmacm... " >&6; }
-if ${ac_cv_lib_rdmacm_rdma_create_id+:} false; then :
+           ctp_gni_LDFLAGS="$ctp_gni_LDFLAGS -L$ctp_gni_libdir"
+           LDFLAGS="$LDFLAGS -L$ctp_gni_libdir"
+           { $as_echo "$as_me:${as_lineno-$LINENO}: checking for GNI_CdmCreate in -lugni" >&5
+$as_echo_n "checking for GNI_CdmCreate in -lugni... " >&6; }
+if ${ac_cv_lib_ugni_GNI_CdmCreate+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   ac_check_lib_save_LIBS=$LIBS
-LIBS="-lrdmacm -libverbs $LIBS"
+LIBS="-lugni  $LIBS"
 cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
 
@@ -9882,51 +9882,51 @@
 #ifdef __cplusplus
 extern "C"
 #endif
-char rdma_create_id ();
+char GNI_CdmCreate ();
 int
 main ()
 {
-return rdma_create_id ();
+return GNI_CdmCreate ();
   ;
   return 0;
 }
 _ACEOF
 if ac_fn_c_try_link "$LINENO"; then :
-  ac_cv_lib_rdmacm_rdma_create_id=yes
+  ac_cv_lib_ugni_GNI_CdmCreate=yes
 else
-  ac_cv_lib_rdmacm_rdma_create_id=no
+  ac_cv_lib_ugni_GNI_CdmCreate=no
 fi
 rm -f core conftest.err conftest.$ac_objext \
     conftest$ac_exeext conftest.$ac_ext
 LIBS=$ac_check_lib_save_LIBS
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_rdmacm_rdma_create_id" >&5
-$as_echo "$ac_cv_lib_rdmacm_rdma_create_id" >&6; }
-if test "x$ac_cv_lib_rdmacm_rdma_create_id" = xyes; then :
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_ugni_GNI_CdmCreate" >&5
+$as_echo "$ac_cv_lib_ugni_GNI_CdmCreate" >&6; }
+if test "x$ac_cv_lib_ugni_GNI_CdmCreate" = xyes; then :
   cci_check_package_lib_happy="yes"
 else
   cci_check_package_lib_happy="no"
 fi
 
            if test "$cci_check_package_lib_happy" = "no"; then :
-  LDFLAGS="$cci_check_package_ctp_verbs_save_LDFLAGS"
-                  ctp_verbs_LDFLAGS="$cci_check_package_ctp_verbs_orig_LDFLAGS"
-                  unset ac_cv_lib_rdmacm_rdma_create_id
+  LDFLAGS="$cci_check_package_ctp_gni_save_LDFLAGS"
+                  ctp_gni_LDFLAGS="$cci_check_package_ctp_gni_orig_LDFLAGS"
+                  unset ac_cv_lib_ugni_GNI_CdmCreate
 fi
 else
    # libdir was not specified - go through search path
-           cci_check_package_libdir="$ctp_verbs_dir"
+           cci_check_package_libdir="$ctp_gni_dir"
            if test "$cci_check_package_libdir" = "" -o "$cci_check_package_libdir" = "/usr" -o "$cci_check_package_libdir" = "/usr/local"; then :
    # try as is...
                 { $as_echo "$as_me:${as_lineno-$LINENO}: result: looking for library without search path" >&5
 $as_echo "looking for library without search path" >&6; }
-                { $as_echo "$as_me:${as_lineno-$LINENO}: checking for rdma_create_id in -lrdmacm" >&5
-$as_echo_n "checking for rdma_create_id in -lrdmacm... " >&6; }
-if ${ac_cv_lib_rdmacm_rdma_create_id+:} false; then :
+                { $as_echo "$as_me:${as_lineno-$LINENO}: checking for GNI_CdmCreate in -lugni" >&5
+$as_echo_n "checking for GNI_CdmCreate in -lugni... " >&6; }
+if ${ac_cv_lib_ugni_GNI_CdmCreate+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   ac_check_lib_save_LIBS=$LIBS
-LIBS="-lrdmacm -libverbs $LIBS"
+LIBS="-lugni  $LIBS"
 cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
 
@@ -9936,27 +9936,27 @@
 #ifdef __cplusplus
 extern "C"
 #endif
-char rdma_create_id ();
+char GNI_CdmCreate ();
 int
 main ()
 {
-return rdma_create_id ();
+return GNI_CdmCreate ();
   ;
   return 0;
 }
 _ACEOF
 if ac_fn_c_try_link "$LINENO"; then :
-  ac_cv_lib_rdmacm_rdma_create_id=yes
+  ac_cv_lib_ugni_GNI_CdmCreate=yes
 else
-  ac_cv_lib_rdmacm_rdma_create_id=no
+  ac_cv_lib_ugni_GNI_CdmCreate=no
 fi
 rm -f core conftest.err conftest.$ac_objext \
     conftest$ac_exeext conftest.$ac_ext
 LIBS=$ac_check_lib_save_LIBS
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_rdmacm_rdma_create_id" >&5
-$as_echo "$ac_cv_lib_rdmacm_rdma_create_id" >&6; }
-if test "x$ac_cv_lib_rdmacm_rdma_create_id" = xyes; then :
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_ugni_GNI_CdmCreate" >&5
+$as_echo "$ac_cv_lib_ugni_GNI_CdmCreate" >&6; }
+if test "x$ac_cv_lib_ugni_GNI_CdmCreate" = xyes; then :
   cci_check_package_lib_happy="yes"
 else
   cci_check_package_lib_happy="no"
@@ -9964,25 +9964,25 @@
 
                 if test "$cci_check_package_lib_happy" = "no"; then :
    # no go on the as is..  see what happens later...
-                     LDFLAGS="$cci_check_package_ctp_verbs_save_LDFLAGS"
-                     ctp_verbs_LDFLAGS="$cci_check_package_ctp_verbs_orig_LDFLAGS"
-                     unset ac_cv_lib_rdmacm_rdma_create_id
+                     LDFLAGS="$cci_check_package_ctp_gni_save_LDFLAGS"
+                     ctp_gni_LDFLAGS="$cci_check_package_ctp_gni_orig_LDFLAGS"
+                     unset ac_cv_lib_ugni_GNI_CdmCreate
 fi
 fi
 
            if test "$cci_check_package_lib_happy" = "no"; then :
   if test "$cci_check_package_libdir" != ""; then :
-  ctp_verbs_LDFLAGS="$ctp_verbs_LDFLAGS -L$cci_check_package_libdir/lib"
+  ctp_gni_LDFLAGS="$ctp_gni_LDFLAGS -L$cci_check_package_libdir/lib"
                      LDFLAGS="$LDFLAGS -L$cci_check_package_libdir/lib"
                      { $as_echo "$as_me:${as_lineno-$LINENO}: result: looking for library in lib" >&5
 $as_echo "looking for library in lib" >&6; }
-                     { $as_echo "$as_me:${as_lineno-$LINENO}: checking for rdma_create_id in -lrdmacm" >&5
-$as_echo_n "checking for rdma_create_id in -lrdmacm... " >&6; }
-if ${ac_cv_lib_rdmacm_rdma_create_id+:} false; then :
+                     { $as_echo "$as_me:${as_lineno-$LINENO}: checking for GNI_CdmCreate in -lugni" >&5
+$as_echo_n "checking for GNI_CdmCreate in -lugni... " >&6; }
+if ${ac_cv_lib_ugni_GNI_CdmCreate+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   ac_check_lib_save_LIBS=$LIBS
-LIBS="-lrdmacm -libverbs $LIBS"
+LIBS="-lugni  $LIBS"
 cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
 
@@ -9992,27 +9992,27 @@
 #ifdef __cplusplus
 extern "C"
 #endif
-char rdma_create_id ();
+char GNI_CdmCreate ();
 int
 main ()
 {
-return rdma_create_id ();
+return GNI_CdmCreate ();
   ;
   return 0;
 }
 _ACEOF
 if ac_fn_c_try_link "$LINENO"; then :
-  ac_cv_lib_rdmacm_rdma_create_id=yes
+  ac_cv_lib_ugni_GNI_CdmCreate=yes
 else
-  ac_cv_lib_rdmacm_rdma_create_id=no
+  ac_cv_lib_ugni_GNI_CdmCreate=no
 fi
 rm -f core conftest.err conftest.$ac_objext \
     conftest$ac_exeext conftest.$ac_ext
 LIBS=$ac_check_lib_save_LIBS
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_rdmacm_rdma_create_id" >&5
-$as_echo "$ac_cv_lib_rdmacm_rdma_create_id" >&6; }
-if test "x$ac_cv_lib_rdmacm_rdma_create_id" = xyes; then :
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_ugni_GNI_CdmCreate" >&5
+$as_echo "$ac_cv_lib_ugni_GNI_CdmCreate" >&6; }
+if test "x$ac_cv_lib_ugni_GNI_CdmCreate" = xyes; then :
   cci_check_package_lib_happy="yes"
 else
   cci_check_package_lib_happy="no"
@@ -10020,26 +10020,26 @@
 
                      if test "$cci_check_package_lib_happy" = "no"; then :
    # no go on the as is..  see what happens later...
-                          LDFLAGS="$cci_check_package_ctp_verbs_save_LDFLAGS"
-                          ctp_verbs_LDFLAGS="$cci_check_package_ctp_verbs_orig_LDFLAGS"
-                          unset ac_cv_lib_rdmacm_rdma_create_id
+                          LDFLAGS="$cci_check_package_ctp_gni_save_LDFLAGS"
+                          ctp_gni_LDFLAGS="$cci_check_package_ctp_gni_orig_LDFLAGS"
+                          unset ac_cv_lib_ugni_GNI_CdmCreate
 fi
 fi
 fi
 
            if test "$cci_check_package_lib_happy" = "no"; then :
   if test "$cci_check_package_libdir" != ""; then :
-  ctp_verbs_LDFLAGS="$ctp_verbs_LDFLAGS -L$cci_check_package_libdir/lib64"
+  ctp_gni_LDFLAGS="$ctp_gni_LDFLAGS -L$cci_check_package_libdir/lib64"
                      LDFLAGS="$LDFLAGS -L$cci_check_package_libdir/lib64"
                      { $as_echo "$as_me:${as_lineno-$LINENO}: result: looking for library in lib64" >&5
 $as_echo "looking for library in lib64" >&6; }
-                     { $as_echo "$as_me:${as_lineno-$LINENO}: checking for rdma_create_id in -lrdmacm" >&5
-$as_echo_n "checking for rdma_create_id in -lrdmacm... " >&6; }
-if ${ac_cv_lib_rdmacm_rdma_create_id+:} false; then :
+                     { $as_echo "$as_me:${as_lineno-$LINENO}: checking for GNI_CdmCreate in -lugni" >&5
+$as_echo_n "checking for GNI_CdmCreate in -lugni... " >&6; }
+if ${ac_cv_lib_ugni_GNI_CdmCreate+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   ac_check_lib_save_LIBS=$LIBS
-LIBS="-lrdmacm -libverbs $LIBS"
+LIBS="-lugni  $LIBS"
 cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
 
@@ -10049,27 +10049,27 @@
 #ifdef __cplusplus
 extern "C"
 #endif
-char rdma_create_id ();
+char GNI_CdmCreate ();
 int
 main ()
 {
-return rdma_create_id ();
+return GNI_CdmCreate ();
   ;
   return 0;
 }
 _ACEOF
 if ac_fn_c_try_link "$LINENO"; then :
-  ac_cv_lib_rdmacm_rdma_create_id=yes
+  ac_cv_lib_ugni_GNI_CdmCreate=yes
 else
-  ac_cv_lib_rdmacm_rdma_create_id=no
+  ac_cv_lib_ugni_GNI_CdmCreate=no
 fi
 rm -f core conftest.err conftest.$ac_objext \
     conftest$ac_exeext conftest.$ac_ext
 LIBS=$ac_check_lib_save_LIBS
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_rdmacm_rdma_create_id" >&5
-$as_echo "$ac_cv_lib_rdmacm_rdma_create_id" >&6; }
-if test "x$ac_cv_lib_rdmacm_rdma_create_id" = xyes; then :
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_ugni_GNI_CdmCreate" >&5
+$as_echo "$ac_cv_lib_ugni_GNI_CdmCreate" >&6; }
+if test "x$ac_cv_lib_ugni_GNI_CdmCreate" = xyes; then :
   cci_check_package_lib_happy="yes"
 else
   cci_check_package_lib_happy="no"
@@ -10077,16 +10077,16 @@
 
                      if test "$cci_check_package_lib_happy" = "no"; then :
    # no go on the as is..  see what happens later...
-                          LDFLAGS="$cci_check_package_ctp_verbs_save_LDFLAGS"
-                          ctp_verbs_LDFLAGS="$cci_check_package_ctp_verbs_orig_LDFLAGS"
-                          unset ac_cv_lib_rdmacm_rdma_create_id
+                          LDFLAGS="$cci_check_package_ctp_gni_save_LDFLAGS"
+                          ctp_gni_LDFLAGS="$cci_check_package_ctp_gni_orig_LDFLAGS"
+                          unset ac_cv_lib_ugni_GNI_CdmCreate
 fi
 fi
 fi
 fi
 
     if test "$cci_check_package_lib_happy" = "yes"; then :
-  ctp_verbs_LIBS="-lrdmacm -libverbs"
+  ctp_gni_LIBS="-lugni "
            cci_check_package_happy="yes"
 else
   cci_check_package_happy="no"
@@ -10105,19 +10105,19 @@
     # code into other places unless you want much pain and suffering
 
     # see comment above
-    unset ac_cv_lib_rdmacm_rdma_create_id
+    unset ac_cv_lib_ugni_GNI_CdmCreate
     cci_check_package_lib_happy="no"
-    if test "$ctp_verbs_libdir" != ""; then :
+    if test "$ctp_gni_libdir" != ""; then :
    # libdir was specified - search only there
-           ctp_verbs_LDFLAGS="$ctp_verbs_LDFLAGS -L$ctp_verbs_libdir"
-           LDFLAGS="$LDFLAGS -L$ctp_verbs_libdir"
-           { $as_echo "$as_me:${as_lineno-$LINENO}: checking for rdma_create_id in -lrdmacm" >&5
-$as_echo_n "checking for rdma_create_id in -lrdmacm... " >&6; }
-if ${ac_cv_lib_rdmacm_rdma_create_id+:} false; then :
+           ctp_gni_LDFLAGS="$ctp_gni_LDFLAGS -L$ctp_gni_libdir"
+           LDFLAGS="$LDFLAGS -L$ctp_gni_libdir"
+           { $as_echo "$as_me:${as_lineno-$LINENO}: checking for GNI_CdmCreate in -lugni" >&5
+$as_echo_n "checking for GNI_CdmCreate in -lugni... " >&6; }
+if ${ac_cv_lib_ugni_GNI_CdmCreate+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   ac_check_lib_save_LIBS=$LIBS
-LIBS="-lrdmacm -libverbs $LIBS"
+LIBS="-lugni  $LIBS"
 cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
 
@@ -10127,51 +10127,51 @@
 #ifdef __cplusplus
 extern "C"
 #endif
-char rdma_create_id ();
+char GNI_CdmCreate ();
 int
 main ()
 {
-return rdma_create_id ();
+return GNI_CdmCreate ();
   ;
   return 0;
 }
 _ACEOF
 if ac_fn_c_try_link "$LINENO"; then :
-  ac_cv_lib_rdmacm_rdma_create_id=yes
+  ac_cv_lib_ugni_GNI_CdmCreate=yes
 else
-  ac_cv_lib_rdmacm_rdma_create_id=no
+  ac_cv_lib_ugni_GNI_CdmCreate=no
 fi
 rm -f core conftest.err conftest.$ac_objext \
     conftest$ac_exeext conftest.$ac_ext
 LIBS=$ac_check_lib_save_LIBS
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_rdmacm_rdma_create_id" >&5
-$as_echo "$ac_cv_lib_rdmacm_rdma_create_id" >&6; }
-if test "x$ac_cv_lib_rdmacm_rdma_create_id" = xyes; then :
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_ugni_GNI_CdmCreate" >&5
+$as_echo "$ac_cv_lib_ugni_GNI_CdmCreate" >&6; }
+if test "x$ac_cv_lib_ugni_GNI_CdmCreate" = xyes; then :
   cci_check_package_lib_happy="yes"
 else
   cci_check_package_lib_happy="no"
 fi
 
            if test "$cci_check_package_lib_happy" = "no"; then :
-  LDFLAGS="$cci_check_package_ctp_verbs_save_LDFLAGS"
-                  ctp_verbs_LDFLAGS="$cci_check_package_ctp_verbs_orig_LDFLAGS"
-                  unset ac_cv_lib_rdmacm_rdma_create_id
+  LDFLAGS="$cci_check_package_ctp_gni_save_LDFLAGS"
+                  ctp_gni_LDFLAGS="$cci_check_package_ctp_gni_orig_LDFLAGS"
+                  unset ac_cv_lib_ugni_GNI_CdmCreate
 fi
 else
    # libdir was not specified - go through search path
-           cci_check_package_libdir="$ctp_verbs_dir"
+           cci_check_package_libdir="$ctp_gni_dir"
            if test "$cci_check_package_libdir" = "" -o "$cci_check_package_libdir" = "/usr" -o "$cci_check_package_libdir" = "/usr/local"; then :
    # try as is...
                 { $as_echo "$as_me:${as_lineno-$LINENO}: result: looking for library without search path" >&5
 $as_echo "looking for library without search path" >&6; }
-                { $as_echo "$as_me:${as_lineno-$LINENO}: checking for rdma_create_id in -lrdmacm" >&5
-$as_echo_n "checking for rdma_create_id in -lrdmacm... " >&6; }
-if ${ac_cv_lib_rdmacm_rdma_create_id+:} false; then :
+                { $as_echo "$as_me:${as_lineno-$LINENO}: checking for GNI_CdmCreate in -lugni" >&5
+$as_echo_n "checking for GNI_CdmCreate in -lugni... " >&6; }
+if ${ac_cv_lib_ugni_GNI_CdmCreate+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   ac_check_lib_save_LIBS=$LIBS
-LIBS="-lrdmacm -libverbs $LIBS"
+LIBS="-lugni  $LIBS"
 cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
 
@@ -10181,27 +10181,27 @@
 #ifdef __cplusplus
 extern "C"
 #endif
-char rdma_create_id ();
+char GNI_CdmCreate ();
 int
 main ()
 {
-return rdma_create_id ();
+return GNI_CdmCreate ();
   ;
   return 0;
 }
 _ACEOF
 if ac_fn_c_try_link "$LINENO"; then :
-  ac_cv_lib_rdmacm_rdma_create_id=yes
+  ac_cv_lib_ugni_GNI_CdmCreate=yes
 else
-  ac_cv_lib_rdmacm_rdma_create_id=no
+  ac_cv_lib_ugni_GNI_CdmCreate=no
 fi
 rm -f core conftest.err conftest.$ac_objext \
     conftest$ac_exeext conftest.$ac_ext
 LIBS=$ac_check_lib_save_LIBS
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_rdmacm_rdma_create_id" >&5
-$as_echo "$ac_cv_lib_rdmacm_rdma_create_id" >&6; }
-if test "x$ac_cv_lib_rdmacm_rdma_create_id" = xyes; then :
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_ugni_GNI_CdmCreate" >&5
+$as_echo "$ac_cv_lib_ugni_GNI_CdmCreate" >&6; }
+if test "x$ac_cv_lib_ugni_GNI_CdmCreate" = xyes; then :
   cci_check_package_lib_happy="yes"
 else
   cci_check_package_lib_happy="no"
@@ -10209,25 +10209,25 @@
 
                 if test "$cci_check_package_lib_happy" = "no"; then :
    # no go on the as is..  see what happens later...
-                     LDFLAGS="$cci_check_package_ctp_verbs_save_LDFLAGS"
-                     ctp_verbs_LDFLAGS="$cci_check_package_ctp_verbs_orig_LDFLAGS"
-                     unset ac_cv_lib_rdmacm_rdma_create_id
+                     LDFLAGS="$cci_check_package_ctp_gni_save_LDFLAGS"
+                     ctp_gni_LDFLAGS="$cci_check_package_ctp_gni_orig_LDFLAGS"
+                     unset ac_cv_lib_ugni_GNI_CdmCreate
 fi
 fi
 
            if test "$cci_check_package_lib_happy" = "no"; then :
   if test "$cci_check_package_libdir" != ""; then :
-  ctp_verbs_LDFLAGS="$ctp_verbs_LDFLAGS -L$cci_check_package_libdir/lib"
+  ctp_gni_LDFLAGS="$ctp_gni_LDFLAGS -L$cci_check_package_libdir/lib"
                      LDFLAGS="$LDFLAGS -L$cci_check_package_libdir/lib"
                      { $as_echo "$as_me:${as_lineno-$LINENO}: result: looking for library in lib" >&5
 $as_echo "looking for library in lib" >&6; }
-                     { $as_echo "$as_me:${as_lineno-$LINENO}: checking for rdma_create_id in -lrdmacm" >&5
-$as_echo_n "checking for rdma_create_id in -lrdmacm... " >&6; }
-if ${ac_cv_lib_rdmacm_rdma_create_id+:} false; then :
+                     { $as_echo "$as_me:${as_lineno-$LINENO}: checking for GNI_CdmCreate in -lugni" >&5
+$as_echo_n "checking for GNI_CdmCreate in -lugni... " >&6; }
+if ${ac_cv_lib_ugni_GNI_CdmCreate+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   ac_check_lib_save_LIBS=$LIBS
-LIBS="-lrdmacm -libverbs $LIBS"
+LIBS="-lugni  $LIBS"
 cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
 
@@ -10237,27 +10237,27 @@
 #ifdef __cplusplus
 extern "C"
 #endif
-char rdma_create_id ();
+char GNI_CdmCreate ();
 int
 main ()
 {
-return rdma_create_id ();
+return GNI_CdmCreate ();
   ;
   return 0;
 }
 _ACEOF
 if ac_fn_c_try_link "$LINENO"; then :
-  ac_cv_lib_rdmacm_rdma_create_id=yes
+  ac_cv_lib_ugni_GNI_CdmCreate=yes
 else
-  ac_cv_lib_rdmacm_rdma_create_id=no
+  ac_cv_lib_ugni_GNI_CdmCreate=no
 fi
 rm -f core conftest.err conftest.$ac_objext \
     conftest$ac_exeext conftest.$ac_ext
 LIBS=$ac_check_lib_save_LIBS
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_rdmacm_rdma_create_id" >&5
-$as_echo "$ac_cv_lib_rdmacm_rdma_create_id" >&6; }
-if test "x$ac_cv_lib_rdmacm_rdma_create_id" = xyes; then :
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_ugni_GNI_CdmCreate" >&5
+$as_echo "$ac_cv_lib_ugni_GNI_CdmCreate" >&6; }
+if test "x$ac_cv_lib_ugni_GNI_CdmCreate" = xyes; then :
   cci_check_package_lib_happy="yes"
 else
   cci_check_package_lib_happy="no"
@@ -10265,26 +10265,26 @@
 
                      if test "$cci_check_package_lib_happy" = "no"; then :
    # no go on the as is..  see what happens later...
-                          LDFLAGS="$cci_check_package_ctp_verbs_save_LDFLAGS"
-                          ctp_verbs_LDFLAGS="$cci_check_package_ctp_verbs_orig_LDFLAGS"
-                          unset ac_cv_lib_rdmacm_rdma_create_id
+                          LDFLAGS="$cci_check_package_ctp_gni_save_LDFLAGS"
+                          ctp_gni_LDFLAGS="$cci_check_package_ctp_gni_orig_LDFLAGS"
+                          unset ac_cv_lib_ugni_GNI_CdmCreate
 fi
 fi
 fi
 
            if test "$cci_check_package_lib_happy" = "no"; then :
   if test "$cci_check_package_libdir" != ""; then :
-  ctp_verbs_LDFLAGS="$ctp_verbs_LDFLAGS -L$cci_check_package_libdir/lib64"
+  ctp_gni_LDFLAGS="$ctp_gni_LDFLAGS -L$cci_check_package_libdir/lib64"
                      LDFLAGS="$LDFLAGS -L$cci_check_package_libdir/lib64"
                      { $as_echo "$as_me:${as_lineno-$LINENO}: result: looking for library in lib64" >&5
 $as_echo "looking for library in lib64" >&6; }
-                     { $as_echo "$as_me:${as_lineno-$LINENO}: checking for rdma_create_id in -lrdmacm" >&5
-$as_echo_n "checking for rdma_create_id in -lrdmacm... " >&6; }
-if ${ac_cv_lib_rdmacm_rdma_create_id+:} false; then :
+                     { $as_echo "$as_me:${as_lineno-$LINENO}: checking for GNI_CdmCreate in -lugni" >&5
+$as_echo_n "checking for GNI_CdmCreate in -lugni... " >&6; }
+if ${ac_cv_lib_ugni_GNI_CdmCreate+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   ac_check_lib_save_LIBS=$LIBS
-LIBS="-lrdmacm -libverbs $LIBS"
+LIBS="-lugni  $LIBS"
 cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
 
@@ -10294,27 +10294,27 @@
 #ifdef __cplusplus
 extern "C"
 #endif
-char rdma_create_id ();
+char GNI_CdmCreate ();
 int
 main ()
 {
-return rdma_create_id ();
+return GNI_CdmCreate ();
   ;
   return 0;
 }
 _ACEOF
 if ac_fn_c_try_link "$LINENO"; then :
-  ac_cv_lib_rdmacm_rdma_create_id=yes
+  ac_cv_lib_ugni_GNI_CdmCreate=yes
 else
-  ac_cv_lib_rdmacm_rdma_create_id=no
+  ac_cv_lib_ugni_GNI_CdmCreate=no
 fi
 rm -f core conftest.err conftest.$ac_objext \
     conftest$ac_exeext conftest.$ac_ext
 LIBS=$ac_check_lib_save_LIBS
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_rdmacm_rdma_create_id" >&5
-$as_echo "$ac_cv_lib_rdmacm_rdma_create_id" >&6; }
-if test "x$ac_cv_lib_rdmacm_rdma_create_id" = xyes; then :
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_ugni_GNI_CdmCreate" >&5
+$as_echo "$ac_cv_lib_ugni_GNI_CdmCreate" >&6; }
+if test "x$ac_cv_lib_ugni_GNI_CdmCreate" = xyes; then :
   cci_check_package_lib_happy="yes"
 else
   cci_check_package_lib_happy="no"
@@ -10322,16 +10322,16 @@
 
                      if test "$cci_check_package_lib_happy" = "no"; then :
    # no go on the as is..  see what happens later...
-                          LDFLAGS="$cci_check_package_ctp_verbs_save_LDFLAGS"
-                          ctp_verbs_LDFLAGS="$cci_check_package_ctp_verbs_orig_LDFLAGS"
-                          unset ac_cv_lib_rdmacm_rdma_create_id
+                          LDFLAGS="$cci_check_package_ctp_gni_save_LDFLAGS"
+                          ctp_gni_LDFLAGS="$cci_check_package_ctp_gni_orig_LDFLAGS"
+                          unset ac_cv_lib_ugni_GNI_CdmCreate
 fi
 fi
 fi
 fi
 
     if test "$cci_check_package_lib_happy" = "yes"; then :
-  ctp_verbs_LIBS="-lrdmacm -libverbs"
+  ctp_gni_LIBS="-lugni "
            cci_check_package_happy="yes"
 else
   cci_check_package_happy="no"
@@ -10342,33 +10342,33 @@
     unset cci_check_package_header_happy
 
     if test "$cci_check_package_happy" = "yes"; then :
-  ctp_verbs_happy="yes"
+  ctp_gni_happy="yes"
 else
-  ctp_verbs_CPPFLAGS="$cci_check_package_ctp_verbs_orig_CPPFLAGS"
-           ctp_verbs_LDFLAGS="$cci_check_package_ctp_verbs_orig_LDFLAGS"
-           ctp_verbs_LIBS="$cci_check_package_ctp_verbs_orig_LIBS"
-           ctp_verbs_happy="no"
+  ctp_gni_CPPFLAGS="$cci_check_package_ctp_gni_orig_CPPFLAGS"
+           ctp_gni_LDFLAGS="$cci_check_package_ctp_gni_orig_LDFLAGS"
+           ctp_gni_LIBS="$cci_check_package_ctp_gni_orig_LIBS"
+           ctp_gni_happy="no"
 fi
 
-    CPPFLAGS="$cci_check_package_ctp_verbs_save_CPPFLAGS"
-    LDFLAGS="$cci_check_package_ctp_verbs_save_LDFLAGS"
-    LIBS="$cci_check_package_ctp_verbs_save_LIBS"
+    CPPFLAGS="$cci_check_package_ctp_gni_save_CPPFLAGS"
+    LDFLAGS="$cci_check_package_ctp_gni_save_LDFLAGS"
+    LIBS="$cci_check_package_ctp_gni_save_LIBS"
 
 fi
 
-    if test "$ctp_verbs_happy" = "yes"; then :
-  ctp_verbs_WRAPPER_EXTRA_LDFLAGS="$ctp_verbs_LDFLAGS"
-           ctp_verbs_WRAPPER_EXTRA_LIBS="$ctp_verbs_LIBS"
+    if test "$ctp_gni_happy" = "yes"; then :
+  ctp_gni_WRAPPER_EXTRA_LDFLAGS="$ctp_gni_LDFLAGS"
+           ctp_gni_WRAPPER_EXTRA_LIBS="$ctp_gni_LIBS"
            should_build=1
 else
   should_build=0
 fi
 
     # sanity check
-    if test "$ctp_verbs_happy" = "no"; then :
-  if test "$with_verbs" != "no" -a ! -z "$with_verbs"; then :
-  { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: ctp:verbs requested but not found" >&5
-$as_echo "$as_me: WARNING: ctp:verbs requested but not found" >&2;}
+    if test "$ctp_gni_happy" = "no"; then :
+  if test "$with_gni" != "no" -a ! -z "$with_gni"; then :
+  { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: ctp:gni requested but not found" >&5
+$as_echo "$as_me: WARNING: ctp:gni requested but not found" >&2;}
                   as_fn_error $? "Cannot continue" "$LINENO" 5
 fi
 fi
@@ -10379,14 +10379,33 @@
 
 
 
-    ac_fn_c_check_type "$LINENO" "struct rdma_addrinfo" "ac_cv_type_struct_rdma_addrinfo" "#include <rdma/rdma_cma.h>
-"
-if test "x$ac_cv_type_struct_rdma_addrinfo" = xyes; then :
-  $as_echo "#define HAVE_RDMA_ADDRINFO 1" >>confdefs.h
+
+# Check whether --with-gni-ptag was given.
+if test "${with_gni_ptag+set}" = set; then :
+  withval=$with_gni_ptag;
+cat >>confdefs.h <<_ACEOF
+#define GNI_PTAG $withval
+_ACEOF
 
 else
+  cat >>confdefs.h <<_ACEOF
+#define GNI_PTAG 208
+_ACEOF
 
-$as_echo "#define HAVE_RDMA_ADDRINFO 0" >>confdefs.h
+fi
+
+
+# Check whether --with-gni-cookie was given.
+if test "${with_gni_cookie+set}" = set; then :
+  withval=$with_gni_cookie;
+cat >>confdefs.h <<_ACEOF
+#define GNI_COOKIE $withval
+_ACEOF
+
+else
+  cat >>confdefs.h <<_ACEOF
+#define GNI_COOKIE 0x73e70000
+_ACEOF
 
 fi
 
@@ -10408,7 +10427,7 @@
 
     project=cci
     framework=ctp
-    plugin=verbs
+    plugin=gni
 
     # See if it dropped an output file for us to pick up some
     # shell variables in.
@@ -10450,16 +10469,16 @@
 
 
 
-    { $as_echo "$as_me:${as_lineno-$LINENO}: checking if cci plugin ctp:verbs can compile" >&5
-$as_echo_n "checking if cci plugin ctp:verbs can compile... " >&6; }
+    { $as_echo "$as_me:${as_lineno-$LINENO}: checking if cci plugin ctp:gni can compile" >&5
+$as_echo_n "checking if cci plugin ctp:gni can compile... " >&6; }
     { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
 $as_echo "no" >&6; }
 
     # If this plugin was requested as the default for this
     # framework, then abort.
-    if test "$with_mpdc_fw" = "verbs" ; then
-        { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: cci plugin \"verbs\" failed to configure properly" >&5
-$as_echo "$as_me: WARNING: cci plugin \"verbs\" failed to configure properly" >&2;}
+    if test "$with_mpdc_fw" = "gni" ; then
+        { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: cci plugin \"gni\" failed to configure properly" >&5
+$as_echo "$as_me: WARNING: cci plugin \"gni\" failed to configure properly" >&2;}
         { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: This plugin was selected as the default" >&5
 $as_echo "$as_me: WARNING: This plugin was selected as the default" >&2;}
         as_fn_error $? "Cannot continue" "$LINENO" 5
@@ -10467,23 +10486,23 @@
     fi
 
            # add plugin to all plugin list
-           all_plugins="$all_plugins verbs"
+           all_plugins="$all_plugins gni"
 fi
 
 
 
     # set the AM_CONDITIONAL on how we should build
     if test "$compile_mode" = "dso"; then :
-  BUILD_cci_ctp_verbs_DSO=1
+  BUILD_cci_ctp_gni_DSO=1
 else
-  BUILD_cci_ctp_verbs_DSO=0
+  BUILD_cci_ctp_gni_DSO=0
 fi
-     if test "$BUILD_cci_ctp_verbs_DSO" = "1"; then
-  CCI_BUILD_cci_ctp_verbs_DSO_TRUE=
-  CCI_BUILD_cci_ctp_verbs_DSO_FALSE='#'
+     if test "$BUILD_cci_ctp_gni_DSO" = "1"; then
+  CCI_BUILD_cci_ctp_gni_DSO_TRUE=
+  CCI_BUILD_cci_ctp_gni_DSO_FALSE='#'
 else
-  CCI_BUILD_cci_ctp_verbs_DSO_TRUE='#'
-  CCI_BUILD_cci_ctp_verbs_DSO_FALSE=
+  CCI_BUILD_cci_ctp_gni_DSO_TRUE='#'
+  CCI_BUILD_cci_ctp_gni_DSO_FALSE=
 fi
 
 
@@ -10508,198 +10527,7 @@
 
 
 
-    cci_show_subsubsubtitle "cci plugin ctp:eth (m4 configuration macro)"
-
-
-
-
-
-
-
-
-
-
-    project_root=src
-    framework=ctp
-    plugin=eth
-    plugin_path="$srcdir/$project_root/plugins/$framework/$plugin"
-    want_plugin=1
-
-    # if we were explicitly disabled, don't build :)
-    str="DISABLED_PLUGIN_CHECK=\$DISABLE_${framework}"
-    eval $str
-    if test "$DISABLED_PLUGIN_CHECK" = "1" ; then
-        want_plugin=0
-    fi
-    str="DISABLED_PLUGIN_CHECK=\$DISABLE_${framework}_$plugin"
-    eval $str
-    if test "$DISABLED_PLUGIN_CHECK" = "1" ; then
-        want_plugin=0
-    fi
-
-    if test "$want_plugin" = "1"; then :
-  should_build=$plugins_looking_for_succeed
-else
-  should_build=0
-fi
-
-    # Allow the plugin to override the build mode if it really wants to.
-    # It is, of course, free to end up calling PLUGINS_PLUGIN_COMPILE_MODE
-
-
-
-
-
-
-    project=cci
-    framework=ctp
-    plugin=eth
-
-    # Is this plugin going to built staic or shared?  $plugin
-    # might not be known until configure time, so have to use eval
-    # tricks - can't set variable names at autogen time.
-    str="SHARED_FRAMEWORK=\$DSO_$framework"
-    eval $str
-    str="SHARED_PLUGIN=\$DSO_${framework}_$plugin"
-    eval $str
-
-    # Static is not supported right now; so the only option is DSO
-    compile_mode=dso
-
-    { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $project plugin $framework:$plugin compile mode" >&5
-$as_echo_n "checking for $project plugin $framework:$plugin compile mode... " >&6; }
-    { $as_echo "$as_me:${as_lineno-$LINENO}: result: $compile_mode" >&5
-$as_echo "$compile_mode" >&6; }
-
-
-    # try to configure the plugin.  pay no attention to
-    # --enable-dist, since we'll always have makefiles.
-    if test "$should_build" = "1"; then :
-
-
-    case ${target} in
-	*-*-linux*) should_build=1;;
-	*) should_build=0;;
-    esac
-
-
-fi
-
-    if test "$should_build" = "1"; then :
-
-
-
-
-
-
-
-
-
-
-
-    project=cci
-    framework=ctp
-    plugin=eth
-
-    # See if it dropped an output file for us to pick up some
-    # shell variables in.
-    infile="$srcdir/src/plugins/$framework/$plugin/post_configure.sh"
-
-    # Add this subdir to the mast list of all plugin subdirs
-    all_plugins="$all_plugins $plugin"
-
-    if test "$compile_mode" = "dso" ; then
-        dso_plugins="$dso_plugins $plugin"
-    else
-        { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: Unknown plugin build mode" >&5
-$as_echo "$as_me: WARNING: Unknown plugin build mode" >&2;}
-        as_fn_error $? "Cannot continue" "$LINENO" 5
-    fi
-
-    # Output pretty results
-    { $as_echo "$as_me:${as_lineno-$LINENO}: checking if $project plugin $framework:$plugin can compile" >&5
-$as_echo_n "checking if $project plugin $framework:$plugin can compile... " >&6; }
-    { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
-$as_echo "yes" >&6; }
-
-    # If there's an output file, add the values to
-    # scope_EXTRA_flags.
-    if test -f $infile; then
-
-        # First check for the ABORT tag
-        line="`$GREP ABORT= $infile | cut -d= -f2-`"
-        if test -n "$line" -a "$line" != "no"; then
-            { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: cci plugin configure script told me to abort" >&5
-$as_echo "$as_me: WARNING: cci plugin configure script told me to abort" >&2;}
-            as_fn_error $? "cannot continue" "$LINENO" 5
-        fi
-    fi
-
-else
-
-
-
-
-
-    { $as_echo "$as_me:${as_lineno-$LINENO}: checking if cci plugin ctp:eth can compile" >&5
-$as_echo_n "checking if cci plugin ctp:eth can compile... " >&6; }
-    { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-
-    # If this plugin was requested as the default for this
-    # framework, then abort.
-    if test "$with_mpdc_fw" = "eth" ; then
-        { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: cci plugin \"eth\" failed to configure properly" >&5
-$as_echo "$as_me: WARNING: cci plugin \"eth\" failed to configure properly" >&2;}
-        { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: This plugin was selected as the default" >&5
-$as_echo "$as_me: WARNING: This plugin was selected as the default" >&2;}
-        as_fn_error $? "Cannot continue" "$LINENO" 5
-        exit 1
-    fi
-
-           # add plugin to all plugin list
-           all_plugins="$all_plugins eth"
-fi
-
-
-
-    # set the AM_CONDITIONAL on how we should build
-    if test "$compile_mode" = "dso"; then :
-  BUILD_cci_ctp_eth_DSO=1
-else
-  BUILD_cci_ctp_eth_DSO=0
-fi
-     if test "$BUILD_cci_ctp_eth_DSO" = "1"; then
-  CCI_BUILD_cci_ctp_eth_DSO_TRUE=
-  CCI_BUILD_cci_ctp_eth_DSO_FALSE='#'
-else
-  CCI_BUILD_cci_ctp_eth_DSO_TRUE='#'
-  CCI_BUILD_cci_ctp_eth_DSO_FALSE=
-fi
-
-
-    if test "$should_build" = "1"; then :
-  plugins_last_result=1
-else
-  plugins_last_result=0
-fi
-
-    unset compile_mode
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-    cci_show_subsubsubtitle "cci plugin ctp:gni (m4 configuration macro)"
+    cci_show_subsubsubtitle "cci plugin ctp:sm (m4 configuration macro)"
 
 
 
@@ -10712,7 +10540,7 @@
 
     project_root=src
     framework=ctp
-    plugin=gni
+    plugin=sm
     plugin_path="$srcdir/$project_root/plugins/$framework/$plugin"
     want_plugin=1
 
@@ -10744,7 +10572,7 @@
 
     project=cci
     framework=ctp
-    plugin=gni
+    plugin=sm
 
     # Is this plugin going to built staic or shared?  $plugin
     # might not be known until configure time, so have to use eval
@@ -10769,39 +10597,39 @@
 
 
     # Sadly, m4 does not allow comments in between each parameter, so
-    # they can't be documented inline. See a lengthy comment at
+    # they can'tbe documented inline.  :-( See a lengthy comment at
     # the top of config/cci_setup_plugin_package.m4 for a description
     # of what this macro does and what each of the parameters are.
 
 
-# Check whether --with-gni was given.
-if test "${with_gni+set}" = set; then :
-  withval=$with_gni;
+# Check whether --with-sm was given.
+if test "${with_sm+set}" = set; then :
+  withval=$with_sm;
 fi
 
 
-    { $as_echo "$as_me:${as_lineno-$LINENO}: checking --with-gni value" >&5
-$as_echo_n "checking --with-gni value... " >&6; }
-    if test "$with_gni" = "yes" -o "$with_gni" = "no" -o "x$with_gni" = "x"; then :
+    { $as_echo "$as_me:${as_lineno-$LINENO}: checking --with-sm value" >&5
+$as_echo_n "checking --with-sm value... " >&6; }
+    if test "$with_sm" = "yes" -o "$with_sm" = "no" -o "x$with_sm" = "x"; then :
   { $as_echo "$as_me:${as_lineno-$LINENO}: result: simple ok (unspecified)" >&5
 $as_echo "simple ok (unspecified)" >&6; }
 else
-  if test ! -d "$with_gni"; then :
+  if test ! -d "$with_sm"; then :
   { $as_echo "$as_me:${as_lineno-$LINENO}: result: not found" >&5
 $as_echo "not found" >&6; }
-                  { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: Directory $with_gni not found" >&5
-$as_echo "$as_me: WARNING: Directory $with_gni not found" >&2;}
+                  { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: Directory $with_sm not found" >&5
+$as_echo "$as_me: WARNING: Directory $with_sm not found" >&2;}
                   as_fn_error $? "Cannot continue" "$LINENO" 5
 else
-  if test "x`ls $with_gni/include/gni_pub.h 2> /dev/null`" = "x"; then :
+  if test "x`ls $with_sm/include/sys/mman.h 2> /dev/null`" = "x"; then :
   { $as_echo "$as_me:${as_lineno-$LINENO}: result: not found" >&5
 $as_echo "not found" >&6; }
-                         { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: Expected file $with_gni/include/gni_pub.h not found" >&5
-$as_echo "$as_me: WARNING: Expected file $with_gni/include/gni_pub.h not found" >&2;}
+                         { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: Expected file $with_sm/include/sys/mman.h not found" >&5
+$as_echo "$as_me: WARNING: Expected file $with_sm/include/sys/mman.h not found" >&2;}
                          as_fn_error $? "Cannot continue" "$LINENO" 5
 else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: sanity check ok ($with_gni)" >&5
-$as_echo "sanity check ok ($with_gni)" >&6; }
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: sanity check ok ($with_sm)" >&5
+$as_echo "sanity check ok ($with_sm)" >&6; }
 
 fi
 
@@ -10812,34 +10640,34 @@
 fi
 
 
-# Check whether --with-gni-libdir was given.
-if test "${with_gni_libdir+set}" = set; then :
-  withval=$with_gni_libdir;
+# Check whether --with-sm-libdir was given.
+if test "${with_sm_libdir+set}" = set; then :
+  withval=$with_sm_libdir;
 fi
 
 
-    { $as_echo "$as_me:${as_lineno-$LINENO}: checking --with-gni-libdir value" >&5
-$as_echo_n "checking --with-gni-libdir value... " >&6; }
-    if test "$with_gni_libdir" = "yes" -o "$with_gni_libdir" = "no" -o "x$with_gni_libdir" = "x"; then :
+    { $as_echo "$as_me:${as_lineno-$LINENO}: checking --with-sm-libdir value" >&5
+$as_echo_n "checking --with-sm-libdir value... " >&6; }
+    if test "$with_sm_libdir" = "yes" -o "$with_sm_libdir" = "no" -o "x$with_sm_libdir" = "x"; then :
   { $as_echo "$as_me:${as_lineno-$LINENO}: result: simple ok (unspecified)" >&5
 $as_echo "simple ok (unspecified)" >&6; }
 else
-  if test ! -d "$with_gni_libdir"; then :
+  if test ! -d "$with_sm_libdir"; then :
   { $as_echo "$as_me:${as_lineno-$LINENO}: result: not found" >&5
 $as_echo "not found" >&6; }
-                  { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: Directory $with_gni_libdir not found" >&5
-$as_echo "$as_me: WARNING: Directory $with_gni_libdir not found" >&2;}
+                  { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: Directory $with_sm_libdir not found" >&5
+$as_echo "$as_me: WARNING: Directory $with_sm_libdir not found" >&2;}
                   as_fn_error $? "Cannot continue" "$LINENO" 5
 else
-  if test "x`ls $with_gni_libdir/libugni* 2> /dev/null`" = "x"; then :
+  if test "x`ls $with_sm_libdir/libc* 2> /dev/null`" = "x"; then :
   { $as_echo "$as_me:${as_lineno-$LINENO}: result: not found" >&5
 $as_echo "not found" >&6; }
-                         { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: Expected file $with_gni_libdir/libugni* not found" >&5
-$as_echo "$as_me: WARNING: Expected file $with_gni_libdir/libugni* not found" >&2;}
+                         { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: Expected file $with_sm_libdir/libc* not found" >&5
+$as_echo "$as_me: WARNING: Expected file $with_sm_libdir/libc* not found" >&2;}
                          as_fn_error $? "Cannot continue" "$LINENO" 5
 else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: sanity check ok ($with_gni_libdir)" >&5
-$as_echo "sanity check ok ($with_gni_libdir)" >&6; }
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: sanity check ok ($with_sm_libdir)" >&5
+$as_echo "sanity check ok ($with_sm_libdir)" >&6; }
 
 fi
 
@@ -10850,28 +10678,28 @@
 fi
 
 
-    if test ! -z "$with_gni" -a "$with_gni" != "yes"; then :
-  ctp_gni_dir="$with_gni"
+    if test ! -z "$with_sm" -a "$with_sm" != "yes"; then :
+  ctp_sm_dir="$with_sm"
 fi
-    if test ! -z "$with_gni_libdir" -a "$with_gni_libdir" != "yes"; then :
-  ctp_gni_libdir="$with_gni_libdir"
+    if test ! -z "$with_sm_libdir" -a "$with_sm_libdir" != "yes"; then :
+  ctp_sm_libdir="$with_sm_libdir"
 fi
 
-    if test "$with_gni" = "no"; then :
-  ctp_gni_happy="no"
+    if test "$with_sm" = "no"; then :
+  ctp_sm_happy="no"
 else
-  ctp_gni_happy="yes"
+  ctp_sm_happy="yes"
 fi
 
-    if test "$ctp_gni_happy" = "yes"; then :
+    if test "$ctp_sm_happy" = "yes"; then :
 
-    cci_check_package_ctp_gni_save_CPPFLAGS="$CPPFLAGS"
-    cci_check_package_ctp_gni_save_LDFLAGS="$LDFLAGS"
-    cci_check_package_ctp_gni_save_LIBS="$LIBS"
+    cci_check_package_ctp_sm_save_CPPFLAGS="$CPPFLAGS"
+    cci_check_package_ctp_sm_save_LDFLAGS="$LDFLAGS"
+    cci_check_package_ctp_sm_save_LIBS="$LIBS"
 
-    cci_check_package_ctp_gni_orig_CPPFLAGS="$ctp_gni_CPPFLAGS"
-    cci_check_package_ctp_gni_orig_LDFLAGS="$ctp_gni_LDFLAGS"
-    cci_check_package_ctp_gni_orig_LIBS="$ctp_gni_LIBS"
+    cci_check_package_ctp_sm_orig_CPPFLAGS="$ctp_sm_CPPFLAGS"
+    cci_check_package_ctp_sm_orig_LDFLAGS="$ctp_sm_LDFLAGS"
+    cci_check_package_ctp_sm_orig_LIBS="$ctp_sm_LIBS"
 
 
     # This is stolen from autoconf to peek under the covers to get the
@@ -10882,15 +10710,15 @@
     # so this sucks, but there's no way to get through the progression
     # of header includes without killing off the cache variable and trying
     # again...
-    unset ac_cv_header_gni_pub_h
+    unset ac_cv_header_sys_mman_h
 
     cci_check_package_header_happy="no"
-    if test "$ctp_gni_dir" = "/usr" -o "$ctp_gni_dir" = "/usr/local"; then :
+    if test "$ctp_sm_dir" = "/usr" -o "$ctp_sm_dir" = "/usr/local"; then :
    # try as is...
             { $as_echo "$as_me:${as_lineno-$LINENO}: result: looking for header without includes" >&5
 $as_echo "looking for header without includes" >&6; }
-            ac_fn_c_check_header_mongrel "$LINENO" "gni_pub.h" "ac_cv_header_gni_pub_h" "$ac_includes_default"
-if test "x$ac_cv_header_gni_pub_h" = xyes; then :
+            ac_fn_c_check_header_mongrel "$LINENO" "sys/mman.h" "ac_cv_header_sys_mman_h" "$ac_includes_default"
+if test "x$ac_cv_header_sys_mman_h" = xyes; then :
   cci_check_package_header_happy="yes"
 else
   cci_check_package_header_happy="no"
@@ -10899,36 +10727,36 @@
 
             if test "$cci_check_package_header_happy" = "no"; then :
   # no go on the as is - reset the cache and try again
-                   unset ac_cv_header_gni_pub_h
+                   unset ac_cv_header_sys_mman_h
 fi
 fi
 
     if test "$cci_check_package_header_happy" = "no"; then :
-  if test "$ctp_gni_dir" != ""; then :
-  ctp_gni_CPPFLAGS="$ctp_gni_CPPFLAGS -I$ctp_gni_dir/include"
-                  CPPFLAGS="$CPPFLAGS -I$ctp_gni_dir/include"
+  if test "$ctp_sm_dir" != ""; then :
+  ctp_sm_CPPFLAGS="$ctp_sm_CPPFLAGS -I$ctp_sm_dir/include"
+                  CPPFLAGS="$CPPFLAGS -I$ctp_sm_dir/include"
 fi
-           ac_fn_c_check_header_mongrel "$LINENO" "gni_pub.h" "ac_cv_header_gni_pub_h" "$ac_includes_default"
-if test "x$ac_cv_header_gni_pub_h" = xyes; then :
+           ac_fn_c_check_header_mongrel "$LINENO" "sys/mman.h" "ac_cv_header_sys_mman_h" "$ac_includes_default"
+if test "x$ac_cv_header_sys_mman_h" = xyes; then :
 
     # This is stolen from autoconf to peek under the covers to get the
     # cache variable for the library check.  one should not copy this
     # code into other places unless you want much pain and suffering
 
     # see comment above
-    unset ac_cv_lib_ugni_GNI_CdmCreate
+    unset ac_cv_lib_c_fts_open
     cci_check_package_lib_happy="no"
-    if test "$ctp_gni_libdir" != ""; then :
+    if test "$ctp_sm_libdir" != ""; then :
    # libdir was specified - search only there
-           ctp_gni_LDFLAGS="$ctp_gni_LDFLAGS -L$ctp_gni_libdir"
-           LDFLAGS="$LDFLAGS -L$ctp_gni_libdir"
-           { $as_echo "$as_me:${as_lineno-$LINENO}: checking for GNI_CdmCreate in -lugni" >&5
-$as_echo_n "checking for GNI_CdmCreate in -lugni... " >&6; }
-if ${ac_cv_lib_ugni_GNI_CdmCreate+:} false; then :
+           ctp_sm_LDFLAGS="$ctp_sm_LDFLAGS -L$ctp_sm_libdir"
+           LDFLAGS="$LDFLAGS -L$ctp_sm_libdir"
+           { $as_echo "$as_me:${as_lineno-$LINENO}: checking for fts_open in -lc" >&5
+$as_echo_n "checking for fts_open in -lc... " >&6; }
+if ${ac_cv_lib_c_fts_open+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   ac_check_lib_save_LIBS=$LIBS
-LIBS="-lugni  $LIBS"
+LIBS="-lc  $LIBS"
 cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
 
@@ -10938,51 +10766,51 @@
 #ifdef __cplusplus
 extern "C"
 #endif
-char GNI_CdmCreate ();
+char fts_open ();
 int
 main ()
 {
-return GNI_CdmCreate ();
+return fts_open ();
   ;
   return 0;
 }
 _ACEOF
 if ac_fn_c_try_link "$LINENO"; then :
-  ac_cv_lib_ugni_GNI_CdmCreate=yes
+  ac_cv_lib_c_fts_open=yes
 else
-  ac_cv_lib_ugni_GNI_CdmCreate=no
+  ac_cv_lib_c_fts_open=no
 fi
 rm -f core conftest.err conftest.$ac_objext \
     conftest$ac_exeext conftest.$ac_ext
 LIBS=$ac_check_lib_save_LIBS
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_ugni_GNI_CdmCreate" >&5
-$as_echo "$ac_cv_lib_ugni_GNI_CdmCreate" >&6; }
-if test "x$ac_cv_lib_ugni_GNI_CdmCreate" = xyes; then :
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_c_fts_open" >&5
+$as_echo "$ac_cv_lib_c_fts_open" >&6; }
+if test "x$ac_cv_lib_c_fts_open" = xyes; then :
   cci_check_package_lib_happy="yes"
 else
   cci_check_package_lib_happy="no"
 fi
 
            if test "$cci_check_package_lib_happy" = "no"; then :
-  LDFLAGS="$cci_check_package_ctp_gni_save_LDFLAGS"
-                  ctp_gni_LDFLAGS="$cci_check_package_ctp_gni_orig_LDFLAGS"
-                  unset ac_cv_lib_ugni_GNI_CdmCreate
+  LDFLAGS="$cci_check_package_ctp_sm_save_LDFLAGS"
+                  ctp_sm_LDFLAGS="$cci_check_package_ctp_sm_orig_LDFLAGS"
+                  unset ac_cv_lib_c_fts_open
 fi
 else
    # libdir was not specified - go through search path
-           cci_check_package_libdir="$ctp_gni_dir"
+           cci_check_package_libdir="$ctp_sm_dir"
            if test "$cci_check_package_libdir" = "" -o "$cci_check_package_libdir" = "/usr" -o "$cci_check_package_libdir" = "/usr/local"; then :
    # try as is...
                 { $as_echo "$as_me:${as_lineno-$LINENO}: result: looking for library without search path" >&5
 $as_echo "looking for library without search path" >&6; }
-                { $as_echo "$as_me:${as_lineno-$LINENO}: checking for GNI_CdmCreate in -lugni" >&5
-$as_echo_n "checking for GNI_CdmCreate in -lugni... " >&6; }
-if ${ac_cv_lib_ugni_GNI_CdmCreate+:} false; then :
+                { $as_echo "$as_me:${as_lineno-$LINENO}: checking for fts_open in -lc" >&5
+$as_echo_n "checking for fts_open in -lc... " >&6; }
+if ${ac_cv_lib_c_fts_open+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   ac_check_lib_save_LIBS=$LIBS
-LIBS="-lugni  $LIBS"
+LIBS="-lc  $LIBS"
 cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
 
@@ -10992,27 +10820,27 @@
 #ifdef __cplusplus
 extern "C"
 #endif
-char GNI_CdmCreate ();
+char fts_open ();
 int
 main ()
 {
-return GNI_CdmCreate ();
+return fts_open ();
   ;
   return 0;
 }
 _ACEOF
 if ac_fn_c_try_link "$LINENO"; then :
-  ac_cv_lib_ugni_GNI_CdmCreate=yes
+  ac_cv_lib_c_fts_open=yes
 else
-  ac_cv_lib_ugni_GNI_CdmCreate=no
+  ac_cv_lib_c_fts_open=no
 fi
 rm -f core conftest.err conftest.$ac_objext \
     conftest$ac_exeext conftest.$ac_ext
 LIBS=$ac_check_lib_save_LIBS
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_ugni_GNI_CdmCreate" >&5
-$as_echo "$ac_cv_lib_ugni_GNI_CdmCreate" >&6; }
-if test "x$ac_cv_lib_ugni_GNI_CdmCreate" = xyes; then :
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_c_fts_open" >&5
+$as_echo "$ac_cv_lib_c_fts_open" >&6; }
+if test "x$ac_cv_lib_c_fts_open" = xyes; then :
   cci_check_package_lib_happy="yes"
 else
   cci_check_package_lib_happy="no"
@@ -11020,25 +10848,25 @@
 
                 if test "$cci_check_package_lib_happy" = "no"; then :
    # no go on the as is..  see what happens later...
-                     LDFLAGS="$cci_check_package_ctp_gni_save_LDFLAGS"
-                     ctp_gni_LDFLAGS="$cci_check_package_ctp_gni_orig_LDFLAGS"
-                     unset ac_cv_lib_ugni_GNI_CdmCreate
+                     LDFLAGS="$cci_check_package_ctp_sm_save_LDFLAGS"
+                     ctp_sm_LDFLAGS="$cci_check_package_ctp_sm_orig_LDFLAGS"
+                     unset ac_cv_lib_c_fts_open
 fi
 fi
 
            if test "$cci_check_package_lib_happy" = "no"; then :
   if test "$cci_check_package_libdir" != ""; then :
-  ctp_gni_LDFLAGS="$ctp_gni_LDFLAGS -L$cci_check_package_libdir/lib"
+  ctp_sm_LDFLAGS="$ctp_sm_LDFLAGS -L$cci_check_package_libdir/lib"
                      LDFLAGS="$LDFLAGS -L$cci_check_package_libdir/lib"
                      { $as_echo "$as_me:${as_lineno-$LINENO}: result: looking for library in lib" >&5
 $as_echo "looking for library in lib" >&6; }
-                     { $as_echo "$as_me:${as_lineno-$LINENO}: checking for GNI_CdmCreate in -lugni" >&5
-$as_echo_n "checking for GNI_CdmCreate in -lugni... " >&6; }
-if ${ac_cv_lib_ugni_GNI_CdmCreate+:} false; then :
+                     { $as_echo "$as_me:${as_lineno-$LINENO}: checking for fts_open in -lc" >&5
+$as_echo_n "checking for fts_open in -lc... " >&6; }
+if ${ac_cv_lib_c_fts_open+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   ac_check_lib_save_LIBS=$LIBS
-LIBS="-lugni  $LIBS"
+LIBS="-lc  $LIBS"
 cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
 
@@ -11048,27 +10876,27 @@
 #ifdef __cplusplus
 extern "C"
 #endif
-char GNI_CdmCreate ();
+char fts_open ();
 int
 main ()
 {
-return GNI_CdmCreate ();
+return fts_open ();
   ;
   return 0;
 }
 _ACEOF
 if ac_fn_c_try_link "$LINENO"; then :
-  ac_cv_lib_ugni_GNI_CdmCreate=yes
+  ac_cv_lib_c_fts_open=yes
 else
-  ac_cv_lib_ugni_GNI_CdmCreate=no
+  ac_cv_lib_c_fts_open=no
 fi
 rm -f core conftest.err conftest.$ac_objext \
     conftest$ac_exeext conftest.$ac_ext
 LIBS=$ac_check_lib_save_LIBS
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_ugni_GNI_CdmCreate" >&5
-$as_echo "$ac_cv_lib_ugni_GNI_CdmCreate" >&6; }
-if test "x$ac_cv_lib_ugni_GNI_CdmCreate" = xyes; then :
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_c_fts_open" >&5
+$as_echo "$ac_cv_lib_c_fts_open" >&6; }
+if test "x$ac_cv_lib_c_fts_open" = xyes; then :
   cci_check_package_lib_happy="yes"
 else
   cci_check_package_lib_happy="no"
@@ -11076,26 +10904,26 @@
 
                      if test "$cci_check_package_lib_happy" = "no"; then :
    # no go on the as is..  see what happens later...
-                          LDFLAGS="$cci_check_package_ctp_gni_save_LDFLAGS"
-                          ctp_gni_LDFLAGS="$cci_check_package_ctp_gni_orig_LDFLAGS"
-                          unset ac_cv_lib_ugni_GNI_CdmCreate
+                          LDFLAGS="$cci_check_package_ctp_sm_save_LDFLAGS"
+                          ctp_sm_LDFLAGS="$cci_check_package_ctp_sm_orig_LDFLAGS"
+                          unset ac_cv_lib_c_fts_open
 fi
 fi
 fi
 
            if test "$cci_check_package_lib_happy" = "no"; then :
   if test "$cci_check_package_libdir" != ""; then :
-  ctp_gni_LDFLAGS="$ctp_gni_LDFLAGS -L$cci_check_package_libdir/lib64"
+  ctp_sm_LDFLAGS="$ctp_sm_LDFLAGS -L$cci_check_package_libdir/lib64"
                      LDFLAGS="$LDFLAGS -L$cci_check_package_libdir/lib64"
                      { $as_echo "$as_me:${as_lineno-$LINENO}: result: looking for library in lib64" >&5
 $as_echo "looking for library in lib64" >&6; }
-                     { $as_echo "$as_me:${as_lineno-$LINENO}: checking for GNI_CdmCreate in -lugni" >&5
-$as_echo_n "checking for GNI_CdmCreate in -lugni... " >&6; }
-if ${ac_cv_lib_ugni_GNI_CdmCreate+:} false; then :
+                     { $as_echo "$as_me:${as_lineno-$LINENO}: checking for fts_open in -lc" >&5
+$as_echo_n "checking for fts_open in -lc... " >&6; }
+if ${ac_cv_lib_c_fts_open+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   ac_check_lib_save_LIBS=$LIBS
-LIBS="-lugni  $LIBS"
+LIBS="-lc  $LIBS"
 cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
 
@@ -11105,27 +10933,27 @@
 #ifdef __cplusplus
 extern "C"
 #endif
-char GNI_CdmCreate ();
+char fts_open ();
 int
 main ()
 {
-return GNI_CdmCreate ();
+return fts_open ();
   ;
   return 0;
 }
 _ACEOF
 if ac_fn_c_try_link "$LINENO"; then :
-  ac_cv_lib_ugni_GNI_CdmCreate=yes
+  ac_cv_lib_c_fts_open=yes
 else
-  ac_cv_lib_ugni_GNI_CdmCreate=no
+  ac_cv_lib_c_fts_open=no
 fi
 rm -f core conftest.err conftest.$ac_objext \
     conftest$ac_exeext conftest.$ac_ext
 LIBS=$ac_check_lib_save_LIBS
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_ugni_GNI_CdmCreate" >&5
-$as_echo "$ac_cv_lib_ugni_GNI_CdmCreate" >&6; }
-if test "x$ac_cv_lib_ugni_GNI_CdmCreate" = xyes; then :
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_c_fts_open" >&5
+$as_echo "$ac_cv_lib_c_fts_open" >&6; }
+if test "x$ac_cv_lib_c_fts_open" = xyes; then :
   cci_check_package_lib_happy="yes"
 else
   cci_check_package_lib_happy="no"
@@ -11133,16 +10961,16 @@
 
                      if test "$cci_check_package_lib_happy" = "no"; then :
    # no go on the as is..  see what happens later...
-                          LDFLAGS="$cci_check_package_ctp_gni_save_LDFLAGS"
-                          ctp_gni_LDFLAGS="$cci_check_package_ctp_gni_orig_LDFLAGS"
-                          unset ac_cv_lib_ugni_GNI_CdmCreate
+                          LDFLAGS="$cci_check_package_ctp_sm_save_LDFLAGS"
+                          ctp_sm_LDFLAGS="$cci_check_package_ctp_sm_orig_LDFLAGS"
+                          unset ac_cv_lib_c_fts_open
 fi
 fi
 fi
 fi
 
     if test "$cci_check_package_lib_happy" = "yes"; then :
-  ctp_gni_LIBS="-lugni "
+  ctp_sm_LIBS="-lc "
            cci_check_package_happy="yes"
 else
   cci_check_package_happy="no"
@@ -11161,19 +10989,19 @@
     # code into other places unless you want much pain and suffering
 
     # see comment above
-    unset ac_cv_lib_ugni_GNI_CdmCreate
+    unset ac_cv_lib_c_fts_open
     cci_check_package_lib_happy="no"
-    if test "$ctp_gni_libdir" != ""; then :
+    if test "$ctp_sm_libdir" != ""; then :
    # libdir was specified - search only there
-           ctp_gni_LDFLAGS="$ctp_gni_LDFLAGS -L$ctp_gni_libdir"
-           LDFLAGS="$LDFLAGS -L$ctp_gni_libdir"
-           { $as_echo "$as_me:${as_lineno-$LINENO}: checking for GNI_CdmCreate in -lugni" >&5
-$as_echo_n "checking for GNI_CdmCreate in -lugni... " >&6; }
-if ${ac_cv_lib_ugni_GNI_CdmCreate+:} false; then :
+           ctp_sm_LDFLAGS="$ctp_sm_LDFLAGS -L$ctp_sm_libdir"
+           LDFLAGS="$LDFLAGS -L$ctp_sm_libdir"
+           { $as_echo "$as_me:${as_lineno-$LINENO}: checking for fts_open in -lc" >&5
+$as_echo_n "checking for fts_open in -lc... " >&6; }
+if ${ac_cv_lib_c_fts_open+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   ac_check_lib_save_LIBS=$LIBS
-LIBS="-lugni  $LIBS"
+LIBS="-lc  $LIBS"
 cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
 
@@ -11183,51 +11011,51 @@
 #ifdef __cplusplus
 extern "C"
 #endif
-char GNI_CdmCreate ();
+char fts_open ();
 int
 main ()
 {
-return GNI_CdmCreate ();
+return fts_open ();
   ;
   return 0;
 }
 _ACEOF
 if ac_fn_c_try_link "$LINENO"; then :
-  ac_cv_lib_ugni_GNI_CdmCreate=yes
+  ac_cv_lib_c_fts_open=yes
 else
-  ac_cv_lib_ugni_GNI_CdmCreate=no
+  ac_cv_lib_c_fts_open=no
 fi
 rm -f core conftest.err conftest.$ac_objext \
     conftest$ac_exeext conftest.$ac_ext
 LIBS=$ac_check_lib_save_LIBS
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_ugni_GNI_CdmCreate" >&5
-$as_echo "$ac_cv_lib_ugni_GNI_CdmCreate" >&6; }
-if test "x$ac_cv_lib_ugni_GNI_CdmCreate" = xyes; then :
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_c_fts_open" >&5
+$as_echo "$ac_cv_lib_c_fts_open" >&6; }
+if test "x$ac_cv_lib_c_fts_open" = xyes; then :
   cci_check_package_lib_happy="yes"
 else
   cci_check_package_lib_happy="no"
 fi
 
            if test "$cci_check_package_lib_happy" = "no"; then :
-  LDFLAGS="$cci_check_package_ctp_gni_save_LDFLAGS"
-                  ctp_gni_LDFLAGS="$cci_check_package_ctp_gni_orig_LDFLAGS"
-                  unset ac_cv_lib_ugni_GNI_CdmCreate
+  LDFLAGS="$cci_check_package_ctp_sm_save_LDFLAGS"
+                  ctp_sm_LDFLAGS="$cci_check_package_ctp_sm_orig_LDFLAGS"
+                  unset ac_cv_lib_c_fts_open
 fi
 else
    # libdir was not specified - go through search path
-           cci_check_package_libdir="$ctp_gni_dir"
+           cci_check_package_libdir="$ctp_sm_dir"
            if test "$cci_check_package_libdir" = "" -o "$cci_check_package_libdir" = "/usr" -o "$cci_check_package_libdir" = "/usr/local"; then :
    # try as is...
                 { $as_echo "$as_me:${as_lineno-$LINENO}: result: looking for library without search path" >&5
 $as_echo "looking for library without search path" >&6; }
-                { $as_echo "$as_me:${as_lineno-$LINENO}: checking for GNI_CdmCreate in -lugni" >&5
-$as_echo_n "checking for GNI_CdmCreate in -lugni... " >&6; }
-if ${ac_cv_lib_ugni_GNI_CdmCreate+:} false; then :
+                { $as_echo "$as_me:${as_lineno-$LINENO}: checking for fts_open in -lc" >&5
+$as_echo_n "checking for fts_open in -lc... " >&6; }
+if ${ac_cv_lib_c_fts_open+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   ac_check_lib_save_LIBS=$LIBS
-LIBS="-lugni  $LIBS"
+LIBS="-lc  $LIBS"
 cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
 
@@ -11237,27 +11065,27 @@
 #ifdef __cplusplus
 extern "C"
 #endif
-char GNI_CdmCreate ();
+char fts_open ();
 int
 main ()
 {
-return GNI_CdmCreate ();
+return fts_open ();
   ;
   return 0;
 }
 _ACEOF
 if ac_fn_c_try_link "$LINENO"; then :
-  ac_cv_lib_ugni_GNI_CdmCreate=yes
+  ac_cv_lib_c_fts_open=yes
 else
-  ac_cv_lib_ugni_GNI_CdmCreate=no
+  ac_cv_lib_c_fts_open=no
 fi
 rm -f core conftest.err conftest.$ac_objext \
     conftest$ac_exeext conftest.$ac_ext
 LIBS=$ac_check_lib_save_LIBS
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_ugni_GNI_CdmCreate" >&5
-$as_echo "$ac_cv_lib_ugni_GNI_CdmCreate" >&6; }
-if test "x$ac_cv_lib_ugni_GNI_CdmCreate" = xyes; then :
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_c_fts_open" >&5
+$as_echo "$ac_cv_lib_c_fts_open" >&6; }
+if test "x$ac_cv_lib_c_fts_open" = xyes; then :
   cci_check_package_lib_happy="yes"
 else
   cci_check_package_lib_happy="no"
@@ -11265,25 +11093,25 @@
 
                 if test "$cci_check_package_lib_happy" = "no"; then :
    # no go on the as is..  see what happens later...
-                     LDFLAGS="$cci_check_package_ctp_gni_save_LDFLAGS"
-                     ctp_gni_LDFLAGS="$cci_check_package_ctp_gni_orig_LDFLAGS"
-                     unset ac_cv_lib_ugni_GNI_CdmCreate
+                     LDFLAGS="$cci_check_package_ctp_sm_save_LDFLAGS"
+                     ctp_sm_LDFLAGS="$cci_check_package_ctp_sm_orig_LDFLAGS"
+                     unset ac_cv_lib_c_fts_open
 fi
 fi
 
            if test "$cci_check_package_lib_happy" = "no"; then :
   if test "$cci_check_package_libdir" != ""; then :
-  ctp_gni_LDFLAGS="$ctp_gni_LDFLAGS -L$cci_check_package_libdir/lib"
+  ctp_sm_LDFLAGS="$ctp_sm_LDFLAGS -L$cci_check_package_libdir/lib"
                      LDFLAGS="$LDFLAGS -L$cci_check_package_libdir/lib"
                      { $as_echo "$as_me:${as_lineno-$LINENO}: result: looking for library in lib" >&5
 $as_echo "looking for library in lib" >&6; }
-                     { $as_echo "$as_me:${as_lineno-$LINENO}: checking for GNI_CdmCreate in -lugni" >&5
-$as_echo_n "checking for GNI_CdmCreate in -lugni... " >&6; }
-if ${ac_cv_lib_ugni_GNI_CdmCreate+:} false; then :
+                     { $as_echo "$as_me:${as_lineno-$LINENO}: checking for fts_open in -lc" >&5
+$as_echo_n "checking for fts_open in -lc... " >&6; }
+if ${ac_cv_lib_c_fts_open+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   ac_check_lib_save_LIBS=$LIBS
-LIBS="-lugni  $LIBS"
+LIBS="-lc  $LIBS"
 cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
 
@@ -11293,178 +11121,406 @@
 #ifdef __cplusplus
 extern "C"
 #endif
-char GNI_CdmCreate ();
+char fts_open ();
 int
 main ()
 {
-return GNI_CdmCreate ();
+return fts_open ();
   ;
   return 0;
 }
 _ACEOF
 if ac_fn_c_try_link "$LINENO"; then :
-  ac_cv_lib_ugni_GNI_CdmCreate=yes
+  ac_cv_lib_c_fts_open=yes
 else
-  ac_cv_lib_ugni_GNI_CdmCreate=no
+  ac_cv_lib_c_fts_open=no
 fi
 rm -f core conftest.err conftest.$ac_objext \
     conftest$ac_exeext conftest.$ac_ext
 LIBS=$ac_check_lib_save_LIBS
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_ugni_GNI_CdmCreate" >&5
-$as_echo "$ac_cv_lib_ugni_GNI_CdmCreate" >&6; }
-if test "x$ac_cv_lib_ugni_GNI_CdmCreate" = xyes; then :
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_c_fts_open" >&5
+$as_echo "$ac_cv_lib_c_fts_open" >&6; }
+if test "x$ac_cv_lib_c_fts_open" = xyes; then :
   cci_check_package_lib_happy="yes"
 else
   cci_check_package_lib_happy="no"
 fi
 
-                     if test "$cci_check_package_lib_happy" = "no"; then :
-   # no go on the as is..  see what happens later...
-                          LDFLAGS="$cci_check_package_ctp_gni_save_LDFLAGS"
-                          ctp_gni_LDFLAGS="$cci_check_package_ctp_gni_orig_LDFLAGS"
-                          unset ac_cv_lib_ugni_GNI_CdmCreate
-fi
-fi
+                     if test "$cci_check_package_lib_happy" = "no"; then :
+   # no go on the as is..  see what happens later...
+                          LDFLAGS="$cci_check_package_ctp_sm_save_LDFLAGS"
+                          ctp_sm_LDFLAGS="$cci_check_package_ctp_sm_orig_LDFLAGS"
+                          unset ac_cv_lib_c_fts_open
+fi
+fi
+fi
+
+           if test "$cci_check_package_lib_happy" = "no"; then :
+  if test "$cci_check_package_libdir" != ""; then :
+  ctp_sm_LDFLAGS="$ctp_sm_LDFLAGS -L$cci_check_package_libdir/lib64"
+                     LDFLAGS="$LDFLAGS -L$cci_check_package_libdir/lib64"
+                     { $as_echo "$as_me:${as_lineno-$LINENO}: result: looking for library in lib64" >&5
+$as_echo "looking for library in lib64" >&6; }
+                     { $as_echo "$as_me:${as_lineno-$LINENO}: checking for fts_open in -lc" >&5
+$as_echo_n "checking for fts_open in -lc... " >&6; }
+if ${ac_cv_lib_c_fts_open+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  ac_check_lib_save_LIBS=$LIBS
+LIBS="-lc  $LIBS"
+cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
+
+/* Override any GCC internal prototype to avoid an error.
+   Use char because int might match the return type of a GCC
+   builtin and then its argument prototype would still apply.  */
+#ifdef __cplusplus
+extern "C"
+#endif
+char fts_open ();
+int
+main ()
+{
+return fts_open ();
+  ;
+  return 0;
+}
+_ACEOF
+if ac_fn_c_try_link "$LINENO"; then :
+  ac_cv_lib_c_fts_open=yes
+else
+  ac_cv_lib_c_fts_open=no
+fi
+rm -f core conftest.err conftest.$ac_objext \
+    conftest$ac_exeext conftest.$ac_ext
+LIBS=$ac_check_lib_save_LIBS
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_c_fts_open" >&5
+$as_echo "$ac_cv_lib_c_fts_open" >&6; }
+if test "x$ac_cv_lib_c_fts_open" = xyes; then :
+  cci_check_package_lib_happy="yes"
+else
+  cci_check_package_lib_happy="no"
+fi
+
+                     if test "$cci_check_package_lib_happy" = "no"; then :
+   # no go on the as is..  see what happens later...
+                          LDFLAGS="$cci_check_package_ctp_sm_save_LDFLAGS"
+                          ctp_sm_LDFLAGS="$cci_check_package_ctp_sm_orig_LDFLAGS"
+                          unset ac_cv_lib_c_fts_open
+fi
+fi
+fi
+fi
+
+    if test "$cci_check_package_lib_happy" = "yes"; then :
+  ctp_sm_LIBS="-lc "
+           cci_check_package_happy="yes"
+else
+  cci_check_package_happy="no"
+fi
+
+
+fi
+    unset cci_check_package_header_happy
+
+    if test "$cci_check_package_happy" = "yes"; then :
+  ctp_sm_happy="yes"
+else
+  ctp_sm_CPPFLAGS="$cci_check_package_ctp_sm_orig_CPPFLAGS"
+           ctp_sm_LDFLAGS="$cci_check_package_ctp_sm_orig_LDFLAGS"
+           ctp_sm_LIBS="$cci_check_package_ctp_sm_orig_LIBS"
+           ctp_sm_happy="no"
+fi
+
+    CPPFLAGS="$cci_check_package_ctp_sm_save_CPPFLAGS"
+    LDFLAGS="$cci_check_package_ctp_sm_save_LDFLAGS"
+    LIBS="$cci_check_package_ctp_sm_save_LIBS"
+
+fi
+
+    if test "$ctp_sm_happy" = "yes"; then :
+  ctp_sm_WRAPPER_EXTRA_LDFLAGS="$ctp_sm_LDFLAGS"
+           ctp_sm_WRAPPER_EXTRA_LIBS="$ctp_sm_LIBS"
+           should_build=1
+else
+  should_build=0
+fi
+
+    # sanity check
+    if test "$ctp_sm_happy" = "no"; then :
+  if test "$with_sm" != "no" -a ! -z "$with_sm"; then :
+  { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: ctp:sm requested but not found" >&5
+$as_echo "$as_me: WARNING: ctp:sm requested but not found" >&2;}
+                  as_fn_error $? "Cannot continue" "$LINENO" 5
+fi
+fi
+
+    # substitute in the things needed to build libnuma
+
+
+
+
+
+    cflags_save=$CFLAGS
+    ldflags_save=$LDFLAGS
+    libs_save=$LIBS
+    xpmem_dir=no
+
+# Check whether --with-sm-xpmem was given.
+if test "${with_sm_xpmem+set}" = set; then :
+  withval=$with_sm_xpmem; if test "x$withval" != xyes; then :
+  xpmem_dir=$withval
+fi
+fi
+
+    if test "x$xpmem_dir" != xyes -a "x$xpmem_dir" != xno; then :
+  echo xxpmem_dir is "x$xpmem_dir"
+         sm_ldadd="-L$xpmem_dir/lib -L$xpmem_dir/lib64"
+         sm_libadd="-lxpmem"
+         sm_incadd="-I$xpmem_dir/include"
+         CFLAGS="$CFLAGS $sm_incadd"
+         LDFLAGS="$LDFLAGS $sm_ldadd $sm_libadd"
+else
+  echo xpmem not specified
+fi
+    ac_fn_c_check_header_mongrel "$LINENO" "xpmem.h" "ac_cv_header_xpmem_h" "$ac_includes_default"
+if test "x$ac_cv_header_xpmem_h" = xyes; then :
+  $as_echo "#define HAVE_XPMEM_H 1" >>confdefs.h
+
+	    CFLAGS="$cflags_save"
+	    LDFLAGS="$ldflags_save"
+	    LIBS="$libs_save"
+	    ctp_sm_CFLAGS="$ctp_sm_CFLAGS $sm_incadd"
+	    ctp_sm_LDFLAGS="$ctp_sm_LDFLAGS $sm_ldadd"
+	    ctp_sm_LIBS="$ctp_sm_LIBS $sm_libadd"
+else
+
+$as_echo "#define HAVE_XPMEM_H 0" >>confdefs.h
+
+	    CFLAGS="$cflags_save"
+	    LDFLAGS="$ldflags_save"
+	    LIBS="$libs_save"
+
+fi
+
+
+    unset cflags_save
+    unset ldflags_save
+    unset libs_save
+    unset sm_ldadd
+    unset sm_libadd
+    unset sm_incadd
+
+    use_cma=no
+
+# Check whether --with-sm-cma was given.
+if test "${with_sm_cma+set}" = set; then :
+  withval=$with_sm_cma;
+fi
+
+    ac_fn_c_check_func "$LINENO" "process_vm_writev" "ac_cv_func_process_vm_writev"
+if test "x$ac_cv_func_process_vm_writev" = xyes; then :
+  $as_echo "#define HAVE_CMA_H 1" >>confdefs.h
+
+else
+
+$as_echo "#define HAVE_CMA_H 0" >>confdefs.h
+
+fi
+
+
+
+fi
+
+    if test "$should_build" = "1"; then :
+
+
+
+
+
+
+
+
+
+
+
+    project=cci
+    framework=ctp
+    plugin=sm
+
+    # See if it dropped an output file for us to pick up some
+    # shell variables in.
+    infile="$srcdir/src/plugins/$framework/$plugin/post_configure.sh"
+
+    # Add this subdir to the mast list of all plugin subdirs
+    all_plugins="$all_plugins $plugin"
+
+    if test "$compile_mode" = "dso" ; then
+        dso_plugins="$dso_plugins $plugin"
+    else
+        { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: Unknown plugin build mode" >&5
+$as_echo "$as_me: WARNING: Unknown plugin build mode" >&2;}
+        as_fn_error $? "Cannot continue" "$LINENO" 5
+    fi
+
+    # Output pretty results
+    { $as_echo "$as_me:${as_lineno-$LINENO}: checking if $project plugin $framework:$plugin can compile" >&5
+$as_echo_n "checking if $project plugin $framework:$plugin can compile... " >&6; }
+    { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
+$as_echo "yes" >&6; }
+
+    # If there's an output file, add the values to
+    # scope_EXTRA_flags.
+    if test -f $infile; then
+
+        # First check for the ABORT tag
+        line="`$GREP ABORT= $infile | cut -d= -f2-`"
+        if test -n "$line" -a "$line" != "no"; then
+            { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: cci plugin configure script told me to abort" >&5
+$as_echo "$as_me: WARNING: cci plugin configure script told me to abort" >&2;}
+            as_fn_error $? "cannot continue" "$LINENO" 5
+        fi
+    fi
+
+else
+
+
+
+
+
+    { $as_echo "$as_me:${as_lineno-$LINENO}: checking if cci plugin ctp:sm can compile" >&5
+$as_echo_n "checking if cci plugin ctp:sm can compile... " >&6; }
+    { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+$as_echo "no" >&6; }
+
+    # If this plugin was requested as the default for this
+    # framework, then abort.
+    if test "$with_mpdc_fw" = "sm" ; then
+        { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: cci plugin \"sm\" failed to configure properly" >&5
+$as_echo "$as_me: WARNING: cci plugin \"sm\" failed to configure properly" >&2;}
+        { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: This plugin was selected as the default" >&5
+$as_echo "$as_me: WARNING: This plugin was selected as the default" >&2;}
+        as_fn_error $? "Cannot continue" "$LINENO" 5
+        exit 1
+    fi
+
+           # add plugin to all plugin list
+           all_plugins="$all_plugins sm"
 fi
 
-           if test "$cci_check_package_lib_happy" = "no"; then :
-  if test "$cci_check_package_libdir" != ""; then :
-  ctp_gni_LDFLAGS="$ctp_gni_LDFLAGS -L$cci_check_package_libdir/lib64"
-                     LDFLAGS="$LDFLAGS -L$cci_check_package_libdir/lib64"
-                     { $as_echo "$as_me:${as_lineno-$LINENO}: result: looking for library in lib64" >&5
-$as_echo "looking for library in lib64" >&6; }
-                     { $as_echo "$as_me:${as_lineno-$LINENO}: checking for GNI_CdmCreate in -lugni" >&5
-$as_echo_n "checking for GNI_CdmCreate in -lugni... " >&6; }
-if ${ac_cv_lib_ugni_GNI_CdmCreate+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  ac_check_lib_save_LIBS=$LIBS
-LIBS="-lugni  $LIBS"
-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
 
-/* Override any GCC internal prototype to avoid an error.
-   Use char because int might match the return type of a GCC
-   builtin and then its argument prototype would still apply.  */
-#ifdef __cplusplus
-extern "C"
-#endif
-char GNI_CdmCreate ();
-int
-main ()
-{
-return GNI_CdmCreate ();
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_link "$LINENO"; then :
-  ac_cv_lib_ugni_GNI_CdmCreate=yes
+
+    # set the AM_CONDITIONAL on how we should build
+    if test "$compile_mode" = "dso"; then :
+  BUILD_cci_ctp_sm_DSO=1
 else
-  ac_cv_lib_ugni_GNI_CdmCreate=no
-fi
-rm -f core conftest.err conftest.$ac_objext \
-    conftest$ac_exeext conftest.$ac_ext
-LIBS=$ac_check_lib_save_LIBS
+  BUILD_cci_ctp_sm_DSO=0
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_ugni_GNI_CdmCreate" >&5
-$as_echo "$ac_cv_lib_ugni_GNI_CdmCreate" >&6; }
-if test "x$ac_cv_lib_ugni_GNI_CdmCreate" = xyes; then :
-  cci_check_package_lib_happy="yes"
+     if test "$BUILD_cci_ctp_sm_DSO" = "1"; then
+  CCI_BUILD_cci_ctp_sm_DSO_TRUE=
+  CCI_BUILD_cci_ctp_sm_DSO_FALSE='#'
 else
-  cci_check_package_lib_happy="no"
+  CCI_BUILD_cci_ctp_sm_DSO_TRUE='#'
+  CCI_BUILD_cci_ctp_sm_DSO_FALSE=
 fi
 
-                     if test "$cci_check_package_lib_happy" = "no"; then :
-   # no go on the as is..  see what happens later...
-                          LDFLAGS="$cci_check_package_ctp_gni_save_LDFLAGS"
-                          ctp_gni_LDFLAGS="$cci_check_package_ctp_gni_orig_LDFLAGS"
-                          unset ac_cv_lib_ugni_GNI_CdmCreate
-fi
-fi
-fi
-fi
 
-    if test "$cci_check_package_lib_happy" = "yes"; then :
-  ctp_gni_LIBS="-lugni "
-           cci_check_package_happy="yes"
+    if test "$should_build" = "1"; then :
+  plugins_last_result=1
 else
-  cci_check_package_happy="no"
+  plugins_last_result=0
 fi
 
+    unset compile_mode
+
 
-fi
-    unset cci_check_package_header_happy
 
-    if test "$cci_check_package_happy" = "yes"; then :
-  ctp_gni_happy="yes"
-else
-  ctp_gni_CPPFLAGS="$cci_check_package_ctp_gni_orig_CPPFLAGS"
-           ctp_gni_LDFLAGS="$cci_check_package_ctp_gni_orig_LDFLAGS"
-           ctp_gni_LIBS="$cci_check_package_ctp_gni_orig_LIBS"
-           ctp_gni_happy="no"
-fi
 
-    CPPFLAGS="$cci_check_package_ctp_gni_save_CPPFLAGS"
-    LDFLAGS="$cci_check_package_ctp_gni_save_LDFLAGS"
-    LIBS="$cci_check_package_ctp_gni_save_LIBS"
 
-fi
 
-    if test "$ctp_gni_happy" = "yes"; then :
-  ctp_gni_WRAPPER_EXTRA_LDFLAGS="$ctp_gni_LDFLAGS"
-           ctp_gni_WRAPPER_EXTRA_LIBS="$ctp_gni_LIBS"
-           should_build=1
+
+
+
+
+
+
+
+
+    cci_show_subsubsubtitle "cci plugin ctp:eth (m4 configuration macro)"
+
+
+
+
+
+
+
+
+
+
+    project_root=src
+    framework=ctp
+    plugin=eth
+    plugin_path="$srcdir/$project_root/plugins/$framework/$plugin"
+    want_plugin=1
+
+    # if we were explicitly disabled, don't build :)
+    str="DISABLED_PLUGIN_CHECK=\$DISABLE_${framework}"
+    eval $str
+    if test "$DISABLED_PLUGIN_CHECK" = "1" ; then
+        want_plugin=0
+    fi
+    str="DISABLED_PLUGIN_CHECK=\$DISABLE_${framework}_$plugin"
+    eval $str
+    if test "$DISABLED_PLUGIN_CHECK" = "1" ; then
+        want_plugin=0
+    fi
+
+    if test "$want_plugin" = "1"; then :
+  should_build=$plugins_looking_for_succeed
 else
   should_build=0
 fi
 
-    # sanity check
-    if test "$ctp_gni_happy" = "no"; then :
-  if test "$with_gni" != "no" -a ! -z "$with_gni"; then :
-  { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: ctp:gni requested but not found" >&5
-$as_echo "$as_me: WARNING: ctp:gni requested but not found" >&2;}
-                  as_fn_error $? "Cannot continue" "$LINENO" 5
-fi
-fi
-
-    # substitute in the things needed to build libnuma
+    # Allow the plugin to override the build mode if it really wants to.
+    # It is, of course, free to end up calling PLUGINS_PLUGIN_COMPILE_MODE
 
 
 
 
 
 
-# Check whether --with-gni-ptag was given.
-if test "${with_gni_ptag+set}" = set; then :
-  withval=$with_gni_ptag;
-cat >>confdefs.h <<_ACEOF
-#define GNI_PTAG $withval
-_ACEOF
+    project=cci
+    framework=ctp
+    plugin=eth
 
-else
-  cat >>confdefs.h <<_ACEOF
-#define GNI_PTAG 208
-_ACEOF
+    # Is this plugin going to built staic or shared?  $plugin
+    # might not be known until configure time, so have to use eval
+    # tricks - can't set variable names at autogen time.
+    str="SHARED_FRAMEWORK=\$DSO_$framework"
+    eval $str
+    str="SHARED_PLUGIN=\$DSO_${framework}_$plugin"
+    eval $str
 
-fi
+    # Static is not supported right now; so the only option is DSO
+    compile_mode=dso
 
+    { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $project plugin $framework:$plugin compile mode" >&5
+$as_echo_n "checking for $project plugin $framework:$plugin compile mode... " >&6; }
+    { $as_echo "$as_me:${as_lineno-$LINENO}: result: $compile_mode" >&5
+$as_echo "$compile_mode" >&6; }
 
-# Check whether --with-gni-cookie was given.
-if test "${with_gni_cookie+set}" = set; then :
-  withval=$with_gni_cookie;
-cat >>confdefs.h <<_ACEOF
-#define GNI_COOKIE $withval
-_ACEOF
 
-else
-  cat >>confdefs.h <<_ACEOF
-#define GNI_COOKIE 0x73e70000
-_ACEOF
+    # try to configure the plugin.  pay no attention to
+    # --enable-dist, since we'll always have makefiles.
+    if test "$should_build" = "1"; then :
 
-fi
 
+    case ${target} in
+	*-*-linux*) should_build=1;;
+	*) should_build=0;;
+    esac
 
 
 fi
@@ -11483,7 +11539,7 @@
 
     project=cci
     framework=ctp
-    plugin=gni
+    plugin=eth
 
     # See if it dropped an output file for us to pick up some
     # shell variables in.
@@ -11525,16 +11581,16 @@
 
 
 
-    { $as_echo "$as_me:${as_lineno-$LINENO}: checking if cci plugin ctp:gni can compile" >&5
-$as_echo_n "checking if cci plugin ctp:gni can compile... " >&6; }
+    { $as_echo "$as_me:${as_lineno-$LINENO}: checking if cci plugin ctp:eth can compile" >&5
+$as_echo_n "checking if cci plugin ctp:eth can compile... " >&6; }
     { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
 $as_echo "no" >&6; }
 
     # If this plugin was requested as the default for this
     # framework, then abort.
-    if test "$with_mpdc_fw" = "gni" ; then
-        { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: cci plugin \"gni\" failed to configure properly" >&5
-$as_echo "$as_me: WARNING: cci plugin \"gni\" failed to configure properly" >&2;}
+    if test "$with_mpdc_fw" = "eth" ; then
+        { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: cci plugin \"eth\" failed to configure properly" >&5
+$as_echo "$as_me: WARNING: cci plugin \"eth\" failed to configure properly" >&2;}
         { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: This plugin was selected as the default" >&5
 $as_echo "$as_me: WARNING: This plugin was selected as the default" >&2;}
         as_fn_error $? "Cannot continue" "$LINENO" 5
@@ -11542,23 +11598,23 @@
     fi
 
            # add plugin to all plugin list
-           all_plugins="$all_plugins gni"
+           all_plugins="$all_plugins eth"
 fi
 
 
 
     # set the AM_CONDITIONAL on how we should build
     if test "$compile_mode" = "dso"; then :
-  BUILD_cci_ctp_gni_DSO=1
+  BUILD_cci_ctp_eth_DSO=1
 else
-  BUILD_cci_ctp_gni_DSO=0
+  BUILD_cci_ctp_eth_DSO=0
 fi
-     if test "$BUILD_cci_ctp_gni_DSO" = "1"; then
-  CCI_BUILD_cci_ctp_gni_DSO_TRUE=
-  CCI_BUILD_cci_ctp_gni_DSO_FALSE='#'
+     if test "$BUILD_cci_ctp_eth_DSO" = "1"; then
+  CCI_BUILD_cci_ctp_eth_DSO_TRUE=
+  CCI_BUILD_cci_ctp_eth_DSO_FALSE='#'
 else
-  CCI_BUILD_cci_ctp_gni_DSO_TRUE='#'
-  CCI_BUILD_cci_ctp_gni_DSO_FALSE=
+  CCI_BUILD_cci_ctp_eth_DSO_TRUE='#'
+  CCI_BUILD_cci_ctp_eth_DSO_FALSE=
 fi
 
 
@@ -11583,7 +11639,7 @@
 
 
 
-    cci_show_subsubsubtitle "cci plugin ctp:sm (m4 configuration macro)"
+    cci_show_subsubsubtitle "cci plugin ctp:verbs (m4 configuration macro)"
 
 
 
@@ -11596,7 +11652,7 @@
 
     project_root=src
     framework=ctp
-    plugin=sm
+    plugin=verbs
     plugin_path="$srcdir/$project_root/plugins/$framework/$plugin"
     want_plugin=1
 
@@ -11628,7 +11684,7 @@
 
     project=cci
     framework=ctp
-    plugin=sm
+    plugin=verbs
 
     # Is this plugin going to built staic or shared?  $plugin
     # might not be known until configure time, so have to use eval
@@ -11658,34 +11714,34 @@
     # of what this macro does and what each of the parameters are.
 
 
-# Check whether --with-sm was given.
-if test "${with_sm+set}" = set; then :
-  withval=$with_sm;
+# Check whether --with-verbs was given.
+if test "${with_verbs+set}" = set; then :
+  withval=$with_verbs;
 fi
 
 
-    { $as_echo "$as_me:${as_lineno-$LINENO}: checking --with-sm value" >&5
-$as_echo_n "checking --with-sm value... " >&6; }
-    if test "$with_sm" = "yes" -o "$with_sm" = "no" -o "x$with_sm" = "x"; then :
+    { $as_echo "$as_me:${as_lineno-$LINENO}: checking --with-verbs value" >&5
+$as_echo_n "checking --with-verbs value... " >&6; }
+    if test "$with_verbs" = "yes" -o "$with_verbs" = "no" -o "x$with_verbs" = "x"; then :
   { $as_echo "$as_me:${as_lineno-$LINENO}: result: simple ok (unspecified)" >&5
 $as_echo "simple ok (unspecified)" >&6; }
 else
-  if test ! -d "$with_sm"; then :
+  if test ! -d "$with_verbs"; then :
   { $as_echo "$as_me:${as_lineno-$LINENO}: result: not found" >&5
 $as_echo "not found" >&6; }
-                  { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: Directory $with_sm not found" >&5
-$as_echo "$as_me: WARNING: Directory $with_sm not found" >&2;}
+                  { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: Directory $with_verbs not found" >&5
+$as_echo "$as_me: WARNING: Directory $with_verbs not found" >&2;}
                   as_fn_error $? "Cannot continue" "$LINENO" 5
 else
-  if test "x`ls $with_sm/include/sys/mman.h 2> /dev/null`" = "x"; then :
+  if test "x`ls $with_verbs/include/rdma/rdma_cma.h 2> /dev/null`" = "x"; then :
   { $as_echo "$as_me:${as_lineno-$LINENO}: result: not found" >&5
 $as_echo "not found" >&6; }
-                         { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: Expected file $with_sm/include/sys/mman.h not found" >&5
-$as_echo "$as_me: WARNING: Expected file $with_sm/include/sys/mman.h not found" >&2;}
+                         { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: Expected file $with_verbs/include/rdma/rdma_cma.h not found" >&5
+$as_echo "$as_me: WARNING: Expected file $with_verbs/include/rdma/rdma_cma.h not found" >&2;}
                          as_fn_error $? "Cannot continue" "$LINENO" 5
 else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: sanity check ok ($with_sm)" >&5
-$as_echo "sanity check ok ($with_sm)" >&6; }
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: sanity check ok ($with_verbs)" >&5
+$as_echo "sanity check ok ($with_verbs)" >&6; }
 
 fi
 
@@ -11696,34 +11752,34 @@
 fi
 
 
-# Check whether --with-sm-libdir was given.
-if test "${with_sm_libdir+set}" = set; then :
-  withval=$with_sm_libdir;
+# Check whether --with-verbs-libdir was given.
+if test "${with_verbs_libdir+set}" = set; then :
+  withval=$with_verbs_libdir;
 fi
 
 
-    { $as_echo "$as_me:${as_lineno-$LINENO}: checking --with-sm-libdir value" >&5
-$as_echo_n "checking --with-sm-libdir value... " >&6; }
-    if test "$with_sm_libdir" = "yes" -o "$with_sm_libdir" = "no" -o "x$with_sm_libdir" = "x"; then :
+    { $as_echo "$as_me:${as_lineno-$LINENO}: checking --with-verbs-libdir value" >&5
+$as_echo_n "checking --with-verbs-libdir value... " >&6; }
+    if test "$with_verbs_libdir" = "yes" -o "$with_verbs_libdir" = "no" -o "x$with_verbs_libdir" = "x"; then :
   { $as_echo "$as_me:${as_lineno-$LINENO}: result: simple ok (unspecified)" >&5
 $as_echo "simple ok (unspecified)" >&6; }
 else
-  if test ! -d "$with_sm_libdir"; then :
+  if test ! -d "$with_verbs_libdir"; then :
   { $as_echo "$as_me:${as_lineno-$LINENO}: result: not found" >&5
 $as_echo "not found" >&6; }
-                  { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: Directory $with_sm_libdir not found" >&5
-$as_echo "$as_me: WARNING: Directory $with_sm_libdir not found" >&2;}
+                  { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: Directory $with_verbs_libdir not found" >&5
+$as_echo "$as_me: WARNING: Directory $with_verbs_libdir not found" >&2;}
                   as_fn_error $? "Cannot continue" "$LINENO" 5
 else
-  if test "x`ls $with_sm_libdir/libc* 2> /dev/null`" = "x"; then :
+  if test "x`ls $with_verbs_libdir/librdmacm* 2> /dev/null`" = "x"; then :
   { $as_echo "$as_me:${as_lineno-$LINENO}: result: not found" >&5
 $as_echo "not found" >&6; }
-                         { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: Expected file $with_sm_libdir/libc* not found" >&5
-$as_echo "$as_me: WARNING: Expected file $with_sm_libdir/libc* not found" >&2;}
+                         { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: Expected file $with_verbs_libdir/librdmacm* not found" >&5
+$as_echo "$as_me: WARNING: Expected file $with_verbs_libdir/librdmacm* not found" >&2;}
                          as_fn_error $? "Cannot continue" "$LINENO" 5
 else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: sanity check ok ($with_sm_libdir)" >&5
-$as_echo "sanity check ok ($with_sm_libdir)" >&6; }
+  { $as_echo "$as_me:${as_lineno-$LINENO}: result: sanity check ok ($with_verbs_libdir)" >&5
+$as_echo "sanity check ok ($with_verbs_libdir)" >&6; }
 
 fi
 
@@ -11734,28 +11790,28 @@
 fi
 
 
-    if test ! -z "$with_sm" -a "$with_sm" != "yes"; then :
-  ctp_sm_dir="$with_sm"
+    if test ! -z "$with_verbs" -a "$with_verbs" != "yes"; then :
+  ctp_verbs_dir="$with_verbs"
 fi
-    if test ! -z "$with_sm_libdir" -a "$with_sm_libdir" != "yes"; then :
-  ctp_sm_libdir="$with_sm_libdir"
+    if test ! -z "$with_verbs_libdir" -a "$with_verbs_libdir" != "yes"; then :
+  ctp_verbs_libdir="$with_verbs_libdir"
 fi
 
-    if test "$with_sm" = "no"; then :
-  ctp_sm_happy="no"
+    if test "$with_verbs" = "no"; then :
+  ctp_verbs_happy="no"
 else
-  ctp_sm_happy="yes"
+  ctp_verbs_happy="yes"
 fi
 
-    if test "$ctp_sm_happy" = "yes"; then :
+    if test "$ctp_verbs_happy" = "yes"; then :
 
-    cci_check_package_ctp_sm_save_CPPFLAGS="$CPPFLAGS"
-    cci_check_package_ctp_sm_save_LDFLAGS="$LDFLAGS"
-    cci_check_package_ctp_sm_save_LIBS="$LIBS"
+    cci_check_package_ctp_verbs_save_CPPFLAGS="$CPPFLAGS"
+    cci_check_package_ctp_verbs_save_LDFLAGS="$LDFLAGS"
+    cci_check_package_ctp_verbs_save_LIBS="$LIBS"
 
-    cci_check_package_ctp_sm_orig_CPPFLAGS="$ctp_sm_CPPFLAGS"
-    cci_check_package_ctp_sm_orig_LDFLAGS="$ctp_sm_LDFLAGS"
-    cci_check_package_ctp_sm_orig_LIBS="$ctp_sm_LIBS"
+    cci_check_package_ctp_verbs_orig_CPPFLAGS="$ctp_verbs_CPPFLAGS"
+    cci_check_package_ctp_verbs_orig_LDFLAGS="$ctp_verbs_LDFLAGS"
+    cci_check_package_ctp_verbs_orig_LIBS="$ctp_verbs_LIBS"
 
 
     # This is stolen from autoconf to peek under the covers to get the
@@ -11766,15 +11822,15 @@
     # so this sucks, but there's no way to get through the progression
     # of header includes without killing off the cache variable and trying
     # again...
-    unset ac_cv_header_sys_mman_h
+    unset ac_cv_header_rdma_rdma_cma_h
 
     cci_check_package_header_happy="no"
-    if test "$ctp_sm_dir" = "/usr" -o "$ctp_sm_dir" = "/usr/local"; then :
+    if test "$ctp_verbs_dir" = "/usr" -o "$ctp_verbs_dir" = "/usr/local"; then :
    # try as is...
             { $as_echo "$as_me:${as_lineno-$LINENO}: result: looking for header without includes" >&5
 $as_echo "looking for header without includes" >&6; }
-            ac_fn_c_check_header_mongrel "$LINENO" "sys/mman.h" "ac_cv_header_sys_mman_h" "$ac_includes_default"
-if test "x$ac_cv_header_sys_mman_h" = xyes; then :
+            ac_fn_c_check_header_mongrel "$LINENO" "rdma/rdma_cma.h" "ac_cv_header_rdma_rdma_cma_h" "$ac_includes_default"
+if test "x$ac_cv_header_rdma_rdma_cma_h" = xyes; then :
   cci_check_package_header_happy="yes"
 else
   cci_check_package_header_happy="no"
@@ -11783,36 +11839,36 @@
 
             if test "$cci_check_package_header_happy" = "no"; then :
   # no go on the as is - reset the cache and try again
-                   unset ac_cv_header_sys_mman_h
+                   unset ac_cv_header_rdma_rdma_cma_h
 fi
 fi
 
     if test "$cci_check_package_header_happy" = "no"; then :
-  if test "$ctp_sm_dir" != ""; then :
-  ctp_sm_CPPFLAGS="$ctp_sm_CPPFLAGS -I$ctp_sm_dir/include"
-                  CPPFLAGS="$CPPFLAGS -I$ctp_sm_dir/include"
+  if test "$ctp_verbs_dir" != ""; then :
+  ctp_verbs_CPPFLAGS="$ctp_verbs_CPPFLAGS -I$ctp_verbs_dir/include"
+                  CPPFLAGS="$CPPFLAGS -I$ctp_verbs_dir/include"
 fi
-           ac_fn_c_check_header_mongrel "$LINENO" "sys/mman.h" "ac_cv_header_sys_mman_h" "$ac_includes_default"
-if test "x$ac_cv_header_sys_mman_h" = xyes; then :
+           ac_fn_c_check_header_mongrel "$LINENO" "rdma/rdma_cma.h" "ac_cv_header_rdma_rdma_cma_h" "$ac_includes_default"
+if test "x$ac_cv_header_rdma_rdma_cma_h" = xyes; then :
 
     # This is stolen from autoconf to peek under the covers to get the
     # cache variable for the library check.  one should not copy this
     # code into other places unless you want much pain and suffering
 
     # see comment above
-    unset ac_cv_lib_c_fts_open
+    unset ac_cv_lib_rdmacm_rdma_create_id
     cci_check_package_lib_happy="no"
-    if test "$ctp_sm_libdir" != ""; then :
+    if test "$ctp_verbs_libdir" != ""; then :
    # libdir was specified - search only there
-           ctp_sm_LDFLAGS="$ctp_sm_LDFLAGS -L$ctp_sm_libdir"
-           LDFLAGS="$LDFLAGS -L$ctp_sm_libdir"
-           { $as_echo "$as_me:${as_lineno-$LINENO}: checking for fts_open in -lc" >&5
-$as_echo_n "checking for fts_open in -lc... " >&6; }
-if ${ac_cv_lib_c_fts_open+:} false; then :
+           ctp_verbs_LDFLAGS="$ctp_verbs_LDFLAGS -L$ctp_verbs_libdir"
+           LDFLAGS="$LDFLAGS -L$ctp_verbs_libdir"
+           { $as_echo "$as_me:${as_lineno-$LINENO}: checking for rdma_create_id in -lrdmacm" >&5
+$as_echo_n "checking for rdma_create_id in -lrdmacm... " >&6; }
+if ${ac_cv_lib_rdmacm_rdma_create_id+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   ac_check_lib_save_LIBS=$LIBS
-LIBS="-lc  $LIBS"
+LIBS="-lrdmacm -libverbs $LIBS"
 cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
 
@@ -11822,51 +11878,51 @@
 #ifdef __cplusplus
 extern "C"
 #endif
-char fts_open ();
+char rdma_create_id ();
 int
 main ()
 {
-return fts_open ();
+return rdma_create_id ();
   ;
   return 0;
 }
 _ACEOF
 if ac_fn_c_try_link "$LINENO"; then :
-  ac_cv_lib_c_fts_open=yes
+  ac_cv_lib_rdmacm_rdma_create_id=yes
 else
-  ac_cv_lib_c_fts_open=no
+  ac_cv_lib_rdmacm_rdma_create_id=no
 fi
 rm -f core conftest.err conftest.$ac_objext \
     conftest$ac_exeext conftest.$ac_ext
 LIBS=$ac_check_lib_save_LIBS
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_c_fts_open" >&5
-$as_echo "$ac_cv_lib_c_fts_open" >&6; }
-if test "x$ac_cv_lib_c_fts_open" = xyes; then :
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_rdmacm_rdma_create_id" >&5
+$as_echo "$ac_cv_lib_rdmacm_rdma_create_id" >&6; }
+if test "x$ac_cv_lib_rdmacm_rdma_create_id" = xyes; then :
   cci_check_package_lib_happy="yes"
 else
   cci_check_package_lib_happy="no"
 fi
 
            if test "$cci_check_package_lib_happy" = "no"; then :
-  LDFLAGS="$cci_check_package_ctp_sm_save_LDFLAGS"
-                  ctp_sm_LDFLAGS="$cci_check_package_ctp_sm_orig_LDFLAGS"
-                  unset ac_cv_lib_c_fts_open
+  LDFLAGS="$cci_check_package_ctp_verbs_save_LDFLAGS"
+                  ctp_verbs_LDFLAGS="$cci_check_package_ctp_verbs_orig_LDFLAGS"
+                  unset ac_cv_lib_rdmacm_rdma_create_id
 fi
 else
    # libdir was not specified - go through search path
-           cci_check_package_libdir="$ctp_sm_dir"
+           cci_check_package_libdir="$ctp_verbs_dir"
            if test "$cci_check_package_libdir" = "" -o "$cci_check_package_libdir" = "/usr" -o "$cci_check_package_libdir" = "/usr/local"; then :
    # try as is...
                 { $as_echo "$as_me:${as_lineno-$LINENO}: result: looking for library without search path" >&5
 $as_echo "looking for library without search path" >&6; }
-                { $as_echo "$as_me:${as_lineno-$LINENO}: checking for fts_open in -lc" >&5
-$as_echo_n "checking for fts_open in -lc... " >&6; }
-if ${ac_cv_lib_c_fts_open+:} false; then :
+                { $as_echo "$as_me:${as_lineno-$LINENO}: checking for rdma_create_id in -lrdmacm" >&5
+$as_echo_n "checking for rdma_create_id in -lrdmacm... " >&6; }
+if ${ac_cv_lib_rdmacm_rdma_create_id+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   ac_check_lib_save_LIBS=$LIBS
-LIBS="-lc  $LIBS"
+LIBS="-lrdmacm -libverbs $LIBS"
 cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
 
@@ -11876,27 +11932,27 @@
 #ifdef __cplusplus
 extern "C"
 #endif
-char fts_open ();
+char rdma_create_id ();
 int
 main ()
 {
-return fts_open ();
+return rdma_create_id ();
   ;
   return 0;
 }
 _ACEOF
 if ac_fn_c_try_link "$LINENO"; then :
-  ac_cv_lib_c_fts_open=yes
+  ac_cv_lib_rdmacm_rdma_create_id=yes
 else
-  ac_cv_lib_c_fts_open=no
+  ac_cv_lib_rdmacm_rdma_create_id=no
 fi
 rm -f core conftest.err conftest.$ac_objext \
     conftest$ac_exeext conftest.$ac_ext
 LIBS=$ac_check_lib_save_LIBS
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_c_fts_open" >&5
-$as_echo "$ac_cv_lib_c_fts_open" >&6; }
-if test "x$ac_cv_lib_c_fts_open" = xyes; then :
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_rdmacm_rdma_create_id" >&5
+$as_echo "$ac_cv_lib_rdmacm_rdma_create_id" >&6; }
+if test "x$ac_cv_lib_rdmacm_rdma_create_id" = xyes; then :
   cci_check_package_lib_happy="yes"
 else
   cci_check_package_lib_happy="no"
@@ -11904,25 +11960,25 @@
 
                 if test "$cci_check_package_lib_happy" = "no"; then :
    # no go on the as is..  see what happens later...
-                     LDFLAGS="$cci_check_package_ctp_sm_save_LDFLAGS"
-                     ctp_sm_LDFLAGS="$cci_check_package_ctp_sm_orig_LDFLAGS"
-                     unset ac_cv_lib_c_fts_open
+                     LDFLAGS="$cci_check_package_ctp_verbs_save_LDFLAGS"
+                     ctp_verbs_LDFLAGS="$cci_check_package_ctp_verbs_orig_LDFLAGS"
+                     unset ac_cv_lib_rdmacm_rdma_create_id
 fi
 fi
 
            if test "$cci_check_package_lib_happy" = "no"; then :
   if test "$cci_check_package_libdir" != ""; then :
-  ctp_sm_LDFLAGS="$ctp_sm_LDFLAGS -L$cci_check_package_libdir/lib"
+  ctp_verbs_LDFLAGS="$ctp_verbs_LDFLAGS -L$cci_check_package_libdir/lib"
                      LDFLAGS="$LDFLAGS -L$cci_check_package_libdir/lib"
                      { $as_echo "$as_me:${as_lineno-$LINENO}: result: looking for library in lib" >&5
 $as_echo "looking for library in lib" >&6; }
-                     { $as_echo "$as_me:${as_lineno-$LINENO}: checking for fts_open in -lc" >&5
-$as_echo_n "checking for fts_open in -lc... " >&6; }
-if ${ac_cv_lib_c_fts_open+:} false; then :
+                     { $as_echo "$as_me:${as_lineno-$LINENO}: checking for rdma_create_id in -lrdmacm" >&5
+$as_echo_n "checking for rdma_create_id in -lrdmacm... " >&6; }
+if ${ac_cv_lib_rdmacm_rdma_create_id+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   ac_check_lib_save_LIBS=$LIBS
-LIBS="-lc  $LIBS"
+LIBS="-lrdmacm -libverbs $LIBS"
 cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
 
@@ -11932,27 +11988,27 @@
 #ifdef __cplusplus
 extern "C"
 #endif
-char fts_open ();
+char rdma_create_id ();
 int
 main ()
 {
-return fts_open ();
+return rdma_create_id ();
   ;
   return 0;
 }
 _ACEOF
 if ac_fn_c_try_link "$LINENO"; then :
-  ac_cv_lib_c_fts_open=yes
+  ac_cv_lib_rdmacm_rdma_create_id=yes
 else
-  ac_cv_lib_c_fts_open=no
+  ac_cv_lib_rdmacm_rdma_create_id=no
 fi
 rm -f core conftest.err conftest.$ac_objext \
     conftest$ac_exeext conftest.$ac_ext
 LIBS=$ac_check_lib_save_LIBS
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_c_fts_open" >&5
-$as_echo "$ac_cv_lib_c_fts_open" >&6; }
-if test "x$ac_cv_lib_c_fts_open" = xyes; then :
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_rdmacm_rdma_create_id" >&5
+$as_echo "$ac_cv_lib_rdmacm_rdma_create_id" >&6; }
+if test "x$ac_cv_lib_rdmacm_rdma_create_id" = xyes; then :
   cci_check_package_lib_happy="yes"
 else
   cci_check_package_lib_happy="no"
@@ -11960,26 +12016,26 @@
 
                      if test "$cci_check_package_lib_happy" = "no"; then :
    # no go on the as is..  see what happens later...
-                          LDFLAGS="$cci_check_package_ctp_sm_save_LDFLAGS"
-                          ctp_sm_LDFLAGS="$cci_check_package_ctp_sm_orig_LDFLAGS"
-                          unset ac_cv_lib_c_fts_open
+                          LDFLAGS="$cci_check_package_ctp_verbs_save_LDFLAGS"
+                          ctp_verbs_LDFLAGS="$cci_check_package_ctp_verbs_orig_LDFLAGS"
+                          unset ac_cv_lib_rdmacm_rdma_create_id
 fi
 fi
 fi
 
            if test "$cci_check_package_lib_happy" = "no"; then :
   if test "$cci_check_package_libdir" != ""; then :
-  ctp_sm_LDFLAGS="$ctp_sm_LDFLAGS -L$cci_check_package_libdir/lib64"
+  ctp_verbs_LDFLAGS="$ctp_verbs_LDFLAGS -L$cci_check_package_libdir/lib64"
                      LDFLAGS="$LDFLAGS -L$cci_check_package_libdir/lib64"
                      { $as_echo "$as_me:${as_lineno-$LINENO}: result: looking for library in lib64" >&5
 $as_echo "looking for library in lib64" >&6; }
-                     { $as_echo "$as_me:${as_lineno-$LINENO}: checking for fts_open in -lc" >&5
-$as_echo_n "checking for fts_open in -lc... " >&6; }
-if ${ac_cv_lib_c_fts_open+:} false; then :
+                     { $as_echo "$as_me:${as_lineno-$LINENO}: checking for rdma_create_id in -lrdmacm" >&5
+$as_echo_n "checking for rdma_create_id in -lrdmacm... " >&6; }
+if ${ac_cv_lib_rdmacm_rdma_create_id+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   ac_check_lib_save_LIBS=$LIBS
-LIBS="-lc  $LIBS"
+LIBS="-lrdmacm -libverbs $LIBS"
 cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
 
@@ -11989,27 +12045,27 @@
 #ifdef __cplusplus
 extern "C"
 #endif
-char fts_open ();
+char rdma_create_id ();
 int
 main ()
 {
-return fts_open ();
+return rdma_create_id ();
   ;
   return 0;
 }
 _ACEOF
 if ac_fn_c_try_link "$LINENO"; then :
-  ac_cv_lib_c_fts_open=yes
+  ac_cv_lib_rdmacm_rdma_create_id=yes
 else
-  ac_cv_lib_c_fts_open=no
+  ac_cv_lib_rdmacm_rdma_create_id=no
 fi
 rm -f core conftest.err conftest.$ac_objext \
     conftest$ac_exeext conftest.$ac_ext
 LIBS=$ac_check_lib_save_LIBS
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_c_fts_open" >&5
-$as_echo "$ac_cv_lib_c_fts_open" >&6; }
-if test "x$ac_cv_lib_c_fts_open" = xyes; then :
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_rdmacm_rdma_create_id" >&5
+$as_echo "$ac_cv_lib_rdmacm_rdma_create_id" >&6; }
+if test "x$ac_cv_lib_rdmacm_rdma_create_id" = xyes; then :
   cci_check_package_lib_happy="yes"
 else
   cci_check_package_lib_happy="no"
@@ -12017,16 +12073,16 @@
 
                      if test "$cci_check_package_lib_happy" = "no"; then :
    # no go on the as is..  see what happens later...
-                          LDFLAGS="$cci_check_package_ctp_sm_save_LDFLAGS"
-                          ctp_sm_LDFLAGS="$cci_check_package_ctp_sm_orig_LDFLAGS"
-                          unset ac_cv_lib_c_fts_open
+                          LDFLAGS="$cci_check_package_ctp_verbs_save_LDFLAGS"
+                          ctp_verbs_LDFLAGS="$cci_check_package_ctp_verbs_orig_LDFLAGS"
+                          unset ac_cv_lib_rdmacm_rdma_create_id
 fi
 fi
 fi
 fi
 
     if test "$cci_check_package_lib_happy" = "yes"; then :
-  ctp_sm_LIBS="-lc "
+  ctp_verbs_LIBS="-lrdmacm -libverbs"
            cci_check_package_happy="yes"
 else
   cci_check_package_happy="no"
@@ -12045,19 +12101,19 @@
     # code into other places unless you want much pain and suffering
 
     # see comment above
-    unset ac_cv_lib_c_fts_open
+    unset ac_cv_lib_rdmacm_rdma_create_id
     cci_check_package_lib_happy="no"
-    if test "$ctp_sm_libdir" != ""; then :
+    if test "$ctp_verbs_libdir" != ""; then :
    # libdir was specified - search only there
-           ctp_sm_LDFLAGS="$ctp_sm_LDFLAGS -L$ctp_sm_libdir"
-           LDFLAGS="$LDFLAGS -L$ctp_sm_libdir"
-           { $as_echo "$as_me:${as_lineno-$LINENO}: checking for fts_open in -lc" >&5
-$as_echo_n "checking for fts_open in -lc... " >&6; }
-if ${ac_cv_lib_c_fts_open+:} false; then :
+           ctp_verbs_LDFLAGS="$ctp_verbs_LDFLAGS -L$ctp_verbs_libdir"
+           LDFLAGS="$LDFLAGS -L$ctp_verbs_libdir"
+           { $as_echo "$as_me:${as_lineno-$LINENO}: checking for rdma_create_id in -lrdmacm" >&5
+$as_echo_n "checking for rdma_create_id in -lrdmacm... " >&6; }
+if ${ac_cv_lib_rdmacm_rdma_create_id+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   ac_check_lib_save_LIBS=$LIBS
-LIBS="-lc  $LIBS"
+LIBS="-lrdmacm -libverbs $LIBS"
 cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
 
@@ -12067,51 +12123,51 @@
 #ifdef __cplusplus
 extern "C"
 #endif
-char fts_open ();
+char rdma_create_id ();
 int
 main ()
 {
-return fts_open ();
+return rdma_create_id ();
   ;
   return 0;
 }
 _ACEOF
 if ac_fn_c_try_link "$LINENO"; then :
-  ac_cv_lib_c_fts_open=yes
+  ac_cv_lib_rdmacm_rdma_create_id=yes
 else
-  ac_cv_lib_c_fts_open=no
+  ac_cv_lib_rdmacm_rdma_create_id=no
 fi
 rm -f core conftest.err conftest.$ac_objext \
     conftest$ac_exeext conftest.$ac_ext
 LIBS=$ac_check_lib_save_LIBS
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_c_fts_open" >&5
-$as_echo "$ac_cv_lib_c_fts_open" >&6; }
-if test "x$ac_cv_lib_c_fts_open" = xyes; then :
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_rdmacm_rdma_create_id" >&5
+$as_echo "$ac_cv_lib_rdmacm_rdma_create_id" >&6; }
+if test "x$ac_cv_lib_rdmacm_rdma_create_id" = xyes; then :
   cci_check_package_lib_happy="yes"
 else
   cci_check_package_lib_happy="no"
 fi
-
-           if test "$cci_check_package_lib_happy" = "no"; then :
-  LDFLAGS="$cci_check_package_ctp_sm_save_LDFLAGS"
-                  ctp_sm_LDFLAGS="$cci_check_package_ctp_sm_orig_LDFLAGS"
-                  unset ac_cv_lib_c_fts_open
+
+           if test "$cci_check_package_lib_happy" = "no"; then :
+  LDFLAGS="$cci_check_package_ctp_verbs_save_LDFLAGS"
+                  ctp_verbs_LDFLAGS="$cci_check_package_ctp_verbs_orig_LDFLAGS"
+                  unset ac_cv_lib_rdmacm_rdma_create_id
 fi
 else
    # libdir was not specified - go through search path
-           cci_check_package_libdir="$ctp_sm_dir"
+           cci_check_package_libdir="$ctp_verbs_dir"
            if test "$cci_check_package_libdir" = "" -o "$cci_check_package_libdir" = "/usr" -o "$cci_check_package_libdir" = "/usr/local"; then :
    # try as is...
                 { $as_echo "$as_me:${as_lineno-$LINENO}: result: looking for library without search path" >&5
 $as_echo "looking for library without search path" >&6; }
-                { $as_echo "$as_me:${as_lineno-$LINENO}: checking for fts_open in -lc" >&5
-$as_echo_n "checking for fts_open in -lc... " >&6; }
-if ${ac_cv_lib_c_fts_open+:} false; then :
+                { $as_echo "$as_me:${as_lineno-$LINENO}: checking for rdma_create_id in -lrdmacm" >&5
+$as_echo_n "checking for rdma_create_id in -lrdmacm... " >&6; }
+if ${ac_cv_lib_rdmacm_rdma_create_id+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   ac_check_lib_save_LIBS=$LIBS
-LIBS="-lc  $LIBS"
+LIBS="-lrdmacm -libverbs $LIBS"
 cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
 
@@ -12121,27 +12177,27 @@
 #ifdef __cplusplus
 extern "C"
 #endif
-char fts_open ();
+char rdma_create_id ();
 int
 main ()
 {
-return fts_open ();
+return rdma_create_id ();
   ;
   return 0;
 }
 _ACEOF
 if ac_fn_c_try_link "$LINENO"; then :
-  ac_cv_lib_c_fts_open=yes
+  ac_cv_lib_rdmacm_rdma_create_id=yes
 else
-  ac_cv_lib_c_fts_open=no
+  ac_cv_lib_rdmacm_rdma_create_id=no
 fi
 rm -f core conftest.err conftest.$ac_objext \
     conftest$ac_exeext conftest.$ac_ext
 LIBS=$ac_check_lib_save_LIBS
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_c_fts_open" >&5
-$as_echo "$ac_cv_lib_c_fts_open" >&6; }
-if test "x$ac_cv_lib_c_fts_open" = xyes; then :
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_rdmacm_rdma_create_id" >&5
+$as_echo "$ac_cv_lib_rdmacm_rdma_create_id" >&6; }
+if test "x$ac_cv_lib_rdmacm_rdma_create_id" = xyes; then :
   cci_check_package_lib_happy="yes"
 else
   cci_check_package_lib_happy="no"
@@ -12149,25 +12205,25 @@
 
                 if test "$cci_check_package_lib_happy" = "no"; then :
    # no go on the as is..  see what happens later...
-                     LDFLAGS="$cci_check_package_ctp_sm_save_LDFLAGS"
-                     ctp_sm_LDFLAGS="$cci_check_package_ctp_sm_orig_LDFLAGS"
-                     unset ac_cv_lib_c_fts_open
+                     LDFLAGS="$cci_check_package_ctp_verbs_save_LDFLAGS"
+                     ctp_verbs_LDFLAGS="$cci_check_package_ctp_verbs_orig_LDFLAGS"
+                     unset ac_cv_lib_rdmacm_rdma_create_id
 fi
 fi
 
            if test "$cci_check_package_lib_happy" = "no"; then :
   if test "$cci_check_package_libdir" != ""; then :
-  ctp_sm_LDFLAGS="$ctp_sm_LDFLAGS -L$cci_check_package_libdir/lib"
+  ctp_verbs_LDFLAGS="$ctp_verbs_LDFLAGS -L$cci_check_package_libdir/lib"
                      LDFLAGS="$LDFLAGS -L$cci_check_package_libdir/lib"
                      { $as_echo "$as_me:${as_lineno-$LINENO}: result: looking for library in lib" >&5
 $as_echo "looking for library in lib" >&6; }
-                     { $as_echo "$as_me:${as_lineno-$LINENO}: checking for fts_open in -lc" >&5
-$as_echo_n "checking for fts_open in -lc... " >&6; }
-if ${ac_cv_lib_c_fts_open+:} false; then :
+                     { $as_echo "$as_me:${as_lineno-$LINENO}: checking for rdma_create_id in -lrdmacm" >&5
+$as_echo_n "checking for rdma_create_id in -lrdmacm... " >&6; }
+if ${ac_cv_lib_rdmacm_rdma_create_id+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   ac_check_lib_save_LIBS=$LIBS
-LIBS="-lc  $LIBS"
+LIBS="-lrdmacm -libverbs $LIBS"
 cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
 
@@ -12177,27 +12233,27 @@
 #ifdef __cplusplus
 extern "C"
 #endif
-char fts_open ();
+char rdma_create_id ();
 int
 main ()
 {
-return fts_open ();
+return rdma_create_id ();
   ;
   return 0;
 }
 _ACEOF
 if ac_fn_c_try_link "$LINENO"; then :
-  ac_cv_lib_c_fts_open=yes
+  ac_cv_lib_rdmacm_rdma_create_id=yes
 else
-  ac_cv_lib_c_fts_open=no
+  ac_cv_lib_rdmacm_rdma_create_id=no
 fi
 rm -f core conftest.err conftest.$ac_objext \
     conftest$ac_exeext conftest.$ac_ext
 LIBS=$ac_check_lib_save_LIBS
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_c_fts_open" >&5
-$as_echo "$ac_cv_lib_c_fts_open" >&6; }
-if test "x$ac_cv_lib_c_fts_open" = xyes; then :
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_rdmacm_rdma_create_id" >&5
+$as_echo "$ac_cv_lib_rdmacm_rdma_create_id" >&6; }
+if test "x$ac_cv_lib_rdmacm_rdma_create_id" = xyes; then :
   cci_check_package_lib_happy="yes"
 else
   cci_check_package_lib_happy="no"
@@ -12205,26 +12261,26 @@
 
                      if test "$cci_check_package_lib_happy" = "no"; then :
    # no go on the as is..  see what happens later...
-                          LDFLAGS="$cci_check_package_ctp_sm_save_LDFLAGS"
-                          ctp_sm_LDFLAGS="$cci_check_package_ctp_sm_orig_LDFLAGS"
-                          unset ac_cv_lib_c_fts_open
+                          LDFLAGS="$cci_check_package_ctp_verbs_save_LDFLAGS"
+                          ctp_verbs_LDFLAGS="$cci_check_package_ctp_verbs_orig_LDFLAGS"
+                          unset ac_cv_lib_rdmacm_rdma_create_id
 fi
 fi
 fi
 
            if test "$cci_check_package_lib_happy" = "no"; then :
   if test "$cci_check_package_libdir" != ""; then :
-  ctp_sm_LDFLAGS="$ctp_sm_LDFLAGS -L$cci_check_package_libdir/lib64"
+  ctp_verbs_LDFLAGS="$ctp_verbs_LDFLAGS -L$cci_check_package_libdir/lib64"
                      LDFLAGS="$LDFLAGS -L$cci_check_package_libdir/lib64"
                      { $as_echo "$as_me:${as_lineno-$LINENO}: result: looking for library in lib64" >&5
 $as_echo "looking for library in lib64" >&6; }
-                     { $as_echo "$as_me:${as_lineno-$LINENO}: checking for fts_open in -lc" >&5
-$as_echo_n "checking for fts_open in -lc... " >&6; }
-if ${ac_cv_lib_c_fts_open+:} false; then :
+                     { $as_echo "$as_me:${as_lineno-$LINENO}: checking for rdma_create_id in -lrdmacm" >&5
+$as_echo_n "checking for rdma_create_id in -lrdmacm... " >&6; }
+if ${ac_cv_lib_rdmacm_rdma_create_id+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   ac_check_lib_save_LIBS=$LIBS
-LIBS="-lc  $LIBS"
+LIBS="-lrdmacm -libverbs $LIBS"
 cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
 
@@ -12234,27 +12290,27 @@
 #ifdef __cplusplus
 extern "C"
 #endif
-char fts_open ();
+char rdma_create_id ();
 int
 main ()
 {
-return fts_open ();
+return rdma_create_id ();
   ;
   return 0;
 }
 _ACEOF
 if ac_fn_c_try_link "$LINENO"; then :
-  ac_cv_lib_c_fts_open=yes
+  ac_cv_lib_rdmacm_rdma_create_id=yes
 else
-  ac_cv_lib_c_fts_open=no
+  ac_cv_lib_rdmacm_rdma_create_id=no
 fi
 rm -f core conftest.err conftest.$ac_objext \
     conftest$ac_exeext conftest.$ac_ext
 LIBS=$ac_check_lib_save_LIBS
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_c_fts_open" >&5
-$as_echo "$ac_cv_lib_c_fts_open" >&6; }
-if test "x$ac_cv_lib_c_fts_open" = xyes; then :
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_rdmacm_rdma_create_id" >&5
+$as_echo "$ac_cv_lib_rdmacm_rdma_create_id" >&6; }
+if test "x$ac_cv_lib_rdmacm_rdma_create_id" = xyes; then :
   cci_check_package_lib_happy="yes"
 else
   cci_check_package_lib_happy="no"
@@ -12262,16 +12318,16 @@
 
                      if test "$cci_check_package_lib_happy" = "no"; then :
    # no go on the as is..  see what happens later...
-                          LDFLAGS="$cci_check_package_ctp_sm_save_LDFLAGS"
-                          ctp_sm_LDFLAGS="$cci_check_package_ctp_sm_orig_LDFLAGS"
-                          unset ac_cv_lib_c_fts_open
+                          LDFLAGS="$cci_check_package_ctp_verbs_save_LDFLAGS"
+                          ctp_verbs_LDFLAGS="$cci_check_package_ctp_verbs_orig_LDFLAGS"
+                          unset ac_cv_lib_rdmacm_rdma_create_id
 fi
 fi
 fi
 fi
 
     if test "$cci_check_package_lib_happy" = "yes"; then :
-  ctp_sm_LIBS="-lc "
+  ctp_verbs_LIBS="-lrdmacm -libverbs"
            cci_check_package_happy="yes"
 else
   cci_check_package_happy="no"
@@ -12282,33 +12338,33 @@
     unset cci_check_package_header_happy
 
     if test "$cci_check_package_happy" = "yes"; then :
-  ctp_sm_happy="yes"
+  ctp_verbs_happy="yes"
 else
-  ctp_sm_CPPFLAGS="$cci_check_package_ctp_sm_orig_CPPFLAGS"
-           ctp_sm_LDFLAGS="$cci_check_package_ctp_sm_orig_LDFLAGS"
-           ctp_sm_LIBS="$cci_check_package_ctp_sm_orig_LIBS"
-           ctp_sm_happy="no"
+  ctp_verbs_CPPFLAGS="$cci_check_package_ctp_verbs_orig_CPPFLAGS"
+           ctp_verbs_LDFLAGS="$cci_check_package_ctp_verbs_orig_LDFLAGS"
+           ctp_verbs_LIBS="$cci_check_package_ctp_verbs_orig_LIBS"
+           ctp_verbs_happy="no"
 fi
 
-    CPPFLAGS="$cci_check_package_ctp_sm_save_CPPFLAGS"
-    LDFLAGS="$cci_check_package_ctp_sm_save_LDFLAGS"
-    LIBS="$cci_check_package_ctp_sm_save_LIBS"
+    CPPFLAGS="$cci_check_package_ctp_verbs_save_CPPFLAGS"
+    LDFLAGS="$cci_check_package_ctp_verbs_save_LDFLAGS"
+    LIBS="$cci_check_package_ctp_verbs_save_LIBS"
 
 fi
 
-    if test "$ctp_sm_happy" = "yes"; then :
-  ctp_sm_WRAPPER_EXTRA_LDFLAGS="$ctp_sm_LDFLAGS"
-           ctp_sm_WRAPPER_EXTRA_LIBS="$ctp_sm_LIBS"
+    if test "$ctp_verbs_happy" = "yes"; then :
+  ctp_verbs_WRAPPER_EXTRA_LDFLAGS="$ctp_verbs_LDFLAGS"
+           ctp_verbs_WRAPPER_EXTRA_LIBS="$ctp_verbs_LIBS"
            should_build=1
 else
   should_build=0
 fi
 
     # sanity check
-    if test "$ctp_sm_happy" = "no"; then :
-  if test "$with_sm" != "no" -a ! -z "$with_sm"; then :
-  { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: ctp:sm requested but not found" >&5
-$as_echo "$as_me: WARNING: ctp:sm requested but not found" >&2;}
+    if test "$ctp_verbs_happy" = "no"; then :
+  if test "$with_verbs" != "no" -a ! -z "$with_verbs"; then :
+  { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: ctp:verbs requested but not found" >&5
+$as_echo "$as_me: WARNING: ctp:verbs requested but not found" >&2;}
                   as_fn_error $? "Cannot continue" "$LINENO" 5
 fi
 fi
@@ -12319,70 +12375,14 @@
 
 
 
-    cflags_save=$CFLAGS
-    ldflags_save=$LDFLAGS
-    libs_save=$LIBS
-    xpmem_dir=no
-
-# Check whether --with-sm-xpmem was given.
-if test "${with_sm_xpmem+set}" = set; then :
-  withval=$with_sm_xpmem; if test "x$withval" != xyes; then :
-  xpmem_dir=$withval
-fi
-fi
-
-    if test "x$xpmem_dir" != xyes -a "x$xpmem_dir" != xno; then :
-  echo xxpmem_dir is "x$xpmem_dir"
-         sm_ldadd="-L$xpmem_dir/lib -L$xpmem_dir/lib64"
-         sm_libadd="-lxpmem"
-         sm_incadd="-I$xpmem_dir/include"
-         CFLAGS="$CFLAGS $sm_incadd"
-         LDFLAGS="$LDFLAGS $sm_ldadd $sm_libadd"
-else
-  echo xpmem not specified
-fi
-    ac_fn_c_check_header_mongrel "$LINENO" "xpmem.h" "ac_cv_header_xpmem_h" "$ac_includes_default"
-if test "x$ac_cv_header_xpmem_h" = xyes; then :
-  $as_echo "#define HAVE_XPMEM_H 1" >>confdefs.h
-
-	    CFLAGS="$cflags_save"
-	    LDFLAGS="$ldflags_save"
-	    LIBS="$libs_save"
-	    ctp_sm_CFLAGS="$ctp_sm_CFLAGS $sm_incadd"
-	    ctp_sm_LDFLAGS="$ctp_sm_LDFLAGS $sm_ldadd"
-	    ctp_sm_LIBS="$ctp_sm_LIBS $sm_libadd"
-else
-
-$as_echo "#define HAVE_XPMEM_H 0" >>confdefs.h
-
-	    CFLAGS="$cflags_save"
-	    LDFLAGS="$ldflags_save"
-	    LIBS="$libs_save"
-
-fi
-
-
-    unset cflags_save
-    unset ldflags_save
-    unset libs_save
-    unset sm_ldadd
-    unset sm_libadd
-    unset sm_incadd
-
-    use_cma=no
-
-# Check whether --with-sm-cma was given.
-if test "${with_sm_cma+set}" = set; then :
-  withval=$with_sm_cma;
-fi
-
-    ac_fn_c_check_func "$LINENO" "process_vm_writev" "ac_cv_func_process_vm_writev"
-if test "x$ac_cv_func_process_vm_writev" = xyes; then :
-  $as_echo "#define HAVE_CMA_H 1" >>confdefs.h
+    ac_fn_c_check_type "$LINENO" "struct rdma_addrinfo" "ac_cv_type_struct_rdma_addrinfo" "#include <rdma/rdma_cma.h>
+"
+if test "x$ac_cv_type_struct_rdma_addrinfo" = xyes; then :
+  $as_echo "#define HAVE_RDMA_ADDRINFO 1" >>confdefs.h
 
 else
 
-$as_echo "#define HAVE_CMA_H 0" >>confdefs.h
+$as_echo "#define HAVE_RDMA_ADDRINFO 0" >>confdefs.h
 
 fi
 
@@ -12404,7 +12404,7 @@
 
     project=cci
     framework=ctp
-    plugin=sm
+    plugin=verbs
 
     # See if it dropped an output file for us to pick up some
     # shell variables in.
@@ -12446,16 +12446,16 @@
 
 
 
-    { $as_echo "$as_me:${as_lineno-$LINENO}: checking if cci plugin ctp:sm can compile" >&5
-$as_echo_n "checking if cci plugin ctp:sm can compile... " >&6; }
+    { $as_echo "$as_me:${as_lineno-$LINENO}: checking if cci plugin ctp:verbs can compile" >&5
+$as_echo_n "checking if cci plugin ctp:verbs can compile... " >&6; }
     { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
 $as_echo "no" >&6; }
 
     # If this plugin was requested as the default for this
     # framework, then abort.
-    if test "$with_mpdc_fw" = "sm" ; then
-        { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: cci plugin \"sm\" failed to configure properly" >&5
-$as_echo "$as_me: WARNING: cci plugin \"sm\" failed to configure properly" >&2;}
+    if test "$with_mpdc_fw" = "verbs" ; then
+        { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: cci plugin \"verbs\" failed to configure properly" >&5
+$as_echo "$as_me: WARNING: cci plugin \"verbs\" failed to configure properly" >&2;}
         { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: This plugin was selected as the default" >&5
 $as_echo "$as_me: WARNING: This plugin was selected as the default" >&2;}
         as_fn_error $? "Cannot continue" "$LINENO" 5
@@ -12463,23 +12463,23 @@
     fi
 
            # add plugin to all plugin list
-           all_plugins="$all_plugins sm"
+           all_plugins="$all_plugins verbs"
 fi
 
 
 
     # set the AM_CONDITIONAL on how we should build
     if test "$compile_mode" = "dso"; then :
-  BUILD_cci_ctp_sm_DSO=1
+  BUILD_cci_ctp_verbs_DSO=1
 else
-  BUILD_cci_ctp_sm_DSO=0
+  BUILD_cci_ctp_verbs_DSO=0
 fi
-     if test "$BUILD_cci_ctp_sm_DSO" = "1"; then
-  CCI_BUILD_cci_ctp_sm_DSO_TRUE=
-  CCI_BUILD_cci_ctp_sm_DSO_FALSE='#'
+     if test "$BUILD_cci_ctp_verbs_DSO" = "1"; then
+  CCI_BUILD_cci_ctp_verbs_DSO_TRUE=
+  CCI_BUILD_cci_ctp_verbs_DSO_FALSE='#'
 else
-  CCI_BUILD_cci_ctp_sm_DSO_TRUE='#'
-  CCI_BUILD_cci_ctp_sm_DSO_FALSE=
+  CCI_BUILD_cci_ctp_verbs_DSO_TRUE='#'
+  CCI_BUILD_cci_ctp_verbs_DSO_FALSE=
 fi
 
 
@@ -12610,8 +12610,8 @@
 fi
 
 if test -n "$with_ltdl_include"; then
-    { $as_echo "$as_me:${as_lineno-$LINENO}: checking for ltld.h" >&5
-$as_echo_n "checking for ltld.h... " >&6; }
+    { $as_echo "$as_me:${as_lineno-$LINENO}: checking for ltdl.h" >&5
+$as_echo_n "checking for ltdl.h... " >&6; }
     if test -f "$with_ltdl_include/ltdl.h"; then
         { $as_echo "$as_me:${as_lineno-$LINENO}: result: $with_ltdl_include" >&5
 $as_echo "$with_ltdl_include" >&6; }
@@ -12634,8 +12634,8 @@
 fi
 
 if test -n "$with_ltdl_lib"; then
-    { $as_echo "$as_me:${as_lineno-$LINENO}: checking for libltld" >&5
-$as_echo_n "checking for libltld... " >&6; }
+    { $as_echo "$as_me:${as_lineno-$LINENO}: checking for libltdl" >&5
+$as_echo_n "checking for libltdl... " >&6; }
     if test -f "$with_ltdl_lib/libltdl.la"; then
         { $as_echo "$as_me:${as_lineno-$LINENO}: result: $with_ltdl_lib" >&5
 $as_echo "$with_ltdl_lib" >&6; }
@@ -12695,8 +12695,8 @@
 
 echo "toto $with_ltdl_include $with_included_ltdl"
 if test x"$with_ltdl_include" = x"no" -a x"$with_included_ltdl" = x"no"; then
-    { $as_echo "$as_me:${as_lineno-$LINENO}: checking for ltld.h" >&5
-$as_echo_n "checking for ltld.h... " >&6; }
+    { $as_echo "$as_me:${as_lineno-$LINENO}: checking for ltdl.h" >&5
+$as_echo_n "checking for ltdl.h... " >&6; }
     ac_fn_c_check_header_mongrel "$LINENO" "ltdl.h" "ac_cv_header_ltdl_h" "$ac_includes_default"
 if test "x$ac_cv_header_ltdl_h" = xyes; then :
   { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
@@ -12711,8 +12711,8 @@
 echo "titi"
 
 if test x"$with_ltdl_lib" = x"no" -a x"$with_included_ltdl" = x"no"; then
-    { $as_echo "$as_me:${as_lineno-$LINENO}: checking for libltld" >&5
-$as_echo_n "checking for libltld... " >&6; }
+    { $as_echo "$as_me:${as_lineno-$LINENO}: checking for libltdl" >&5
+$as_echo_n "checking for libltdl... " >&6; }
     { $as_echo "$as_me:${as_lineno-$LINENO}: checking for lt_dladvise_init in -lltdl" >&5
 $as_echo_n "checking for lt_dladvise_init in -lltdl... " >&6; }
 if ${ac_cv_lib_ltdl_lt_dladvise_init+:} false; then :
@@ -13340,7 +13340,7 @@
   if $GREP 'External.*some_variable' conftest.out > /dev/null; then
     lt_cv_nm_interface="MS dumpbin"
   fi
-  rm -rf conftest*
+  rm -f conftest*
 fi
 { $as_echo "$as_me:${as_lineno-$LINENO}: result: $lt_cv_nm_interface" >&5
 $as_echo "$lt_cv_nm_interface" >&6; }
@@ -14714,7 +14714,7 @@
   # Check to see that the pipe works correctly.
   pipe_works=no
 
-  rm -rf conftest*
+  rm -f conftest*
   cat > conftest.$ac_ext <<_LT_EOF
 #ifdef __cplusplus
 extern "C" {
@@ -15377,7 +15377,7 @@
   if $GREP 'Manifest Tool' conftest.out > /dev/null; then
     lt_cv_path_mainfest_tool=yes
   fi
-  rm -rf conftest*
+  rm -f conftest*
 fi
 { $as_echo "$as_me:${as_lineno-$LINENO}: result: $lt_cv_path_mainfest_tool" >&5
 $as_echo "$lt_cv_path_mainfest_tool" >&6; }
@@ -16503,7 +16503,7 @@
 echo "$lt_simple_compile_test_code" >conftest.$ac_ext
 eval "$ac_compile" 2>&1 >/dev/null | $SED '/^$/d; /^ *+/d' >conftest.err
 _lt_compiler_boilerplate=`cat conftest.err`
-$RM -r conftest*
+$RM conftest*
 
 ac_outfile=conftest.$ac_objext
 echo "$lt_simple_link_test_code" >conftest.$ac_ext
@@ -16560,7 +16560,7 @@
        lt_cv_prog_compiler_rtti_exceptions=yes
      fi
    fi
-   $RM -r conftest*
+   $RM conftest*
 
 fi
 { $as_echo "$as_me:${as_lineno-$LINENO}: result: $lt_cv_prog_compiler_rtti_exceptions" >&5
@@ -16968,7 +16968,7 @@
        lt_cv_prog_compiler_pic_works=yes
      fi
    fi
-   $RM -r conftest*
+   $RM conftest*
 
 fi
 { $as_echo "$as_me:${as_lineno-$LINENO}: result: $lt_cv_prog_compiler_pic_works" >&5
@@ -17080,14 +17080,14 @@
      fi
    fi
    chmod u+w . 2>&5
-   $RM -r conftest*
+   $RM conftest*
    # SGI C++ compiler will create directory out/ii_files/ for
    # template instantiation
    test -d out/ii_files && $RM out/ii_files/* && rmdir out/ii_files
    $RM out/* && rmdir out
    cd ..
    $RM -r conftest
-   $RM -r conftest*
+   $RM conftest*
 
 fi
 { $as_echo "$as_me:${as_lineno-$LINENO}: result: $lt_cv_prog_compiler_c_o" >&5
@@ -17135,14 +17135,14 @@
      fi
    fi
    chmod u+w . 2>&5
-   $RM -r conftest*
+   $RM conftest*
    # SGI C++ compiler will create directory out/ii_files/ for
    # template instantiation
    test -d out/ii_files && $RM out/ii_files/* && rmdir out/ii_files
    $RM out/* && rmdir out
    cd ..
    $RM -r conftest
-   $RM -r conftest*
+   $RM conftest*
 
 fi
 { $as_echo "$as_me:${as_lineno-$LINENO}: result: $lt_cv_prog_compiler_c_o" >&5
@@ -17157,7 +17157,7 @@
   { $as_echo "$as_me:${as_lineno-$LINENO}: checking if we can lock with hard links" >&5
 $as_echo_n "checking if we can lock with hard links... " >&6; }
   hard_links=yes
-  $RM -r conftest*
+  $RM conftest*
   ln conftest.a conftest.b 2>/dev/null && hard_links=no
   touch conftest.a
   ln conftest.a conftest.b 2>&5 || hard_links=no
@@ -18479,7 +18479,7 @@
 if ${lt_cv_archive_cmds_need_lc+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  $RM -r conftest*
+  $RM conftest*
 	echo "$lt_simple_compile_test_code" > conftest.$ac_ext
 
 	if { { eval echo "\"\$as_me\":${as_lineno-$LINENO}: \"$ac_compile\""; } >&5
@@ -18514,7 +18514,7 @@
 	else
 	  cat conftest.err 1>&5
 	fi
-	$RM -r conftest*
+	$RM conftest*
 
 fi
 { $as_echo "$as_me:${as_lineno-$LINENO}: result: $lt_cv_archive_cmds_need_lc" >&5
@@ -19277,6 +19277,9 @@
   # before this can be enabled.
   hardcode_into_libs=yes
 
+  # Add ABI-specific directories to the system library path.
+  sys_lib_dlsearch_path_spec="/lib64 /usr/lib64 /lib /usr/lib"
+
   # Ideally, we could use ldconfig to report *all* directores which are
   # searched for libraries, however this is still not possible.  Aside from not
   # being certain /sbin/ldconfig is available, command
@@ -19285,7 +19288,7 @@
   # appending ld.so.conf contents (and includes) to the search path.
   if test -f /etc/ld.so.conf; then
     lt_ld_extra=`awk '/^include / { system(sprintf("cd /etc; cat %s 2>/dev/null", \$2)); skip = 1; } { if (!skip) print \$0; skip = 0; }' < /etc/ld.so.conf | $SED -e 's/#.*//;/^[	 ]*hwcap[	 ]/d;s/[:,	]/ /g;s/=[^=]*$//;s/=[^= ]* / /g;s/"//g;/^$/d' | tr '\n' ' '`
-    sys_lib_dlsearch_path_spec="/lib /usr/lib $lt_ld_extra"
+    sys_lib_dlsearch_path_spec="$sys_lib_dlsearch_path_spec $lt_ld_extra"
   fi
 
   # We used to test for /lib/ld.so.1 and disable shared libraries on
@@ -20449,14 +20452,6 @@
   as_fn_error $? "conditional \"CCI_BUILD_cci_ctp_tcp_DSO\" was never defined.
 Usually this means the macro was only invoked conditionally." "$LINENO" 5
 fi
-if test -z "${CCI_BUILD_cci_ctp_verbs_DSO_TRUE}" && test -z "${CCI_BUILD_cci_ctp_verbs_DSO_FALSE}"; then
-  as_fn_error $? "conditional \"CCI_BUILD_cci_ctp_verbs_DSO\" was never defined.
-Usually this means the macro was only invoked conditionally." "$LINENO" 5
-fi
-if test -z "${CCI_BUILD_cci_ctp_eth_DSO_TRUE}" && test -z "${CCI_BUILD_cci_ctp_eth_DSO_FALSE}"; then
-  as_fn_error $? "conditional \"CCI_BUILD_cci_ctp_eth_DSO\" was never defined.
-Usually this means the macro was only invoked conditionally." "$LINENO" 5
-fi
 if test -z "${CCI_BUILD_cci_ctp_gni_DSO_TRUE}" && test -z "${CCI_BUILD_cci_ctp_gni_DSO_FALSE}"; then
   as_fn_error $? "conditional \"CCI_BUILD_cci_ctp_gni_DSO\" was never defined.
 Usually this means the macro was only invoked conditionally." "$LINENO" 5
@@ -20465,6 +20460,14 @@
   as_fn_error $? "conditional \"CCI_BUILD_cci_ctp_sm_DSO\" was never defined.
 Usually this means the macro was only invoked conditionally." "$LINENO" 5
 fi
+if test -z "${CCI_BUILD_cci_ctp_eth_DSO_TRUE}" && test -z "${CCI_BUILD_cci_ctp_eth_DSO_FALSE}"; then
+  as_fn_error $? "conditional \"CCI_BUILD_cci_ctp_eth_DSO\" was never defined.
+Usually this means the macro was only invoked conditionally." "$LINENO" 5
+fi
+if test -z "${CCI_BUILD_cci_ctp_verbs_DSO_TRUE}" && test -z "${CCI_BUILD_cci_ctp_verbs_DSO_FALSE}"; then
+  as_fn_error $? "conditional \"CCI_BUILD_cci_ctp_verbs_DSO\" was never defined.
+Usually this means the macro was only invoked conditionally." "$LINENO" 5
+fi
 
 : "${CONFIG_STATUS=./config.status}"
 ac_write_fail=0
@@ -21352,12 +21355,12 @@
     "examples/Makefile") CONFIG_FILES="$CONFIG_FILES examples/Makefile" ;;
     "cci.pc") CONFIG_FILES="$CONFIG_FILES cci.pc" ;;
     "src/plugins/ctp/Makefile") CONFIG_FILES="$CONFIG_FILES src/plugins/ctp/Makefile" ;;
-    "src/plugins/ctp/verbs/Makefile") CONFIG_FILES="$CONFIG_FILES src/plugins/ctp/verbs/Makefile" ;;
-    "src/plugins/ctp/eth/Makefile") CONFIG_FILES="$CONFIG_FILES src/plugins/ctp/eth/Makefile" ;;
-    "src/plugins/ctp/sock/Makefile") CONFIG_FILES="$CONFIG_FILES src/plugins/ctp/sock/Makefile" ;;
     "src/plugins/ctp/gni/Makefile") CONFIG_FILES="$CONFIG_FILES src/plugins/ctp/gni/Makefile" ;;
-    "src/plugins/ctp/tcp/Makefile") CONFIG_FILES="$CONFIG_FILES src/plugins/ctp/tcp/Makefile" ;;
     "src/plugins/ctp/sm/Makefile") CONFIG_FILES="$CONFIG_FILES src/plugins/ctp/sm/Makefile" ;;
+    "src/plugins/ctp/sock/Makefile") CONFIG_FILES="$CONFIG_FILES src/plugins/ctp/sock/Makefile" ;;
+    "src/plugins/ctp/eth/Makefile") CONFIG_FILES="$CONFIG_FILES src/plugins/ctp/eth/Makefile" ;;
+    "src/plugins/ctp/tcp/Makefile") CONFIG_FILES="$CONFIG_FILES src/plugins/ctp/tcp/Makefile" ;;
+    "src/plugins/ctp/verbs/Makefile") CONFIG_FILES="$CONFIG_FILES src/plugins/ctp/verbs/Makefile" ;;
     "libtool") CONFIG_COMMANDS="$CONFIG_COMMANDS libtool" ;;
 
   *) as_fn_error $? "invalid argument: \`$ac_config_target'" "$LINENO" 5;;
diff -uNr cci-2.0/configure.ac cci-2.0-patch/configure.ac
--- cci-2.0/configure.ac	2016-06-28 12:56:52.000000000 -0500
+++ cci-2.0-patch/configure.ac	2017-03-02 00:36:35.863758664 -0600
@@ -18,7 +18,7 @@
 # -I in ACLOCAL_AMFLAGS in the top-level Makefile.am.
 AC_CONFIG_MACRO_DIR([./config])
 
-AC_CHECK_HEADERS([include/ltdl.h])
+AC_CHECK_HEADERS([ltdl.h])
 AC_SEARCH_LIBS([lt_dlopen],[ltdl])
 
 # Define $target
@@ -163,7 +163,7 @@
     [AS_HELP_STRING([--with-ltdl-include=DIR],
                     [use the ltdl headers installed in DIR])])
 if test -n "$with_ltdl_include"; then
-    AC_MSG_CHECKING([for ltld.h])
+    AC_MSG_CHECKING([for ltdl.h])
     if test -f "$with_ltdl_include/ltdl.h"; then
         AC_MSG_RESULT([$with_ltdl_include])
         LTDLINCL="-I$with_ltdl_include"
@@ -182,7 +182,7 @@
     [AS_HELP_STRING([--with-ltdl-lib=DIR],
                     [use the ltdl library installed in DIR])])
 if test -n "$with_ltdl_lib"; then
-    AC_MSG_CHECKING([for libltld])
+    AC_MSG_CHECKING([for libltdl])
     if test -f "$with_ltdl_lib/libltdl.la"; then
         AC_MSG_RESULT([$with_ltdl_lib])
         LIBLTDL="-L$with_ltdl_lib -lltdl"
@@ -235,7 +235,7 @@
 dnl if the headers are available on the system by default.
 echo "toto $with_ltdl_include $with_included_ltdl"
 if test x"$with_ltdl_include" = x"no" -a x"$with_included_ltdl" = x"no"; then
-    AC_MSG_CHECKING([for ltld.h])
+    AC_MSG_CHECKING([for ltdl.h])
     AC_CHECK_HEADER([ltdl.h],
                     [AC_MSG_RESULT([yes])],
                     [AC_MSG_ERROR([ltdl headers not available]),
@@ -247,7 +247,7 @@
 dnl if the library is available on the system by default. Note that by checking
 dnl for lt_dladvise_init, we check whether libtool 2.2 or newer is installed
 if test x"$with_ltdl_lib" = x"no" -a x"$with_included_ltdl" = x"no"; then
-    AC_MSG_CHECKING([for libltld])
+    AC_MSG_CHECKING([for libltdl])
     AC_CHECK_LIB([ltdl],
                  [lt_dladvise_init],
                  [(LIBLTDL=-lltdl
diff -uNr cci-2.0/examples/Makefile.in cci-2.0-patch/examples/Makefile.in
--- cci-2.0/examples/Makefile.in	2016-06-28 12:58:04.000000000 -0500
+++ cci-2.0-patch/examples/Makefile.in	2017-03-02 00:37:06.879928890 -0600
@@ -113,10 +113,10 @@
 	$(top_srcdir)/config/ltversion.m4 \
 	$(top_srcdir)/config/lt~obsolete.m4 \
 	$(top_srcdir)/config/autogen_found_items.m4 \
-	$(top_srcdir)/src/plugins/ctp/verbs/configure.m4 \
-	$(top_srcdir)/src/plugins/ctp/eth/configure.m4 \
 	$(top_srcdir)/src/plugins/ctp/gni/configure.m4 \
 	$(top_srcdir)/src/plugins/ctp/sm/configure.m4 \
+	$(top_srcdir)/src/plugins/ctp/eth/configure.m4 \
+	$(top_srcdir)/src/plugins/ctp/verbs/configure.m4 \
 	$(top_srcdir)/configure.ac
 am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
 	$(ACLOCAL_M4)
diff -uNr cci-2.0/include/cci/configure_output.h.in cci-2.0-patch/include/cci/configure_output.h.in
--- cci-2.0/include/cci/configure_output.h.in	2016-06-28 12:58:03.000000000 -0500
+++ cci-2.0-patch/include/cci/configure_output.h.in	2017-03-02 00:37:06.000000000 -0600
@@ -121,12 +121,12 @@
 /* Define to 1 if you have the <ifaddrs.h> header file. */
 #undef HAVE_IFADDRS_H
 
-/* Define to 1 if you have the <include/ltdl.h> header file. */
-#undef HAVE_INCLUDE_LTDL_H
-
 /* Define to 1 if you have the <inttypes.h> header file. */
 #undef HAVE_INTTYPES_H
 
+/* Define to 1 if you have the <ltdl.h> header file. */
+#undef HAVE_LTDL_H
+
 /* Define to 1 if you have the <memory.h> header file. */
 #undef HAVE_MEMORY_H
 
diff -uNr cci-2.0/include/cci/configure_output.h.in~ cci-2.0-patch/include/cci/configure_output.h.in~
--- cci-2.0/include/cci/configure_output.h.in~	1969-12-31 18:00:00.000000000 -0600
+++ cci-2.0-patch/include/cci/configure_output.h.in~	2016-06-28 12:58:03.000000000 -0500
@@ -0,0 +1,201 @@
+/* include/cci/configure_output.h.in.  Generated from configure.ac by autoheader.  */
+
+/* -*- c -*-
+ *
+ * Copyright © 2010 Cisco Systems, Inc.  All rights reserved.
+ * $COPYRIGHT$
+ * 
+ * Additional copyrights may follow
+ * 
+ * $HEADER$
+ *
+ * This file is automatically generated by configure.  Edits will be lost
+ * the next time you run configure!
+ */
+
+#ifndef CCI_CONFIGURE_H
+#define CCI_CONFIGURE_H
+
+
+/* Whether your compiler has __attribute__ or not */
+#undef CCI_HAVE_ATTRIBUTE
+
+/* Whether your compiler has __attribute__ aligned or not */
+#undef CCI_HAVE_ATTRIBUTE_ALIGNED
+
+/* Whether your compiler has __attribute__ always_inline or not */
+#undef CCI_HAVE_ATTRIBUTE_ALWAYS_INLINE
+
+/* Whether your compiler has __attribute__ cold or not */
+#undef CCI_HAVE_ATTRIBUTE_COLD
+
+/* Whether your compiler has __attribute__ const or not */
+#undef CCI_HAVE_ATTRIBUTE_CONST
+
+/* Whether your compiler has __attribute__ deprecated or not */
+#undef CCI_HAVE_ATTRIBUTE_DEPRECATED
+
+/* Whether your compiler has __attribute__ format or not */
+#undef CCI_HAVE_ATTRIBUTE_FORMAT
+
+/* Whether your compiler has __attribute__ hot or not */
+#undef CCI_HAVE_ATTRIBUTE_HOT
+
+/* Whether your compiler has __attribute__ malloc or not */
+#undef CCI_HAVE_ATTRIBUTE_MALLOC
+
+/* Whether your compiler has __attribute__ may_alias or not */
+#undef CCI_HAVE_ATTRIBUTE_MAY_ALIAS
+
+/* Whether your compiler has __attribute__ nonnull or not */
+#undef CCI_HAVE_ATTRIBUTE_NONNULL
+
+/* Whether your compiler has __attribute__ noreturn or not */
+#undef CCI_HAVE_ATTRIBUTE_NORETURN
+
+/* Whether your compiler has __attribute__ no_instrument_function or not */
+#undef CCI_HAVE_ATTRIBUTE_NO_INSTRUMENT_FUNCTION
+
+/* Whether your compiler has __attribute__ packed or not */
+#undef CCI_HAVE_ATTRIBUTE_PACKED
+
+/* Whether your compiler has __attribute__ pure or not */
+#undef CCI_HAVE_ATTRIBUTE_PURE
+
+/* Whether your compiler has __attribute__ sentinel or not */
+#undef CCI_HAVE_ATTRIBUTE_SENTINEL
+
+/* Whether your compiler has __attribute__ unused or not */
+#undef CCI_HAVE_ATTRIBUTE_UNUSED
+
+/* Whether your compiler has __attribute__ warn unused result or not */
+#undef CCI_HAVE_ATTRIBUTE_WARN_UNUSED_RESULT
+
+/* Whether your compiler has __attribute__ weak alias or not */
+#undef CCI_HAVE_ATTRIBUTE_WEAK_ALIAS
+
+/* Whether C compiler supports -fvisibility */
+#undef CCI_HAVE_VISIBILITY
+
+/* Major version of cci */
+#undef CCI_MAJOR_VERSION
+
+/* Minor version of cci */
+#undef CCI_MINOR_VERSION
+
+/* pkglibdir from configure */
+#undef CCI_PKGLIBDIR
+
+/* Release version of cci */
+#undef CCI_RELEASE_VERSION
+
+/* CCI system COOKIE */
+#undef GNI_COOKIE
+
+/* CCI system PTAG */
+#undef GNI_PTAG
+
+/* Define if cma.h detected */
+#undef HAVE_CMA_H
+
+/* Define to 1 if you have the declaration of `ethtool_cmd_speed', and to 0 if
+   you don't. */
+#undef HAVE_DECL_ETHTOOL_CMD_SPEED
+
+/* Define to 1 if you have the declaration of `VALGRIND_MAKE_MEM_NOACCESS',
+   and to 0 if you don't. */
+#undef HAVE_DECL_VALGRIND_MAKE_MEM_NOACCESS
+
+/* Define to 1 if you have the <dlfcn.h> header file. */
+#undef HAVE_DLFCN_H
+
+/* Define to 1 if you have the `epoll_create' function. */
+#undef HAVE_EPOLL_CREATE
+
+/* Define to 1 if you have the <errno.h> header file. */
+#undef HAVE_ERRNO_H
+
+/* Define to 1 if you have the `getifaddrs' function. */
+#undef HAVE_GETIFADDRS
+
+/* Define to 1 if you have the <ifaddrs.h> header file. */
+#undef HAVE_IFADDRS_H
+
+/* Define to 1 if you have the <include/ltdl.h> header file. */
+#undef HAVE_INCLUDE_LTDL_H
+
+/* Define to 1 if you have the <inttypes.h> header file. */
+#undef HAVE_INTTYPES_H
+
+/* Define to 1 if you have the <memory.h> header file. */
+#undef HAVE_MEMORY_H
+
+/* Define if struct rdma_addrinfo detected */
+#undef HAVE_RDMA_ADDRINFO
+
+/* Define to 1 if you have the <stdint.h> header file. */
+#undef HAVE_STDINT_H
+
+/* Define to 1 if you have the <stdlib.h> header file. */
+#undef HAVE_STDLIB_H
+
+/* Define to 1 if you have the <strings.h> header file. */
+#undef HAVE_STRINGS_H
+
+/* Define to 1 if you have the <string.h> header file. */
+#undef HAVE_STRING_H
+
+/* Define to 1 if you have the <sys/epoll.h> header file. */
+#undef HAVE_SYS_EPOLL_H
+
+/* Define to 1 if you have the <sys/stat.h> header file. */
+#undef HAVE_SYS_STAT_H
+
+/* Define to 1 if you have the <sys/time.h> header file. */
+#undef HAVE_SYS_TIME_H
+
+/* Define to 1 if you have the <sys/types.h> header file. */
+#undef HAVE_SYS_TYPES_H
+
+/* Define to 1 if you have the <sys/uio.h> header file. */
+#undef HAVE_SYS_UIO_H
+
+/* Define to 1 if you have the <unistd.h> header file. */
+#undef HAVE_UNISTD_H
+
+/* Define if xpmem.h detected */
+#undef HAVE_XPMEM_H
+
+/* Define to the sub-directory where libtool stores uninstalled libraries. */
+#undef LT_OBJDIR
+
+/* Name of package */
+#undef PACKAGE
+
+/* Define to the address where bug reports for this package should be sent. */
+#undef PACKAGE_BUGREPORT
+
+/* Define to the full name of this package. */
+#undef PACKAGE_NAME
+
+/* Define to the full name and version of this package. */
+#undef PACKAGE_STRING
+
+/* Define to the one symbol short name of this package. */
+#undef PACKAGE_TARNAME
+
+/* Define to the home page for this package. */
+#undef PACKAGE_URL
+
+/* Define to the version of this package. */
+#undef PACKAGE_VERSION
+
+/* Define to 1 if you have the ANSI C header files. */
+#undef STDC_HEADERS
+
+/* Version number of package */
+#undef VERSION
+
+
+#endif /* CCI_CONFIGURE_H */
+
diff -uNr cci-2.0/include/cci_lib_types.h cci-2.0-patch/include/cci_lib_types.h
--- cci-2.0/include/cci_lib_types.h	2016-06-28 12:56:52.000000000 -0500
+++ cci-2.0-patch/include/cci_lib_types.h	2017-03-02 00:36:35.865758675 -0600
@@ -186,8 +186,8 @@
 	uint32_t flags;
 } cci__globals_t;
 
-extern pthread_mutex_t init_lock; /*! Protects initialized and globals during cci_init() and cci_finalize() */
-extern int initialized; /*! How many times cci_init() was called minus how many times cci_finalize() was called */
+extern pthread_mutex_t init_lock; /*! Protects cci_initialized and globals during cci_init() and cci_finalize() */
+extern int cci_initialized; /*! How many times cci_init() was called minus how many times cci_finalize() was called */
 extern cci__globals_t *globals;
 
 /*! Obtain the private struct from the public struct
diff -uNr cci-2.0/include/Makefile.in cci-2.0-patch/include/Makefile.in
--- cci-2.0/include/Makefile.in	2016-06-28 12:58:04.000000000 -0500
+++ cci-2.0-patch/include/Makefile.in	2017-03-02 00:37:06.906929038 -0600
@@ -111,10 +111,10 @@
 	$(top_srcdir)/config/ltversion.m4 \
 	$(top_srcdir)/config/lt~obsolete.m4 \
 	$(top_srcdir)/config/autogen_found_items.m4 \
-	$(top_srcdir)/src/plugins/ctp/verbs/configure.m4 \
-	$(top_srcdir)/src/plugins/ctp/eth/configure.m4 \
 	$(top_srcdir)/src/plugins/ctp/gni/configure.m4 \
 	$(top_srcdir)/src/plugins/ctp/sm/configure.m4 \
+	$(top_srcdir)/src/plugins/ctp/eth/configure.m4 \
+	$(top_srcdir)/src/plugins/ctp/verbs/configure.m4 \
 	$(top_srcdir)/configure.ac
 am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
 	$(ACLOCAL_M4)
diff -uNr cci-2.0/Makefile.in cci-2.0-patch/Makefile.in
--- cci-2.0/Makefile.in	2016-06-28 12:58:04.000000000 -0500
+++ cci-2.0-patch/Makefile.in	2017-03-02 00:37:06.841928681 -0600
@@ -111,10 +111,10 @@
 	$(top_srcdir)/config/ltversion.m4 \
 	$(top_srcdir)/config/lt~obsolete.m4 \
 	$(top_srcdir)/config/autogen_found_items.m4 \
-	$(top_srcdir)/src/plugins/ctp/verbs/configure.m4 \
-	$(top_srcdir)/src/plugins/ctp/eth/configure.m4 \
 	$(top_srcdir)/src/plugins/ctp/gni/configure.m4 \
 	$(top_srcdir)/src/plugins/ctp/sm/configure.m4 \
+	$(top_srcdir)/src/plugins/ctp/eth/configure.m4 \
+	$(top_srcdir)/src/plugins/ctp/verbs/configure.m4 \
 	$(top_srcdir)/configure.ac
 am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
 	$(ACLOCAL_M4)
@@ -713,7 +713,7 @@
 	  ! -type d ! -perm -444 -exec $(install_sh) -c -m a+r {} {} \; \
 	|| chmod -R a+r "$(distdir)"
 dist-gzip: distdir
-	tardir=$(distdir) && $(am__tar) | GZIP=$(GZIP_ENV) gzip -c >$(distdir).tar.gz
+	tardir=$(distdir) && $(am__tar) | eval GZIP= gzip $(GZIP_ENV) -c >$(distdir).tar.gz
 	$(am__post_remove_distdir)
 dist-bzip2: distdir
 	tardir=$(distdir) && $(am__tar) | BZIP2=$${BZIP2--9} bzip2 -c >$(distdir).tar.bz2
@@ -738,7 +738,7 @@
 	@echo WARNING: "Support for shar distribution archives is" \
 	               "deprecated." >&2
 	@echo WARNING: "It will be removed altogether in Automake 2.0" >&2
-	shar $(distdir) | GZIP=$(GZIP_ENV) gzip -c >$(distdir).shar.gz
+	shar $(distdir) | eval GZIP= gzip $(GZIP_ENV) -c >$(distdir).shar.gz
 	$(am__post_remove_distdir)
 
 dist-zip: distdir
@@ -756,7 +756,7 @@
 distcheck: dist
 	case '$(DIST_ARCHIVES)' in \
 	*.tar.gz*) \
-	  GZIP=$(GZIP_ENV) gzip -dc $(distdir).tar.gz | $(am__untar) ;;\
+	  eval GZIP= gzip $(GZIP_ENV) -dc $(distdir).tar.gz | $(am__untar) ;;\
 	*.tar.bz2*) \
 	  bzip2 -dc $(distdir).tar.bz2 | $(am__untar) ;;\
 	*.tar.lz*) \
@@ -766,7 +766,7 @@
 	*.tar.Z*) \
 	  uncompress -c $(distdir).tar.Z | $(am__untar) ;;\
 	*.shar.gz*) \
-	  GZIP=$(GZIP_ENV) gzip -dc $(distdir).shar.gz | unshar ;;\
+	  eval GZIP= gzip $(GZIP_ENV) -dc $(distdir).shar.gz | unshar ;;\
 	*.zip*) \
 	  unzip $(distdir).zip ;;\
 	esac
diff -uNr cci-2.0/src/api/finalize.c cci-2.0-patch/src/api/finalize.c
--- cci-2.0/src/api/finalize.c	2016-06-28 12:56:52.000000000 -0500
+++ cci-2.0-patch/src/api/finalize.c	2017-03-02 00:36:35.865758675 -0600
@@ -28,14 +28,14 @@
 
 	pthread_mutex_lock(&init_lock);
 
-	if (!initialized) {
-		/* not initialized */
+	if (!cci_initialized) {
+		/* not cci_initialized */
 		ret = CCI_ERROR;
 		goto out;
 	}
 
-	initialized--;
-	if (initialized > 0) {
+	cci_initialized--;
+	if (cci_initialized > 0) {
 		/* no-op, return SUCCESS */
 		goto out;
 	}
diff -uNr cci-2.0/src/api/init.c cci-2.0-patch/src/api/init.c
--- cci-2.0/src/api/init.c	2016-06-28 12:56:52.000000000 -0500
+++ cci-2.0-patch/src/api/init.c	2017-03-02 00:36:35.865758675 -0600
@@ -46,7 +46,7 @@
 
 int cci__debug = CCI_DB_DFLT;
 cci__globals_t *globals = NULL;
-int initialized = 0;
+int cci_initialized = 0;
 static pthread_once_t once = PTHREAD_ONCE_INIT;
 pthread_mutex_t init_lock;
 
@@ -572,7 +572,7 @@
 	pthread_once(&once, cci_lock_init);
 	pthread_mutex_lock(&init_lock);
 
-	if (0 == initialized) {
+	if (0 == cci_initialized) {
 		cci__dev_t *dev;
 		char *str;
 
@@ -666,13 +666,13 @@
 		pthread_mutex_unlock(&globals->lock);
 
 		/* success */
-		initialized++;
+		cci_initialized++;
 
 	} else {
-		/* already initialized */
+		/* already cci_initialized */
 		if (flags == globals->flags) {
 			/* same parameters, no-op */
-			initialized++;
+			cci_initialized++;
 		} else {
 			/* TODO */
 			/* if different, can we accomodate new params?
diff -uNr cci-2.0/src/api/Makefile.in cci-2.0-patch/src/api/Makefile.in
--- cci-2.0/src/api/Makefile.in	2016-06-28 12:58:05.000000000 -0500
+++ cci-2.0-patch/src/api/Makefile.in	2017-03-02 00:37:06.972929400 -0600
@@ -111,10 +111,10 @@
 	$(top_srcdir)/config/ltversion.m4 \
 	$(top_srcdir)/config/lt~obsolete.m4 \
 	$(top_srcdir)/config/autogen_found_items.m4 \
-	$(top_srcdir)/src/plugins/ctp/verbs/configure.m4 \
-	$(top_srcdir)/src/plugins/ctp/eth/configure.m4 \
 	$(top_srcdir)/src/plugins/ctp/gni/configure.m4 \
 	$(top_srcdir)/src/plugins/ctp/sm/configure.m4 \
+	$(top_srcdir)/src/plugins/ctp/eth/configure.m4 \
+	$(top_srcdir)/src/plugins/ctp/verbs/configure.m4 \
 	$(top_srcdir)/configure.ac
 am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
 	$(ACLOCAL_M4)
diff -uNr cci-2.0/src/Makefile.in cci-2.0-patch/src/Makefile.in
--- cci-2.0/src/Makefile.in	2016-06-28 12:58:04.000000000 -0500
+++ cci-2.0-patch/src/Makefile.in	2017-03-02 00:37:06.937929208 -0600
@@ -112,10 +112,10 @@
 	$(top_srcdir)/config/ltversion.m4 \
 	$(top_srcdir)/config/lt~obsolete.m4 \
 	$(top_srcdir)/config/autogen_found_items.m4 \
-	$(top_srcdir)/src/plugins/ctp/verbs/configure.m4 \
-	$(top_srcdir)/src/plugins/ctp/eth/configure.m4 \
 	$(top_srcdir)/src/plugins/ctp/gni/configure.m4 \
 	$(top_srcdir)/src/plugins/ctp/sm/configure.m4 \
+	$(top_srcdir)/src/plugins/ctp/eth/configure.m4 \
+	$(top_srcdir)/src/plugins/ctp/verbs/configure.m4 \
 	$(top_srcdir)/configure.ac
 am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
 	$(ACLOCAL_M4)
diff -uNr cci-2.0/src/openpa/confdb/config.guess cci-2.0-patch/src/openpa/confdb/config.guess
--- cci-2.0/src/openpa/confdb/config.guess	2016-06-28 12:57:59.000000000 -0500
+++ cci-2.0-patch/src/openpa/confdb/config.guess	2017-03-02 00:37:02.267903577 -0600
@@ -1,8 +1,8 @@
 #! /bin/sh
 # Attempt to guess a canonical system name.
-#   Copyright 1992-2014 Free Software Foundation, Inc.
+#   Copyright 1992-2015 Free Software Foundation, Inc.
 
-timestamp='2014-11-04'
+timestamp='2015-01-01'
 
 # This file is free software; you can redistribute it and/or modify it
 # under the terms of the GNU General Public License as published by
@@ -50,7 +50,7 @@
 GNU config.guess ($timestamp)
 
 Originally written by Per Bothner.
-Copyright 1992-2014 Free Software Foundation, Inc.
+Copyright 1992-2015 Free Software Foundation, Inc.
 
 This is free software; see the source for copying conditions.  There is NO
 warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE."
diff -uNr cci-2.0/src/openpa/confdb/config.sub cci-2.0-patch/src/openpa/confdb/config.sub
--- cci-2.0/src/openpa/confdb/config.sub	2016-06-28 12:57:59.000000000 -0500
+++ cci-2.0-patch/src/openpa/confdb/config.sub	2017-03-02 00:37:02.269903588 -0600
@@ -1,8 +1,8 @@
 #! /bin/sh
 # Configuration validation subroutine script.
-#   Copyright 1992-2014 Free Software Foundation, Inc.
+#   Copyright 1992-2015 Free Software Foundation, Inc.
 
-timestamp='2014-12-03'
+timestamp='2015-01-01'
 
 # This file is free software; you can redistribute it and/or modify it
 # under the terms of the GNU General Public License as published by
@@ -68,7 +68,7 @@
 version="\
 GNU config.sub ($timestamp)
 
-Copyright 1992-2014 Free Software Foundation, Inc.
+Copyright 1992-2015 Free Software Foundation, Inc.
 
 This is free software; see the source for copying conditions.  There is NO
 warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE."
@@ -260,7 +260,7 @@
 	| c4x | c8051 | clipper \
 	| d10v | d30v | dlx | dsp16xx \
 	| epiphany \
-	| fido | fr30 | frv \
+	| fido | fr30 | frv | ft32 \
 	| h8300 | h8500 | hppa | hppa1.[01] | hppa2.0 | hppa2.0[nw] | hppa64 \
 	| hexagon \
 	| i370 | i860 | i960 | ia64 \
@@ -1025,7 +1025,7 @@
 		;;
 	ppc64)	basic_machine=powerpc64-unknown
 		;;
-	ppc64-*) basic_machine=powerpc64-`echo $basic_machine | sed 's/^[^-]*-//'`
+	ppc64-* | ppc64p7-*) basic_machine=powerpc64-`echo $basic_machine | sed 's/^[^-]*-//'`
 		;;
 	ppc64le | powerpc64little | ppc64-le | powerpc64-little)
 		basic_machine=powerpc64le-unknown
diff -uNr cci-2.0/src/openpa/confdb/libtool.m4 cci-2.0-patch/src/openpa/confdb/libtool.m4
--- cci-2.0/src/openpa/confdb/libtool.m4	2016-06-28 12:57:55.000000000 -0500
+++ cci-2.0-patch/src/openpa/confdb/libtool.m4	2017-03-02 00:36:59.312887359 -0600
@@ -956,7 +956,7 @@
 echo "$lt_simple_compile_test_code" >conftest.$ac_ext
 eval "$ac_compile" 2>&1 >/dev/null | $SED '/^$/d; /^ *+/d' >conftest.err
 _lt_compiler_boilerplate=`cat conftest.err`
-$RM -r conftest*
+$RM conftest*
 ])# _LT_COMPILER_BOILERPLATE
 
 
@@ -1606,7 +1606,7 @@
        $2=yes
      fi
    fi
-   $RM -r conftest*
+   $RM conftest*
 ])
 
 if test yes = "[$]$2"; then
@@ -2090,14 +2090,14 @@
      fi
    fi
    chmod u+w . 2>&AS_MESSAGE_LOG_FD
-   $RM -r conftest*
+   $RM conftest*
    # SGI C++ compiler will create directory out/ii_files/ for
    # template instantiation
    test -d out/ii_files && $RM out/ii_files/* && rmdir out/ii_files
    $RM out/* && rmdir out
    cd ..
    $RM -r conftest
-   $RM -r conftest*
+   $RM conftest*
 ])
 _LT_TAGDECL([compiler_c_o], [lt_cv_prog_compiler_c_o], [1],
 	[Does compiler simultaneously support -c and -o options?])
@@ -2117,7 +2117,7 @@
   # do not overwrite the value of need_locks provided by the user
   AC_MSG_CHECKING([if we can lock with hard links])
   hard_links=yes
-  $RM -r conftest*
+  $RM conftest*
   ln conftest.a conftest.b 2>/dev/null && hard_links=no
   touch conftest.a
   ln conftest.a conftest.b 2>&5 || hard_links=no
@@ -2867,6 +2867,9 @@
   # before this can be enabled.
   hardcode_into_libs=yes
 
+  # Add ABI-specific directories to the system library path.
+  sys_lib_dlsearch_path_spec="/lib64 /usr/lib64 /lib /usr/lib"
+
   # Ideally, we could use ldconfig to report *all* directores which are
   # searched for libraries, however this is still not possible.  Aside from not
   # being certain /sbin/ldconfig is available, command
@@ -2875,7 +2878,7 @@
   # appending ld.so.conf contents (and includes) to the search path.
   if test -f /etc/ld.so.conf; then
     lt_ld_extra=`awk '/^include / { system(sprintf("cd /etc; cat %s 2>/dev/null", \[$]2)); skip = 1; } { if (!skip) print \[$]0; skip = 0; }' < /etc/ld.so.conf | $SED -e 's/#.*//;/^[	 ]*hwcap[	 ]/d;s/[:,	]/ /g;s/=[^=]*$//;s/=[^= ]* / /g;s/"//g;/^$/d' | tr '\n' ' '`
-    sys_lib_dlsearch_path_spec="/lib /usr/lib $lt_ld_extra"
+    sys_lib_dlsearch_path_spec="$sys_lib_dlsearch_path_spec $lt_ld_extra"
   fi
 
   # We used to test for /lib/ld.so.1 and disable shared libraries on
@@ -3747,7 +3750,7 @@
   if $GREP 'External.*some_variable' conftest.out > /dev/null; then
     lt_cv_nm_interface="MS dumpbin"
   fi
-  rm -rf conftest*])
+  rm -f conftest*])
 ])# LT_PATH_NM
 
 # Old names:
@@ -3811,7 +3814,7 @@
   if $GREP 'Manifest Tool' conftest.out > /dev/null; then
     lt_cv_path_mainfest_tool=yes
   fi
-  rm -rf conftest*])
+  rm -f conftest*])
 if test yes != "$lt_cv_path_mainfest_tool"; then
   MANIFEST_TOOL=:
 fi
@@ -4035,7 +4038,7 @@
   # Check to see that the pipe works correctly.
   pipe_works=no
 
-  rm -rf conftest*
+  rm -f conftest*
   cat > conftest.$ac_ext <<_LT_EOF
 #ifdef __cplusplus
 extern "C" {
@@ -6078,7 +6081,7 @@
       # to ld, don't add -lc before -lgcc.
       AC_CACHE_CHECK([whether -lc should be explicitly linked in],
 	[lt_cv_]_LT_TAGVAR(archive_cmds_need_lc, $1),
-	[$RM -r conftest*
+	[$RM conftest*
 	echo "$lt_simple_compile_test_code" > conftest.$ac_ext
 
 	if AC_TRY_EVAL(ac_compile) 2>conftest.err; then
@@ -6105,7 +6108,7 @@
 	else
 	  cat conftest.err 1>&5
 	fi
-	$RM -r conftest*
+	$RM conftest*
 	])
       _LT_TAGVAR(archive_cmds_need_lc, $1)=$lt_cv_[]_LT_TAGVAR(archive_cmds_need_lc, $1)
       ;;
diff -uNr cci-2.0/src/openpa/configure cci-2.0-patch/src/openpa/configure
--- cci-2.0/src/openpa/configure	2016-06-28 12:57:58.000000000 -0500
+++ cci-2.0-patch/src/openpa/configure	2017-03-02 00:37:01.274898127 -0600
@@ -5028,7 +5028,7 @@
   if $GREP 'External.*some_variable' conftest.out > /dev/null; then
     lt_cv_nm_interface="MS dumpbin"
   fi
-  rm -rf conftest*
+  rm -f conftest*
 fi
 { $as_echo "$as_me:${as_lineno-$LINENO}: result: $lt_cv_nm_interface" >&5
 $as_echo "$lt_cv_nm_interface" >&6; }
@@ -6402,7 +6402,7 @@
   # Check to see that the pipe works correctly.
   pipe_works=no
 
-  rm -rf conftest*
+  rm -f conftest*
   cat > conftest.$ac_ext <<_LT_EOF
 #ifdef __cplusplus
 extern "C" {
@@ -7065,7 +7065,7 @@
   if $GREP 'Manifest Tool' conftest.out > /dev/null; then
     lt_cv_path_mainfest_tool=yes
   fi
-  rm -rf conftest*
+  rm -f conftest*
 fi
 { $as_echo "$as_me:${as_lineno-$LINENO}: result: $lt_cv_path_mainfest_tool" >&5
 $as_echo "$lt_cv_path_mainfest_tool" >&6; }
@@ -8517,7 +8517,7 @@
 echo "$lt_simple_compile_test_code" >conftest.$ac_ext
 eval "$ac_compile" 2>&1 >/dev/null | $SED '/^$/d; /^ *+/d' >conftest.err
 _lt_compiler_boilerplate=`cat conftest.err`
-$RM -r conftest*
+$RM conftest*
 
 ac_outfile=conftest.$ac_objext
 echo "$lt_simple_link_test_code" >conftest.$ac_ext
@@ -8574,7 +8574,7 @@
        lt_cv_prog_compiler_rtti_exceptions=yes
      fi
    fi
-   $RM -r conftest*
+   $RM conftest*
 
 fi
 { $as_echo "$as_me:${as_lineno-$LINENO}: result: $lt_cv_prog_compiler_rtti_exceptions" >&5
@@ -8982,7 +8982,7 @@
        lt_cv_prog_compiler_pic_works=yes
      fi
    fi
-   $RM -r conftest*
+   $RM conftest*
 
 fi
 { $as_echo "$as_me:${as_lineno-$LINENO}: result: $lt_cv_prog_compiler_pic_works" >&5
@@ -9094,14 +9094,14 @@
      fi
    fi
    chmod u+w . 2>&5
-   $RM -r conftest*
+   $RM conftest*
    # SGI C++ compiler will create directory out/ii_files/ for
    # template instantiation
    test -d out/ii_files && $RM out/ii_files/* && rmdir out/ii_files
    $RM out/* && rmdir out
    cd ..
    $RM -r conftest
-   $RM -r conftest*
+   $RM conftest*
 
 fi
 { $as_echo "$as_me:${as_lineno-$LINENO}: result: $lt_cv_prog_compiler_c_o" >&5
@@ -9149,14 +9149,14 @@
      fi
    fi
    chmod u+w . 2>&5
-   $RM -r conftest*
+   $RM conftest*
    # SGI C++ compiler will create directory out/ii_files/ for
    # template instantiation
    test -d out/ii_files && $RM out/ii_files/* && rmdir out/ii_files
    $RM out/* && rmdir out
    cd ..
    $RM -r conftest
-   $RM -r conftest*
+   $RM conftest*
 
 fi
 { $as_echo "$as_me:${as_lineno-$LINENO}: result: $lt_cv_prog_compiler_c_o" >&5
@@ -9171,7 +9171,7 @@
   { $as_echo "$as_me:${as_lineno-$LINENO}: checking if we can lock with hard links" >&5
 $as_echo_n "checking if we can lock with hard links... " >&6; }
   hard_links=yes
-  $RM -r conftest*
+  $RM conftest*
   ln conftest.a conftest.b 2>/dev/null && hard_links=no
   touch conftest.a
   ln conftest.a conftest.b 2>&5 || hard_links=no
@@ -10493,7 +10493,7 @@
 if ${lt_cv_archive_cmds_need_lc+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  $RM -r conftest*
+  $RM conftest*
 	echo "$lt_simple_compile_test_code" > conftest.$ac_ext
 
 	if { { eval echo "\"\$as_me\":${as_lineno-$LINENO}: \"$ac_compile\""; } >&5
@@ -10528,7 +10528,7 @@
 	else
 	  cat conftest.err 1>&5
 	fi
-	$RM -r conftest*
+	$RM conftest*
 
 fi
 { $as_echo "$as_me:${as_lineno-$LINENO}: result: $lt_cv_archive_cmds_need_lc" >&5
@@ -11291,6 +11291,9 @@
   # before this can be enabled.
   hardcode_into_libs=yes
 
+  # Add ABI-specific directories to the system library path.
+  sys_lib_dlsearch_path_spec="/lib64 /usr/lib64 /lib /usr/lib"
+
   # Ideally, we could use ldconfig to report *all* directores which are
   # searched for libraries, however this is still not possible.  Aside from not
   # being certain /sbin/ldconfig is available, command
@@ -11299,7 +11302,7 @@
   # appending ld.so.conf contents (and includes) to the search path.
   if test -f /etc/ld.so.conf; then
     lt_ld_extra=`awk '/^include / { system(sprintf("cd /etc; cat %s 2>/dev/null", \$2)); skip = 1; } { if (!skip) print \$0; skip = 0; }' < /etc/ld.so.conf | $SED -e 's/#.*//;/^[	 ]*hwcap[	 ]/d;s/[:,	]/ /g;s/=[^=]*$//;s/=[^= ]* / /g;s/"//g;/^$/d' | tr '\n' ' '`
-    sys_lib_dlsearch_path_spec="/lib /usr/lib $lt_ld_extra"
+    sys_lib_dlsearch_path_spec="$sys_lib_dlsearch_path_spec $lt_ld_extra"
   fi
 
   # We used to test for /lib/ld.so.1 and disable shared libraries on
diff -uNr cci-2.0/src/openpa/Makefile.in cci-2.0-patch/src/openpa/Makefile.in
--- cci-2.0/src/openpa/Makefile.in	2016-06-28 12:57:59.000000000 -0500
+++ cci-2.0-patch/src/openpa/Makefile.in	2017-03-02 00:37:02.314903835 -0600
@@ -620,7 +620,7 @@
 	  ! -type d ! -perm -444 -exec $(install_sh) -c -m a+r {} {} \; \
 	|| chmod -R a+r "$(distdir)"
 dist-gzip: distdir
-	tardir=$(distdir) && $(am__tar) | GZIP=$(GZIP_ENV) gzip -c >$(distdir).tar.gz
+	tardir=$(distdir) && $(am__tar) | eval GZIP= gzip $(GZIP_ENV) -c >$(distdir).tar.gz
 	$(am__post_remove_distdir)
 
 dist-bzip2: distdir
@@ -646,7 +646,7 @@
 	@echo WARNING: "Support for shar distribution archives is" \
 	               "deprecated." >&2
 	@echo WARNING: "It will be removed altogether in Automake 2.0" >&2
-	shar $(distdir) | GZIP=$(GZIP_ENV) gzip -c >$(distdir).shar.gz
+	shar $(distdir) | eval GZIP= gzip $(GZIP_ENV) -c >$(distdir).shar.gz
 	$(am__post_remove_distdir)
 
 dist-zip: distdir
@@ -664,7 +664,7 @@
 distcheck: dist
 	case '$(DIST_ARCHIVES)' in \
 	*.tar.gz*) \
-	  GZIP=$(GZIP_ENV) gzip -dc $(distdir).tar.gz | $(am__untar) ;;\
+	  eval GZIP= gzip $(GZIP_ENV) -dc $(distdir).tar.gz | $(am__untar) ;;\
 	*.tar.bz2*) \
 	  bzip2 -dc $(distdir).tar.bz2 | $(am__untar) ;;\
 	*.tar.lz*) \
@@ -674,7 +674,7 @@
 	*.tar.Z*) \
 	  uncompress -c $(distdir).tar.Z | $(am__untar) ;;\
 	*.shar.gz*) \
-	  GZIP=$(GZIP_ENV) gzip -dc $(distdir).shar.gz | unshar ;;\
+	  eval GZIP= gzip $(GZIP_ENV) -dc $(distdir).shar.gz | unshar ;;\
 	*.zip*) \
 	  unzip $(distdir).zip ;;\
 	esac
diff -uNr cci-2.0/src/plugins/base/Makefile.in cci-2.0-patch/src/plugins/base/Makefile.in
--- cci-2.0/src/plugins/base/Makefile.in	2016-06-28 12:58:05.000000000 -0500
+++ cci-2.0-patch/src/plugins/base/Makefile.in	2017-03-02 00:37:07.008929598 -0600
@@ -111,10 +111,10 @@
 	$(top_srcdir)/config/ltversion.m4 \
 	$(top_srcdir)/config/lt~obsolete.m4 \
 	$(top_srcdir)/config/autogen_found_items.m4 \
-	$(top_srcdir)/src/plugins/ctp/verbs/configure.m4 \
-	$(top_srcdir)/src/plugins/ctp/eth/configure.m4 \
 	$(top_srcdir)/src/plugins/ctp/gni/configure.m4 \
 	$(top_srcdir)/src/plugins/ctp/sm/configure.m4 \
+	$(top_srcdir)/src/plugins/ctp/eth/configure.m4 \
+	$(top_srcdir)/src/plugins/ctp/verbs/configure.m4 \
 	$(top_srcdir)/configure.ac
 am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
 	$(ACLOCAL_M4)
diff -uNr cci-2.0/src/plugins/ctp/eth/Makefile.in cci-2.0-patch/src/plugins/ctp/eth/Makefile.in
--- cci-2.0/src/plugins/ctp/eth/Makefile.in	2016-06-28 12:58:05.000000000 -0500
+++ cci-2.0-patch/src/plugins/ctp/eth/Makefile.in	2017-03-02 00:37:07.080929993 -0600
@@ -112,10 +112,10 @@
 	$(top_srcdir)/config/ltversion.m4 \
 	$(top_srcdir)/config/lt~obsolete.m4 \
 	$(top_srcdir)/config/autogen_found_items.m4 \
-	$(top_srcdir)/src/plugins/ctp/verbs/configure.m4 \
-	$(top_srcdir)/src/plugins/ctp/eth/configure.m4 \
 	$(top_srcdir)/src/plugins/ctp/gni/configure.m4 \
 	$(top_srcdir)/src/plugins/ctp/sm/configure.m4 \
+	$(top_srcdir)/src/plugins/ctp/eth/configure.m4 \
+	$(top_srcdir)/src/plugins/ctp/verbs/configure.m4 \
 	$(top_srcdir)/configure.ac
 am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
 	$(ACLOCAL_M4)
diff -uNr cci-2.0/src/plugins/ctp/gni/ctp_gni_api.c cci-2.0-patch/src/plugins/ctp/gni/ctp_gni_api.c
--- cci-2.0/src/plugins/ctp/gni/ctp_gni_api.c	2016-06-28 12:56:52.000000000 -0500
+++ cci-2.0-patch/src/plugins/ctp/gni/ctp_gni_api.c	2017-03-02 00:36:35.866758680 -0600
@@ -520,13 +520,13 @@
 							       0);
 				} else if (0 == strncmp("interface=", *arg, 10)) {
 					interface = (void *) ((uintptr_t)*arg + 10);
-				} else if (0 == strncmp("ptag=", *arg, 10)) {
+				} else if (0 == strncmp("ptag=", *arg, 5)) {
 					ptag = (void *) ((uintptr_t) *arg + 5);
 					gdev->ptag = strtoul(ptag, NULL, 0);
-				} else if (0 == strncmp("cookie=", *arg, 10)) {
+				} else if (0 == strncmp("cookie=", *arg, 7)) {
 					cookie = (void *) ((uintptr_t) *arg + 7);
 					gdev->cookie = strtoul(cookie, NULL, 0);
-				} else if (0 == strncmp("transport=", *arg, 7)) {
+				} else if (0 == strncmp("transport=", *arg, 10)) {
 					/* do nothing */
 				} else {
 					debug(CCI_DB_INFO, "unknown keyword %s",
@@ -815,7 +815,7 @@
 		__func__, port, gdev->ptag, gdev->cookie);
 
 	grc = GNI_CdmCreate(port, gdev->ptag, gdev->cookie,
-			0, &gep->cdm);
+			GNI_CDM_MODE_BTE_SINGLE_CHANNEL, &gep->cdm);
 	if (grc) {
 		ret = gni_to_cci_status(grc);
 		debug(CCI_DB_EP, "%s: GNI_CdmCreate() failed with %u (%u)",
@@ -1390,7 +1390,7 @@
 
 	grc = GNI_MemRegister(gep->nic, (uintptr_t) gconn->msg_buffer,
 			gconn->buff_size, gep->rx_cq,
-			GNI_MEM_RELAXED_PI_ORDERING | GNI_MEM_READWRITE,
+			GNI_MEM_READWRITE,
 			-1, &gconn->mem_hndl);
 	if (grc) {
 		ret = gni_to_cci_status(grc);
@@ -1711,7 +1711,7 @@
 
 	grc = GNI_MemRegister(gep->nic, (uintptr_t) gconn->msg_buffer,
 			gconn->buff_size, gep->rx_cq,
-			GNI_MEM_RELAXED_PI_ORDERING | GNI_MEM_READWRITE,
+			GNI_MEM_READWRITE,
 			-1, &gconn->mem_hndl);
 	if (grc) {
 		ret = gni_to_cci_status(grc);
@@ -3458,7 +3458,7 @@
 	gni_ep_t *gep = ep->priv;
 	gni_rma_handle_t *handle = NULL;
 	gni_return_t grc = GNI_RC_SUCCESS;
-	uint32_t gflags = GNI_MEM_RELAXED_PI_ORDERING;
+	uint32_t gflags = 0;
 
 	CCI_ENTER;
 
@@ -3547,6 +3547,8 @@
 
 	CCI_ENTER;
 
+	debug(CCI_DB_MSG, "%s: posting rma_op %p", __func__, rma_op);
+
 	rma_op->pd.remote_addr = rma_op->remote_handle->stuff[0] + rma_op->remote_offset;
 	rma_op->pd.remote_mem_hndl.qword1 = rma_op->remote_handle->stuff[1];
 	rma_op->pd.remote_mem_hndl.qword2 = rma_op->remote_handle->stuff[2];
@@ -3583,7 +3585,7 @@
 		}
 		rma_op->pd.length = new_len;
 		grc = GNI_MemRegister(gep->nic, (uintptr_t) rma_op->buf,
-			new_len, NULL, GNI_MEM_RELAXED_PI_ORDERING| GNI_MEM_READWRITE,
+			new_len, NULL, GNI_MEM_READWRITE,
 			-1, &rma_op->pd.local_mem_hndl);
 		if (grc) {
 			ret = gni_to_cci_status(grc);
@@ -3604,7 +3606,7 @@
 	if (grc) {
 		ret = gni_to_cci_status(grc);
 		debug(CCI_DB_MSG, "%s: PostRdma() failed with %s (%d) len %"PRIu64,
-			__func__, cci_strerror(&ep->endpoint, grc), grc, rma_op->pd.length);
+			__func__, cci_strerror(&ep->endpoint, ret), grc, rma_op->pd.length);
 	}
 
 out:
@@ -3687,6 +3689,7 @@
 
 	rma_op->pd.type = flags & CCI_FLAG_WRITE ? GNI_POST_RDMA_PUT :
 				GNI_POST_RDMA_GET;
+	//rma_op->pd.post_id = (uintptr_t) rma_op;
 	rma_op->pd.cq_mode = GNI_CQMODE_GLOBAL_EVENT;
 	/* NOTE: always use GNI_DLVMODE_PERFORMANCE. This round-robins over
 	 *       the three available DMA channels. GNI_DLVMODE_IN_ORDER
@@ -3697,6 +3700,7 @@
 	rma_op->pd.local_addr = (uintptr_t) local->addr + local_offset;
 	rma_op->pd.local_mem_hndl = local->mh;
 	rma_op->pd.length = data_len;
+	rma_op->pd.src_cq_hndl = gep->tx_cq; /* added for debug */
 
 	fence = flags & CCI_FLAG_FENCE;
 
diff -uNr cci-2.0/src/plugins/ctp/gni/Makefile.in cci-2.0-patch/src/plugins/ctp/gni/Makefile.in
--- cci-2.0/src/plugins/ctp/gni/Makefile.in	2016-06-28 12:58:05.000000000 -0500
+++ cci-2.0-patch/src/plugins/ctp/gni/Makefile.in	2017-03-02 00:37:07.115930185 -0600
@@ -111,10 +111,10 @@
 	$(top_srcdir)/config/ltversion.m4 \
 	$(top_srcdir)/config/lt~obsolete.m4 \
 	$(top_srcdir)/config/autogen_found_items.m4 \
-	$(top_srcdir)/src/plugins/ctp/verbs/configure.m4 \
-	$(top_srcdir)/src/plugins/ctp/eth/configure.m4 \
 	$(top_srcdir)/src/plugins/ctp/gni/configure.m4 \
 	$(top_srcdir)/src/plugins/ctp/sm/configure.m4 \
+	$(top_srcdir)/src/plugins/ctp/eth/configure.m4 \
+	$(top_srcdir)/src/plugins/ctp/verbs/configure.m4 \
 	$(top_srcdir)/configure.ac
 am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
 	$(ACLOCAL_M4)
diff -uNr cci-2.0/src/plugins/ctp/Makefile.in cci-2.0-patch/src/plugins/ctp/Makefile.in
--- cci-2.0/src/plugins/ctp/Makefile.in	2016-06-28 12:58:05.000000000 -0500
+++ cci-2.0-patch/src/plugins/ctp/Makefile.in	2017-03-02 00:37:07.045929801 -0600
@@ -129,10 +129,10 @@
 	$(top_srcdir)/config/ltversion.m4 \
 	$(top_srcdir)/config/lt~obsolete.m4 \
 	$(top_srcdir)/config/autogen_found_items.m4 \
-	$(top_srcdir)/src/plugins/ctp/verbs/configure.m4 \
-	$(top_srcdir)/src/plugins/ctp/eth/configure.m4 \
 	$(top_srcdir)/src/plugins/ctp/gni/configure.m4 \
 	$(top_srcdir)/src/plugins/ctp/sm/configure.m4 \
+	$(top_srcdir)/src/plugins/ctp/eth/configure.m4 \
+	$(top_srcdir)/src/plugins/ctp/verbs/configure.m4 \
 	$(top_srcdir)/configure.ac
 am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
 	$(ACLOCAL_M4)
diff -uNr cci-2.0/src/plugins/ctp/sm/ctp_sm_api.c cci-2.0-patch/src/plugins/ctp/sm/ctp_sm_api.c
--- cci-2.0/src/plugins/ctp/sm/ctp_sm_api.c	2016-06-28 12:56:52.000000000 -0500
+++ cci-2.0-patch/src/plugins/ctp/sm/ctp_sm_api.c	2017-03-02 00:36:35.867758686 -0600
@@ -211,6 +211,7 @@
 		if (ret) {
 			if (ret == EEXIST) {
 				/* it exists */
+				ret = 0;
 			} else if (ret == ENOENT) {
 				/* No, try to create it */
 				ret = mkdir(new, 0755);
@@ -220,6 +221,8 @@
 							strerror(errno));
 					ret = CCI_ERROR;
 					goto out;
+				} else {
+					ret = 0;
 				}
 			} else {
 				/* No, but we got another error.
@@ -320,6 +323,7 @@
 		if (ret)
 			goto out;
 
+		sdev->pid = pid;
 		sdev->id = 0;
 
 		device->up = 1;
@@ -622,12 +626,7 @@
 		if (!strcmp(dev->device.transport, "sm")) {
 			if (dev->priv) {
 				sm_dev_t *sdev = dev->priv;
-				int ret = 0;
 
-				ret = rmdir(sdev->path);
-				if (ret)
-					debug(CCI_DB_INFO, "%s: rmdir(%s) failed with %s",
-						__func__, sdev->path, strerror(errno));
 				free(sdev->path);
 				free(sdev->ids);
 			}
@@ -1323,15 +1322,37 @@
 sm_free_conn(cci__conn_t *conn)
 {
 	int ret = 0;
-	cci_connection_t *connection = &conn->connection;
-	cci__ep_t *ep = container_of(connection->endpoint, cci__ep_t, endpoint);
-	sm_ep_t *sep = ep->priv;
-	sm_conn_t *sconn = conn->priv;
+	cci_connection_t *connection = NULL;
+	cci__ep_t *ep = NULL;
+	sm_ep_t *sep = NULL;
+	sm_conn_t *sconn = NULL;
 
 	if (!conn)
 		return;
 
+	connection = &conn->connection;
+	ep = container_of(connection->endpoint, cci__ep_t, endpoint);
+	sep = ep->priv;
+	sconn = conn->priv;
+
 	if (sconn) {
+		int len = sizeof(*sconn->tx);
+
+		if (sconn->fifo != 0)
+			close(sconn->fifo);
+
+		if (sconn->mmap)
+			munmap(sconn->mmap, len);
+		if (sconn->peer_mmap)
+			munmap(sconn->peer_mmap, len);
+
+		len = sizeof(*sconn->rma);
+
+		if (sconn->rma_mmap)
+			munmap(sconn->rma_mmap, len);
+		if (sconn->peer_rma_mmap)
+			munmap(sconn->peer_rma_mmap, len);
+
 		free(sconn->name);
 		if (sconn->id != -1) {
 			ret = pthread_rwlock_wrlock(&sep->conns_lock);
@@ -1351,11 +1372,28 @@
 						tdelete(sconn, &sep->conns,
 								sm_compare_conns);
 					}
+					else {
+						debug(CCI_DB_WARN, "%s: tmp %p != sconn %p",
+								__func__,
+								(void*)tmp,
+								(void*)sconn);
+					}
+				}
+				else {
+					debug(CCI_DB_WARN, "%s: sconn %p not found",
+							__func__, (void*)sconn);
 				}
 				pthread_rwlock_unlock(&sep->conns_lock);
 			}
 			sm_put_conn_id(sconn);
 		}
+		else {
+			debug(CCI_DB_WARN, "%s: sconn %p id == -1",
+					__func__, (void*)sconn);
+		}
+		if (sconn->params)
+			free(sconn->params->data_ptr);
+		free(sconn->params);
 		free(sconn->rxs);
 		free(sconn->txs);
 		free(sconn);
@@ -1832,13 +1870,8 @@
 	debug(CCI_DB_CONN, "%s: connecting to %s", __func__, server_uri);
 
     out:
-	if (ret) {
-		if (params) {
-			free(params->data_ptr);
-			free(params);
-		}
+	if (ret)
 		sm_free_conn(conn);
-	}
 
 	CCI_EXIT;
 	return ret;
@@ -1954,9 +1987,7 @@
 		debug(CCI_DB_CONN, "%s: unable to service connect request from "
 			"%s (%s) - dropping message", __func__, uri,
 			cci_strerror(&ep->endpoint, ret));
-		if (conn) {
-			sm_free_conn(conn);
-		}
+		sm_free_conn(conn);
 		if (rx) {
 			free((void*)rx->event.request.data_ptr);
 			free(rx);
@@ -2036,6 +2067,7 @@
 
 	free(params->data_ptr);
 	free(params);
+	sconn->params = NULL;
 
 	evt->event.type = CCI_EVENT_CONNECT;
 	evt->event.connect.context = conn->connection.context;
@@ -2974,11 +3006,13 @@
 
 	sm_conn_notify(ep, conn);
 
-	if (!(flags & CCI_FLAG_SILENT)) {
+	if (!(flags & CCI_FLAG_SILENT) && !(flags & CCI_FLAG_BLOCKING)) {
 		pthread_mutex_lock(&ep->lock);
 		TAILQ_INSERT_TAIL(&ep->evts, evt, entry);
 		sm_ep_notify(ep);
 		pthread_mutex_unlock(&ep->lock);
+	} else {
+		sm_put_tx(evt);
 	}
 
     out:
@@ -3171,7 +3205,8 @@
 		debug(CCI_DB_MSG,
 			"%s: RMA length + offset exceeds remote registered length "
 			"(%"PRIu64" + %"PRIu64" > %"PRIu64")",
-			__func__, data_len, local_offset, sh->len);
+			__func__, data_len, local_offset,
+			remote_handle->stuff[2]);
 		ret = CCI_EINVAL;
 		goto out;
 	}
@@ -3258,10 +3293,21 @@
 				&local, 1, &remote, 1, 0);
 		}
 		if (rc != (ssize_t)data_len) {
-			ret = errno;
+			static int once = 0;
+
+			if (rc != -1) {
+				/* partial transfer - bad iovec segment */
+				ret = EFAULT;
+			} else {
+				ret = errno;
+			}
 			debug(CCI_DB_MSG, "%s: process_vm_%s() failed with %s",
 				__func__, flags & CCI_FLAG_WRITE ? "write" : "read",
 				strerror(ret));
+			if (once == 0 && ret == EPERM) {
+				debug(CCI_DB_WARN, "%s: process_vm_%s() failed because it cannot trace another process. See https://www.kernel.org/doc/Documentation/security/Yama.txt for more details.", __func__, flags & CCI_FLAG_WRITE ? "write" : "read");
+				once++;
+			}
 			goto out;
 		}
 
diff -uNr cci-2.0/src/plugins/ctp/sm/Makefile.in cci-2.0-patch/src/plugins/ctp/sm/Makefile.in
--- cci-2.0/src/plugins/ctp/sm/Makefile.in	2016-06-28 12:58:05.000000000 -0500
+++ cci-2.0-patch/src/plugins/ctp/sm/Makefile.in	2017-03-02 00:37:07.154930399 -0600
@@ -111,10 +111,10 @@
 	$(top_srcdir)/config/ltversion.m4 \
 	$(top_srcdir)/config/lt~obsolete.m4 \
 	$(top_srcdir)/config/autogen_found_items.m4 \
-	$(top_srcdir)/src/plugins/ctp/verbs/configure.m4 \
-	$(top_srcdir)/src/plugins/ctp/eth/configure.m4 \
 	$(top_srcdir)/src/plugins/ctp/gni/configure.m4 \
 	$(top_srcdir)/src/plugins/ctp/sm/configure.m4 \
+	$(top_srcdir)/src/plugins/ctp/eth/configure.m4 \
+	$(top_srcdir)/src/plugins/ctp/verbs/configure.m4 \
 	$(top_srcdir)/configure.ac
 am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
 	$(ACLOCAL_M4)
diff -uNr cci-2.0/src/plugins/ctp/sock/ctp_sock.h cci-2.0-patch/src/plugins/ctp/sock/ctp_sock.h
--- cci-2.0/src/plugins/ctp/sock/ctp_sock.h	2016-06-28 12:56:52.000000000 -0500
+++ cci-2.0-patch/src/plugins/ctp/sock/ctp_sock.h	2017-03-02 00:36:35.868758691 -0600
@@ -30,7 +30,7 @@
 #define SOCK_MAX_HDRS           (SOCK_MAX_HDR_SIZE + 20 + 8)	/* IP + UDP */
 #define SOCK_DEFAULT_MSS        (SOCK_UDP_MAX - SOCK_MAX_HDR_SIZE)	/* assume jumbo frames */
 #define SOCK_DEFAULT_RMA_MSS    (SOCK_DEFAULT_MSS - 20)
-#define SOCK_MIN_MSS            (1500 - SOCK_MAX_HDR_SIZE)
+#define SOCK_MIN_MSS            (1000 - SOCK_MAX_HDR_SIZE)
 #define SOCK_MAX_SACK           (4)	/* pairs of start/end acks */
 #define SOCK_ACK_DELAY          (1)	/* send an ack after every Nth send */
 #define SOCK_EP_TX_TIMEOUT_SEC  (64)	/* seconds for now */
diff -uNr cci-2.0/src/plugins/ctp/sock/Makefile.in cci-2.0-patch/src/plugins/ctp/sock/Makefile.in
--- cci-2.0/src/plugins/ctp/sock/Makefile.in	2016-06-28 12:58:05.000000000 -0500
+++ cci-2.0-patch/src/plugins/ctp/sock/Makefile.in	2017-03-02 00:37:07.189930591 -0600
@@ -112,10 +112,10 @@
 	$(top_srcdir)/config/ltversion.m4 \
 	$(top_srcdir)/config/lt~obsolete.m4 \
 	$(top_srcdir)/config/autogen_found_items.m4 \
-	$(top_srcdir)/src/plugins/ctp/verbs/configure.m4 \
-	$(top_srcdir)/src/plugins/ctp/eth/configure.m4 \
 	$(top_srcdir)/src/plugins/ctp/gni/configure.m4 \
 	$(top_srcdir)/src/plugins/ctp/sm/configure.m4 \
+	$(top_srcdir)/src/plugins/ctp/eth/configure.m4 \
+	$(top_srcdir)/src/plugins/ctp/verbs/configure.m4 \
 	$(top_srcdir)/configure.ac
 am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
 	$(ACLOCAL_M4)
diff -uNr cci-2.0/src/plugins/ctp/tcp/ctp_tcp_api.c cci-2.0-patch/src/plugins/ctp/tcp/ctp_tcp_api.c
--- cci-2.0/src/plugins/ctp/tcp/ctp_tcp_api.c	2016-06-28 12:56:52.000000000 -0500
+++ cci-2.0-patch/src/plugins/ctp/tcp/ctp_tcp_api.c	2017-03-02 00:36:35.869758697 -0600
@@ -10,6 +10,7 @@
  *
  */
 
+#define _GNU_SOURCE
 #include "cci/private_config.h"
 
 #include <stdio.h>
@@ -29,6 +30,7 @@
 #include <net/if.h>
 #include <ifaddrs.h>
 #endif
+#include <strings.h>
 
 #include "cci.h"
 #include "cci_lib_types.h"
@@ -97,7 +99,7 @@
 static int tcp_poll_events(cci__ep_t *ep);
 static int tcp_sendto(cci_os_handle_t sock, void *buf, int len,
 			void *rma_ptr, uint32_t rma_len, uintptr_t *offset);
-static inline void tcp_progress_conn_sends(cci__conn_t *conn);
+static inline void tcp_progress_conn_sends(cci__ep_t *ep, cci__conn_t *conn);
 
 
 /*
@@ -547,6 +549,9 @@
 static void
 conn_decref(cci__ep_t *ep, cci__conn_t *conn);
 
+static void
+release_pollfd(cci__ep_t *ep, tcp_conn_t *tconn);
+
 static int ctp_tcp_create_endpoint_at(cci_device_t * device,
 				      const char * service,
 				      int flags,
@@ -597,6 +602,20 @@
 
 	TAILQ_INIT(&tep->conns);
 
+	tep->blocks = 1;
+	tep->fd_bits = malloc(sizeof(*tep->fd_bits));
+	if (!tep->fd_bits) {
+		ret = CCI_ENOMEM;
+		goto out;
+	}
+	memset(tep->fd_bits, -1, sizeof(*tep->fd_bits));
+
+	tep->fds = calloc(64, sizeof(*tep->fds));
+	if (!tep->fds) {
+		ret = CCI_ENOMEM;
+		goto out;
+	}
+
 	TAILQ_INIT(&tep->idle_txs);
 	TAILQ_INIT(&tep->idle_rxs);
 	TAILQ_INIT(&tep->handles);
@@ -652,7 +671,7 @@
 	tconn = conn->priv;
 	tconn->status = TCP_CONN_PASSIVE1;
 	tconn->is_listener = 1;
-	tconn->pfd.events = POLLIN;
+	tconn->pfd->events = POLLIN;
 	queue_conn(ep, conn);
 
 	tep->tx_buf = calloc(1, ep->tx_buf_cnt * ep->buffer_len);
@@ -740,9 +759,9 @@
 			pthread_mutex_lock(&ep->lock);
 			TAILQ_REMOVE(&tep->conns, tconn, entry);
 			pthread_mutex_unlock(&ep->lock);
-			if (tconn->pfd.fd) {
-				close(tconn->pfd.fd);
-				tconn->pfd.fd = 0;
+			if (tconn->pfd->fd) {
+				close(tconn->pfd->fd);
+				release_pollfd(ep, tconn);
 			}
 		}
 		free((char*)conn->uri);
@@ -757,6 +776,9 @@
 		free(tep->rxs);
 		free(tep->rx_buf);
 
+		free(tep->fds);
+		free(tep->fd_bits);
+
 		if (sock)
 			tcp_close_socket(sock);
 		free(tep);
@@ -795,24 +817,22 @@
 	debug(CCI_DB_INFO, "%s: conn %p", __func__, (void*)conn);
 
 	pthread_mutex_lock(&ep->lock);
-	pthread_mutex_lock(&tconn->lock);
 	if (tconn->status == TCP_CONN_READY) {
 		if (tep->poll_conn == tconn)
 			tep->poll_conn = NULL;
-		if (tconn->pfd.fd) {
-			close(tconn->pfd.fd);
-			tconn->pfd.fd = 0;
+		if (tconn->pfd->fd) {
+			close(tconn->pfd->fd);
+			release_pollfd(ep, tconn);
 		}
 		/* TODO complete queued and pending sends */
 	}
 	tconn->status = TCP_CONN_CLOSED;
-	pthread_mutex_unlock(&tconn->lock);
 	pthread_mutex_unlock(&ep->lock);
 
 	return;
 }
 
-/* NOTE: the caller holds ep->lock and tconn->lock
+/* NOTE: the caller holds ep->lock
  */
 static void
 tcp_conn_set_closing_locked(cci__ep_t *ep, cci__conn_t *conn)
@@ -821,12 +841,23 @@
 	tcp_conn_t *tconn = conn->priv;
 
 	if (tconn->status > TCP_CONN_INIT) {
-		if (tconn->pfd.fd) {
-			close(tconn->pfd.fd);
-			tconn->pfd.fd = 0;
+		if (tconn->pfd->fd) {
+			close(tconn->pfd->fd);
+			release_pollfd(ep, tconn);
 		}
 		tconn->status = TCP_CONN_CLOSING;
 		/* TODO complete queued and pending sends */
+		if (!TAILQ_EMPTY(&tconn->queued))
+			debug(CCI_DB_CONN,
+				"%s: tconn->queued is not empty", __func__);
+
+		if (!TAILQ_EMPTY(&tconn->rmas))
+			debug(CCI_DB_CONN,
+				"%s: tconn->rmas is not empty", __func__);
+
+		if (!TAILQ_EMPTY(&tconn->pending))
+			debug(CCI_DB_CONN,
+				"%s: tconn->pending is not empty", __func__);
 
 		if (tep->poll_conn == tconn)
 			tep->poll_conn = NULL;
@@ -841,12 +872,8 @@
 static void
 tcp_conn_set_closing(cci__ep_t *ep, cci__conn_t *conn)
 {
-	tcp_conn_t *tconn = conn->priv;
-
 	pthread_mutex_lock(&ep->lock);
-	pthread_mutex_lock(&tconn->lock);
 	tcp_conn_set_closing_locked(ep, conn);
-	pthread_mutex_unlock(&tconn->lock);
 	pthread_mutex_unlock(&ep->lock);
 	return;
 }
@@ -911,6 +938,9 @@
 			free(handle);
 		}
 
+		free(tep->fds);
+		free(tep->fd_bits);
+
 		if (tep->pipe[0] != -1)
 			close(tep->pipe[0]);
 		if (tep->pipe[1] != -1)
@@ -1083,10 +1113,12 @@
 	if (!tx) {
 		/* TODO send reject */
 		/* TODO tep->nfds-- */
+		debug(CCI_DB_CONN, "%s: unable to get tx for conn %p (%s)",
+				__func__, (void*) conn, conn->uri);
 
-		if (tconn->pfd.fd) {
-			close(tconn->pfd.fd);
-			tconn->pfd.fd = 0;
+		if (tconn->pfd->fd) {
+			close(tconn->pfd->fd);
+			release_pollfd(ep, tconn);
 		}
 
 		pthread_mutex_lock(&ep->lock);
@@ -1131,14 +1163,15 @@
 
 	tx->len = sizeof(*hdr) + sizeof(*hs);
 
+	pthread_mutex_lock(&ep->lock);
 	tx->state = TCP_TX_PENDING;
-	tcp_sendto(tconn->pfd.fd, tx->buffer, tx->len, NULL, 0, &offset);
+	tcp_sendto(tconn->pfd->fd, tx->buffer, tx->len, NULL, 0, &offset);
 
 	assert((uint32_t)offset == tx->len);
 
-	pthread_mutex_lock(&tconn->lock);
 	TAILQ_INSERT_HEAD(&tconn->pending, &tx->evt, entry);
-	pthread_mutex_unlock(&tconn->lock);
+	tconn->pfd->events = POLLIN | POLLOUT;
+	pthread_mutex_unlock(&ep->lock);
 
 	CCI_EXIT;
 
@@ -1188,7 +1221,7 @@
 	memset(&reject, 0, sizeof(reject));
 	tcp_pack_conn_reply(&reject, CCI_ECONNREFUSED, b);
 
-	tcp_sendto(tconn->pfd.fd, &reject, sizeof(reject),
+	tcp_sendto(tconn->pfd->fd, &reject, sizeof(reject),
 			NULL, 0, &offset);
 
 	memset(name, 0, sizeof(name));
@@ -1253,15 +1286,98 @@
 	return CCI_SUCCESS;
 }
 
+/* This function will loop until it can successfully assign a pollfd.
+ * If either realloc() fails, it tries again. In a low memory state,
+ * this may try forever.
+ */
+static void
+assign_pollfd(cci__ep_t *ep, tcp_conn_t *tconn)
+{
+	int i = 0;
+	int idx = -1;
+	tcp_ep_t *tep = ep->priv;
+
+	pthread_mutex_lock(&ep->lock);
+
+    again:
+	for (i = 0; i < tep->blocks; i++) {
+		uint64_t *bits = &tep->fd_bits[i];
+
+		if (!(*bits))
+			continue;
+
+		idx = ffsll(*bits) - 1;
+
+		*bits = *bits & ~((uint64_t)1 << idx);
+		idx += i * 64;
+	}
+
+	if (idx == -1) {
+		uint64_t *tmp = NULL;
+		struct pollfd *fds = NULL;
+
+		tep->blocks++;
+
+		tmp = realloc(tep->fd_bits, tep->blocks * sizeof(*tep->fd_bits));
+		if (!tmp)
+			goto again; /* will retry */
+
+		tep->fd_bits = tmp;
+		tmp = &tep->fd_bits[tep->blocks - 1];
+		memset(tmp, -1, sizeof(*tmp));
+
+    again_fds:
+		fds = realloc(tep->fds, tep->blocks * sizeof(*tep->fds) * 64);
+		if (!fds) {
+			usleep(1000);
+			goto again_fds; /* will retry */
+		}
+
+		tep->fds = fds;
+		fds = (void*)((uintptr_t)tep->fds +
+				(uintptr_t)((tep->blocks - 1) * sizeof(*tep->fds)));
+		memset(fds, 0, sizeof(tep->fds) * 64);
+
+		goto again;
+	}
+
+	if (tep->nfds < (nfds_t) idx + 1)
+		tep->nfds = (nfds_t) idx + 1;
+
+	pthread_mutex_unlock(&ep->lock);
+
+	tconn->idx = idx;
+	tconn->pfd = &tep->fds[idx];
+
+	return;
+}
+
+static void
+release_pollfd(cci__ep_t *ep, tcp_conn_t *tconn)
+{
+	int i = 0, idx = 0;
+	tcp_ep_t *tep = ep->priv;
+	uint64_t *bits = NULL;
+
+	i = tconn->idx / 64;
+	idx = tconn->idx % 64;
+
+	bits = &tep->fd_bits[i];
+	*bits = *bits | ((uint64_t)1 << idx);
+
+	tconn->pfd->fd = -1;
+	tconn->pfd->events = 0;
+	tconn->idx = -1;
+
+	return;
+}
+
 static inline int
 tcp_new_conn(cci__ep_t *ep, struct sockaddr_in sin, int fd, cci__conn_t **connp)
 {
 	int ret = CCI_SUCCESS;
 	cci__conn_t *conn = NULL;
 	tcp_conn_t *tconn = NULL;
-	pthread_mutexattr_t attr;
-
-	pthread_mutexattr_init(&attr);
 
 	/* allocate a new connection */
 	conn = calloc(1, sizeof(*conn));
@@ -1282,7 +1398,10 @@
 	tconn = conn->priv;
 	tconn->conn = conn;
 	tconn->refcnt = 1; /* one for the caller */
-	tconn->pfd.fd = fd;
+
+	assign_pollfd(ep, tconn);
+
+	tconn->pfd->fd = fd;
 	if (fd != -1)
 		tconn->status = TCP_CONN_ACTIVE1;
 	else
@@ -1293,16 +1412,10 @@
 
 	memcpy(&tconn->sin, &sin, sizeof(sin));
 
-	ret = pthread_mutex_init(&tconn->lock, &attr);
-	if (ret)
-		goto out_with_tconn;
-
 	*connp = conn;
 
 	return ret;
 
-out_with_tconn:
-	free(tconn);
 out_with_conn:
 	free(conn);
 	return ret;
@@ -1316,11 +1429,11 @@
 	tcp_dev_t *tdev = dev->priv;
 	tcp_conn_t *tconn = conn->priv;
 
-	ret = tcp_set_nonblocking(tconn->pfd.fd);
+	ret = tcp_set_nonblocking(tconn->pfd->fd);
 	if (ret)
 		goto out;
 
-	ret = setsockopt(tconn->pfd.fd, IPPROTO_TCP, TCP_NODELAY, &one, sizeof(one));
+	ret = setsockopt(tconn->pfd->fd, IPPROTO_TCP, TCP_NODELAY, &one, sizeof(one));
 	if (ret)
 		goto out;
 
@@ -1331,11 +1444,11 @@
 		debug(CCI_DB_CONN, "%s: setting socket buffer sizes to %u",
 			__func__, bufsize);
 
-		ret = setsockopt(tconn->pfd.fd, SOL_SOCKET, SO_SNDBUF, &bufsize, opt_len);
+		ret = setsockopt(tconn->pfd->fd, SOL_SOCKET, SO_SNDBUF, &bufsize, opt_len);
 		if (ret) debug(CCI_DB_EP, "%s: unable to set SO_SNDBUF (%s)",
 				__func__, strerror(errno));
 
-		ret = setsockopt(tconn->pfd.fd, SOL_SOCKET, SO_RCVBUF, &bufsize, opt_len);
+		ret = setsockopt(tconn->pfd->fd, SOL_SOCKET, SO_RCVBUF, &bufsize, opt_len);
 		if (ret) debug(CCI_DB_EP, "%s: unable to set SO_RCVBUF (%s)",
 				__func__, strerror(errno));
 
@@ -1343,7 +1456,7 @@
 	}
 
 	pthread_mutex_lock(&ep->lock);
-	tconn->pfd.events = events;
+	tconn->pfd->events = events;
 	pthread_mutex_unlock(&ep->lock);
 
 out:
@@ -1476,15 +1589,6 @@
 	tx->len += data_len;
 	assert(tx->len <= ep->buffer_len);
 
-	/* start connect now */
-	ret = socket(PF_INET, SOCK_STREAM, 0);
-	if (ret == -1) {
-		ret = errno;
-		debug(CCI_DB_CONN, "%s: socket returned %s", __func__, strerror(ret));
-		goto out;
-	}
-	tconn->pfd.fd = ret;
-
 	/* we will have to check for POLLOUT to determine when
 	 * the connect completed
 	 */
@@ -1495,15 +1599,16 @@
 	tx->state = TCP_TX_QUEUED;
 
 	/* insert at tail of conn's queued list */
-	pthread_mutex_lock(&tconn->lock);
+	pthread_mutex_lock(&ep->lock);
 	TAILQ_INSERT_TAIL(&tconn->queued, &tx->evt, entry);
-	pthread_mutex_unlock(&tconn->lock);
+	tconn->pfd->events = POLLIN | POLLOUT;
+	pthread_mutex_unlock(&ep->lock);
 
 	queue_conn(ep, conn);
 
 again:
 	/* ok, initiate connect()... */
-	ret = connect(tconn->pfd.fd, (struct sockaddr *)&sin, slen);
+	ret = connect(tconn->pfd->fd, (struct sockaddr *)&sin, slen);
 	if (ret) {
 		ret = errno;
 		if (ret == EINTR) {
@@ -1520,7 +1625,7 @@
 	} else {
 		/* TODO connect completed, send CONN_REQUEST */
 		debug(CCI_DB_CONN, "%s: connect() completed", __func__);
-		tconn->pfd.events = POLLIN | POLLOUT;
+		tconn->pfd->events = POLLIN | POLLOUT;
 	}
 
 	conn_decref(ep, conn); /* drop our reference */
@@ -1537,10 +1642,6 @@
 		pthread_mutex_unlock(&ep->lock);
 
 		free((char *)conn->uri);
-#if CCI_DEBUG
-		memset(tconn, 0xFF, sizeof(*tconn));
-		memset(conn, 0xFF, sizeof(*conn));
-#endif
 		free(conn->priv);
 		free(conn);
 	}
@@ -1708,12 +1809,15 @@
 	pthread_mutex_unlock(&ep->lock);
 
 	/* drain fd so that they can block again */
-	if (TCP_CONN_IS_BLOCKING(tep)) {
+	if (ev && TCP_CONN_IS_BLOCKING(tep)) {
 		char a[1];
+#if 0
 		do {
 			/* Nothing explicit to do here */
 		} while (tcp_event_queue_is_empty (ep) &&
 		         read (tep->pipe[0], a, sizeof(a)) != sizeof (a));
+#endif
+		read (tep->pipe[0], a, sizeof(a));
 	}
 
 	*event = &ev->event;
@@ -1803,7 +1907,7 @@
 }
 
 static inline void
-tcp_progress_conn_sends(cci__conn_t *conn)
+tcp_progress_conn_sends(cci__ep_t *ep, cci__conn_t *conn)
 {
 	int ret;
 	tcp_conn_t *tconn = conn->priv;
@@ -1814,7 +1918,7 @@
 
 	tconn = conn->priv;
 
-	pthread_mutex_lock(&tconn->lock);
+	pthread_mutex_lock(&ep->lock);
 	while (!TAILQ_EMPTY(&tconn->queued)) {
 		cci__evt_t *evt = TAILQ_FIRST(&tconn->queued);
 		tcp_tx_t *tx = container_of(evt, tcp_tx_t, evt);
@@ -1839,7 +1943,7 @@
 			"offset %"PRIuPTR" tx %u", __func__, (void*)tx->buffer,
 			tx->len, (void*)tx->rma_ptr, tx->rma_len, tx->offset, tx->id);
 
-		ret = tcp_sendto(tconn->pfd.fd, tx->buffer, tx->len,
+		ret = tcp_sendto(tconn->pfd->fd, tx->buffer, tx->len,
 				tx->rma_ptr, tx->rma_len, &tx->offset);
 		if (ret) {
 			if (ret == EAGAIN || ret == EINTR) {
@@ -1886,7 +1990,11 @@
 			}
 		}
 	}
-	pthread_mutex_unlock(&tconn->lock);
+	/* If nothing queued, unset POLLOUT */
+	if (TAILQ_EMPTY(&tconn->queued) && TAILQ_EMPTY(&tconn->pending)
+			&& TAILQ_EMPTY(&tconn->rmas))
+		tconn->pfd->events = POLLIN;
+	pthread_mutex_unlock(&ep->lock);
 
 	if (put_tx) {
 		tcp_put_tx(put_tx);
@@ -1906,12 +2014,12 @@
 }
 
 static inline void
-tcp_queue_tx(tcp_ep_t *tep, tcp_conn_t *tconn, cci__evt_t *evt)
+tcp_queue_tx(cci__ep_t *ep, tcp_conn_t *tconn, cci__evt_t *evt)
 {
-	pthread_mutex_lock(&tconn->lock);
+	pthread_mutex_lock(&ep->lock);
 	TAILQ_INSERT_TAIL(&tconn->queued, evt, entry);
-	tconn->pfd.events = POLLIN | POLLOUT;
-	pthread_mutex_unlock(&tconn->lock);
+	tconn->pfd->events = POLLIN | POLLOUT;
+	pthread_mutex_unlock(&ep->lock);
 }
 
 static int tcp_send_common(cci_connection_t * connection,
@@ -2028,7 +2136,7 @@
 	/* if unreliable, try to send */
 	if (!is_reliable) {
     again:
-		ret = tcp_sendto(tconn->pfd.fd, tx->buffer, tx->len, tx->rma_ptr,
+		ret = tcp_sendto(tconn->pfd->fd, tx->buffer, tx->len, tx->rma_ptr,
 				tx->rma_len, &tx->offset);
 		if (ret == CCI_SUCCESS) {
 			if (tx->offset < tx->len)
@@ -2055,11 +2163,11 @@
 	debug(CCI_DB_MSG, "%s: queuing MSG %p to conn %p", __func__, (void*)tx, (void*)conn);
 
 	tx->state = TCP_TX_QUEUED;
-	tcp_queue_tx(tep, tconn, evt);
+	tcp_queue_tx(ep, tconn, evt);
 
 	/* try to progress txs */
 
-	tcp_progress_conn_sends(conn);
+	tcp_progress_conn_sends(ep, conn);
 
 	/* if unreliable, we are done since it is buffered internally */
 	if (!is_reliable) {
@@ -2400,12 +2508,10 @@
 		}
 	}
 	pthread_mutex_lock(&ep->lock);
-	pthread_mutex_lock(&tconn->lock);
 	for (i = 0; i < cnt; i++)
 		TAILQ_INSERT_TAIL(&tconn->queued, &(txs[i])->evt, entry);
 	TAILQ_INSERT_TAIL(&tconn->rmas, rma_op, rmas);
-	tconn->pfd.events = POLLIN | POLLOUT;
-	pthread_mutex_unlock(&tconn->lock);
+	tconn->pfd->events = POLLIN | POLLOUT;
 
 	TAILQ_INSERT_TAIL(&tep->rma_ops, rma_op, entry);
 	pthread_mutex_unlock(&ep->lock);
@@ -2415,7 +2521,7 @@
 
 	ret = CCI_SUCCESS;
 
-	tcp_progress_conn_sends(conn);
+	tcp_progress_conn_sends(ep, conn);
 
 out:
 	if (ret) {
@@ -2449,14 +2555,14 @@
 
 	tconn = conn->priv;
 
-	ret = accept(listen_tconn->pfd.fd, (struct sockaddr *)&sin, &slen);
+	ret = accept(listen_tconn->pfd->fd, (struct sockaddr *)&sin, &slen);
 	if (ret == -1) {
 		ret = errno;
 		debug(CCI_DB_CONN, "%s: accept() failed with %s (%d)",
 			__func__, strerror(ret), ret);
 		goto out;
 	}
-	tconn->pfd.fd = ret;
+	tconn->pfd->fd = ret;
 
 	ret = tcp_monitor_fd(ep, conn, POLLIN);
 	if (ret)
@@ -2530,9 +2636,11 @@
 	uint32_t rx_cnt, mss, ka, ignore;
 	tcp_ep_t *tep = ep->priv;
 
-	ret = tcp_recv_msg(tconn->pfd.fd, hdr->data, total);
+	ret = tcp_recv_msg(tconn->pfd->fd, hdr->data, total);
 	if (ret) {
 		/* TODO handle error */
+		debug(CCI_DB_CONN, "%s: unable to recv conn %p handshake - %s",
+				__func__, (void*)conn, cci_strerror(&ep->endpoint, ret));
 		goto out;
 	}
 
@@ -2605,9 +2713,11 @@
 		rx->evt.event.connect.connection = NULL;
 
 	if (accepted) {
-		ret = tcp_recv_msg(tconn->pfd.fd, hdr->data, total);
+		ret = tcp_recv_msg(tconn->pfd->fd, hdr->data, total);
 		if (ret) {
 			/* TODO handle error */
+			debug(CCI_DB_CONN, "%s: recv_msg() failed with %d",
+					__func__, ret);
 			tcp_conn_set_closing(ep, conn);
 			rx->evt.event.connect.status = CCI_ERROR;
 			rx->evt.event.connect.connection = NULL;
@@ -2646,15 +2756,16 @@
 
 	tx->state = TCP_TX_QUEUED;
 
-	pthread_mutex_lock(&tconn->lock);
+	pthread_mutex_lock(&ep->lock);
 	TAILQ_REMOVE(&tconn->pending, &tx->evt, entry);
 	TAILQ_INSERT_TAIL(&tconn->queued, &tx->evt, entry);
+	tconn->pfd->events = POLLIN | POLLOUT;
 	tconn->status = TCP_CONN_READY;
 	tconn->refcnt++; /* for the calling application */
-	pthread_mutex_unlock(&tconn->lock);
+	pthread_mutex_unlock(&ep->lock);
 
 	/* try to progress txs */
-	tcp_progress_conn_sends(conn);
+	tcp_progress_conn_sends(ep, conn);
 
 out:
 	pthread_mutex_lock(&ep->lock);
@@ -2662,9 +2773,9 @@
 	pthread_mutex_unlock(&ep->lock);
 
 	if (ret) {
-		pthread_mutex_lock(&tconn->lock);
+		pthread_mutex_lock(&ep->lock);
 		TAILQ_REMOVE(&tconn->pending, &tx->evt, entry);
-		pthread_mutex_unlock(&tconn->lock);
+		pthread_mutex_unlock(&ep->lock);
 		tcp_put_tx(tx);
 		/* This will close our connection, the peer will get
 		 * a POLLHUP and clean up accordingly */
@@ -2685,9 +2796,9 @@
 	debug(CCI_DB_CONN, "%s: recv'd conn_ack from conn %p",
 		__func__, (void*)conn);
 
-	pthread_mutex_lock(&tconn->lock);
+	pthread_mutex_lock(&ep->lock);
 	TAILQ_REMOVE(&tconn->pending, &tx->evt, entry);
-	pthread_mutex_unlock(&tconn->lock);
+	pthread_mutex_unlock(&ep->lock);
 
 	pthread_mutex_lock(&ep->lock);
 	tconn->status = TCP_CONN_READY;
@@ -2715,7 +2826,7 @@
 	debug(CCI_DB_MSG, "%s: recv'd MSG from conn %p with len %u",
 		__func__, (void*)conn, len);
 
-	ret = tcp_recv_msg(tconn->pfd.fd, hdr->data, total);
+	ret = tcp_recv_msg(tconn->pfd->fd, hdr->data, total);
 	if (ret) {
 		/* TODO handle error */
 		goto out;
@@ -2751,7 +2862,7 @@
 
 		debug(CCI_DB_MSG, "%s: queuing ack for received tx %u", __func__, tx_id);
 
-		tcp_queue_tx(tep, tconn, &tx->evt);
+		tcp_queue_tx(ep, tconn, &tx->evt);
 	}
 
 	/* TODO close conn */
@@ -2777,7 +2888,7 @@
 	debug(CCI_DB_MSG, "%s: recv'ing RMA_WRITE on conn %p with len %u",
 		__func__, (void*)conn, len);
 
-	ret = tcp_recv_msg(tconn->pfd.fd, rma_header->header.data, handle_len);
+	ret = tcp_recv_msg(tconn->pfd->fd, rma_header->header.data, handle_len);
 	if (ret) {
 		/* TODO handle error */
 		goto out;
@@ -2816,7 +2927,7 @@
 		/* valid remote handle, copy the data */
 		debug(CCI_DB_INFO, "%s: recv'ing data into target buffer", __func__);
 		ptr = (void*)((uintptr_t)remote->start + (uintptr_t) remote_offset);
-		ret = tcp_recv_msg(tconn->pfd.fd, ptr, len);
+		ret = tcp_recv_msg(tconn->pfd->fd, ptr, len);
 		debug(CCI_DB_MSG, "%s: recv'd data into target buffer", __func__);
 		if (ret)
 			debug(CCI_DB_MSG, "%s: recv'ing RMA WRITE payload failed with %s",
@@ -2832,7 +2943,7 @@
 			if (l > (int) (len - offset))
 				l = len - offset;
 
-			tcp_recv_msg(tconn->pfd.fd, tmp, l);
+			tcp_recv_msg(tconn->pfd->fd, tmp, l);
 			offset += l;
 		} while (offset < len);
 	}
@@ -2845,7 +2956,7 @@
 	ack = tx->buffer;
 	tcp_pack_ack(ack, tx_id, ret);
 
-	tcp_queue_tx(tep, tconn, &tx->evt);
+	tcp_queue_tx(ep, tconn, &tx->evt);
 
 	tcp_put_rx(rx);
 
@@ -2869,7 +2980,7 @@
 	debug(CCI_DB_MSG, "%s: recv'ing RMA_READ_REQUEST on conn %p with len %u",
 		__func__, (void*)conn, len);
 
-	ret = tcp_recv_msg(tconn->pfd.fd, read_request->header.data, handle_len);
+	ret = tcp_recv_msg(tconn->pfd->fd, read_request->header.data, handle_len);
 	if (ret) {
 		/* TODO handle error */
 		goto out;
@@ -2933,7 +3044,7 @@
 			remote_handle,
 			remote_offset);
 
-	tcp_queue_tx(tep, tconn, &tx->evt);
+	tcp_queue_tx(ep, tconn, &tx->evt);
 
 out:
 	if (ret) {
@@ -2947,7 +3058,7 @@
 		ack = tx->buffer;
 		tcp_pack_ack(ack, tx_id, ret);
 
-		tcp_queue_tx(tep, tconn, &tx->evt);
+		tcp_queue_tx(ep, tconn, &tx->evt);
 	}
 	tcp_put_rx(rx);
 
@@ -2969,11 +3080,11 @@
 	if (status && (rma_op->status == CCI_SUCCESS))
 		rma_op->status = status;
 
-	pthread_mutex_lock(&tconn->lock);
+	pthread_mutex_lock(&ep->lock);
 	TAILQ_REMOVE(&tconn->pending, &tx->evt, entry);
 	if (rma_op->status && rma_op->pending == 0)
 		done = 1;
-	pthread_mutex_unlock(&tconn->lock);
+	pthread_mutex_unlock(&ep->lock);
 
 	if ((tx->rma_id == (rma_op->num_msgs - 1)) || done) {
 		int ret;
@@ -2981,10 +3092,8 @@
 		/* last segment - complete rma */
 		tx->evt.event.send.status = rma_op->status;
 		if (rma_op->status || !rma_op->msg_ptr) {
-			pthread_mutex_lock(&tconn->lock);
-			TAILQ_REMOVE(&tconn->rmas, rma_op, rmas);
-			pthread_mutex_unlock(&tconn->lock);
 			pthread_mutex_lock(&ep->lock);
+			TAILQ_REMOVE(&tconn->rmas, rma_op, rmas);
 			TAILQ_REMOVE(&tep->rma_ops, rma_op, entry);
 			TCP_QUEUE_EVT(&ep->evts, &tx->evt, tep);
 			pthread_mutex_unlock(&ep->lock);
@@ -3003,10 +3112,8 @@
 			iov.iov_base = rma_op->msg_ptr;
 			iov.iov_len = rma_op->msg_len;
 
-			pthread_mutex_lock(&tconn->lock);
-			TAILQ_REMOVE(&tconn->rmas, rma_op, rmas);
-			pthread_mutex_unlock(&tconn->lock);
 			pthread_mutex_lock(&ep->lock);
+			TAILQ_REMOVE(&tconn->rmas, rma_op, rmas);
 			TAILQ_REMOVE(&tep->rma_ops, rma_op, entry);
 			pthread_mutex_unlock(&ep->lock);
 			debug(CCI_DB_MSG, "%s: sending RMA completion MSG ***",
@@ -3016,7 +3123,7 @@
 						1,
 						rma_op->context,
 						rma_op->flags,
-						NULL);
+						rma_op);
 			if (ret) {
 				tx->evt.event.send.status = ret;
 				pthread_mutex_lock(&ep->lock);
@@ -3078,7 +3185,7 @@
 			tx->rma_len = 0;
 		}
 
-		tcp_queue_tx(tep, tconn, &tx->evt);
+		tcp_queue_tx(ep, tconn, &tx->evt);
 	}
 
 	tcp_put_rx(rx);
@@ -3103,7 +3210,7 @@
 	debug(CCI_DB_MSG, "%s: recv'ing RMA_READ_REPLY on conn %p with len %u",
 		__func__, (void*)conn, len);
 
-	ret = tcp_recv_msg(tconn->pfd.fd, rma_header->header.data, handle_len);
+	ret = tcp_recv_msg(tconn->pfd->fd, rma_header->header.data, handle_len);
 	if (ret) {
 		/* TODO handle error */
 		debug(CCI_DB_MSG, "%s: recv_msg() returned %s",
@@ -3143,7 +3250,7 @@
 	/* valid local handle, copy the data */
 	debug(CCI_DB_INFO, "%s: recv'ing data into target buffer", __func__);
 	ptr = (void*)((uintptr_t)local->start + (uintptr_t) local_offset);
-	ret = tcp_recv_msg(tconn->pfd.fd, ptr, len);
+	ret = tcp_recv_msg(tconn->pfd->fd, ptr, len);
 	debug(CCI_DB_MSG, "%s: recv'd data into target buffer", __func__);
 	if (ret)
 		debug(CCI_DB_MSG, "%s: recv'ing RMA READ payload failed with %s",
@@ -3179,9 +3286,9 @@
 				"with error %s", __func__,
 				cci_strerror(&ep->endpoint, status));
 
-		pthread_mutex_lock(&tconn->lock);
+		pthread_mutex_lock(&ep->lock);
 		TAILQ_REMOVE(&tconn->pending, &tx->evt, entry);
-		pthread_mutex_unlock(&tconn->lock);
+		pthread_mutex_unlock(&ep->lock);
 
 		pthread_mutex_lock(&ep->lock);
 		if (!(tx->msg_type == TCP_MSG_CONN_REPLY &&
@@ -3196,9 +3303,9 @@
 			/* We rejected this conn, clean it up */
 			/* FIXME */
 			/* FIXME do we need to put the tx? */
-			pthread_mutex_lock(&tconn->lock);
+			pthread_mutex_lock(&ep->lock);
 			tcp_conn_set_closing_locked(ep, conn);
-			pthread_mutex_unlock(&tconn->lock);
+			pthread_mutex_unlock(&ep->lock);
 		}
 		tcp_put_rx_locked(tep, rx);
 		pthread_mutex_unlock(&ep->lock);
@@ -3240,7 +3347,7 @@
 	rx->evt.conn = conn;
 	hdr = rx->buffer;
 
-	ret = tcp_recv_msg(tconn->pfd.fd, hdr, len);
+	ret = tcp_recv_msg(tconn->pfd->fd, hdr, len);
 	if (ret) {
 		/* TODO handle error */
 		debug(CCI_DB_MSG, "%s: tcp_recv_msg() returned %d (rx=%p hdr=%p)",
@@ -3334,18 +3441,15 @@
 		if (!last)
 			last = TAILQ_FIRST(&tep->conns);
 
-		pthread_mutex_lock(&last->lock);
 		if (last->status > TCP_CONN_INIT) {
 			if ((last->status == TCP_CONN_READY && last->refcnt == 2) ||
 				(last->status < TCP_CONN_READY && last->refcnt == 1)) {
 				conn = last->conn;
 				last->refcnt++;
-				pthread_mutex_unlock(&last->lock);
 				ret = CCI_SUCCESS;
 				break;
 			}
 		}
-		pthread_mutex_unlock(&last->lock);
 	} while (last != end);
 
 	tep->poll_conn = last;
@@ -3367,10 +3471,6 @@
 
 	free((char *)conn->uri);
 
-#if CCI_DEBUG
-	memset(tconn, 0xFF, sizeof(*tconn));
-	memset(conn, 0xFF, sizeof(*conn));
-#endif
 	free(tconn);
 	free(conn);
 	return;
@@ -3383,17 +3483,14 @@
 	tcp_ep_t *tep = ep->priv;
 	tcp_conn_t *tconn = conn->priv;
 
-	pthread_mutex_lock(&tconn->lock);
 	tconn->refcnt--;
 
 	if (tconn->refcnt == 0) {
 		assert(tconn->status < TCP_CONN_INIT);
 		TAILQ_REMOVE(&tep->conns, tconn, entry);
-		pthread_mutex_unlock(&tconn->lock);
 		delete_conn_locked(conn);
 		goto out;
 	}
-	pthread_mutex_unlock(&tconn->lock);
     out:
 	return;
 }
@@ -3496,11 +3593,11 @@
 	/* Note: we have a ref on this conn */
 
 	if (!tconn->is_listener && tconn->status > TCP_CONN_INIT)
-		tconn->pfd.events = POLLIN | POLLOUT;
+		tconn->pfd->events = POLLIN | POLLOUT;
 
 	/* Another thread may have called disconnect() since we got it above and
 	 * closed the conn's fd. If so, we will get POLLNVAL. */
-	ret = poll(&tconn->pfd, 1, 0);
+	ret = poll(tconn->pfd, 1, 0);
 	if (ret < 1) {
 		if (ret == -1) {
 			ret = errno;
@@ -3512,7 +3609,7 @@
 		goto out;
 	}
 
-	revents = tconn->pfd.revents;
+	revents = tconn->pfd->revents;
 
 	events(revents, str, POLL_EVENTS_LEN);
 	debug(CCI_DB_EP, "%s: poll() on conn %p found events %s", __func__,
@@ -3535,16 +3632,19 @@
 			break;
 		case TCP_CONN_ACTIVE1:
 		case TCP_CONN_ACTIVE2:
-			pthread_mutex_lock(&tconn->lock);
+			pthread_mutex_lock(&ep->lock);
 			if (old_status == TCP_CONN_ACTIVE1 ||
 				!TAILQ_EMPTY(&tconn->queued)) {
 				evt = TAILQ_FIRST(&tconn->queued);
 				TAILQ_REMOVE(&tconn->queued, evt, entry);
+				/* If nothing queued, unset POLLOUT */
+				if (0 && TAILQ_EMPTY(&tconn->queued))
+					tconn->pfd->events = POLLIN;
 			} else {
 				evt = TAILQ_FIRST(&tconn->pending);
 				TAILQ_REMOVE(&tconn->pending, evt, entry);
 			}
-			pthread_mutex_unlock(&tconn->lock);
+			pthread_mutex_unlock(&ep->lock);
 
 			evt->event.connect.status = CCI_ETIMEDOUT;
 			tx = container_of(evt, tcp_tx_t, evt);
@@ -3573,6 +3673,7 @@
 	if (revents & POLLERR || revents & POLLNVAL) {
 		/* handle error */
 		/* TODO close connection */
+		tcp_conn_set_closing(ep, conn);
 		goto out;
 	}
 	if (revents & POLLIN) {
@@ -3591,11 +3692,11 @@
 
 		if (tconn->status == TCP_CONN_ACTIVE1) {
     again:
-			rc = getsockopt(tconn->pfd.fd, SOL_SOCKET, SO_ERROR, (void*)pe, &slen);
+			rc = getsockopt(tconn->pfd->fd, SOL_SOCKET, SO_ERROR, (void*)pe, &slen);
 			if (rc) {
 				debug(CCI_DB_CONN, "%s: getsockopt() for conn %p (fd %d) "
 					"failed with %s", __func__, (void*)conn,
-					tconn->pfd.fd, strerror(errno));
+					tconn->pfd->fd, strerror(errno));
 				if (errno == EBADF) {
 					/* TODO close connection */
 					assert(0);
@@ -3611,7 +3712,7 @@
 					__func__, (void*)conn);
 				pthread_mutex_lock(&ep->lock);
 				tconn->status = TCP_CONN_ACTIVE2;
-				tconn->pfd.events = POLLIN | POLLOUT;
+				tconn->pfd->events = POLLIN | POLLOUT;
 				pthread_mutex_unlock(&ep->lock);
 			} else {
 				/* TODO close connection */
@@ -3620,7 +3721,7 @@
 				goto out;
 			}
 		}
-		tcp_progress_conn_sends(conn);
+		tcp_progress_conn_sends(ep, conn);
 		revents &= ~POLLOUT;
 	}
 	if (revents) {
@@ -3636,11 +3737,36 @@
 static void *tcp_progress_thread(void *arg)
 {
 	cci__ep_t *ep = (cci__ep_t *) arg;
+	tcp_ep_t *tep = NULL;
 
 	assert (ep);
 
-	while (!ep->closing)
+	tep = ep->priv;
+
+	while (!ep->closing) {
+		int ret = 0;
+		struct pollfd *fds = NULL;
+		nfds_t nfds = 0;
+		size_t len = 0;
+
+		pthread_mutex_lock(&ep->lock);
+		nfds = tep->nfds;
+		len = nfds * sizeof(*fds);
+		fds = malloc(len);
+		if (fds)
+			memcpy(fds, tep->fds, len);
+		pthread_mutex_unlock(&ep->lock);
+
+		if (!fds)
+			continue;
+
+		ret = poll(fds, nfds, 1000);
+		free(fds);
+		if (ret < 1)
+			continue;
+
 		tcp_progress_ep(ep);
+	}
 
 	pthread_exit(NULL);
 	return (NULL);		/* make pgcc happy */
diff -uNr cci-2.0/src/plugins/ctp/tcp/ctp_tcp.h cci-2.0-patch/src/plugins/ctp/tcp/ctp_tcp.h
--- cci-2.0/src/plugins/ctp/tcp/ctp_tcp.h	2016-06-28 12:56:52.000000000 -0500
+++ cci-2.0-patch/src/plugins/ctp/tcp/ctp_tcp.h	2017-03-02 00:36:35.868758691 -0600
@@ -695,9 +695,18 @@
 	/*! Last conn polled */
 	tcp_conn_t *poll_conn;
 
+	/*! Number of bitmap 64-bit blocks */
+	int blocks;
+
+	/*! Poll FD bitmap */
+	uint64_t *fd_bits;
+
 	/*! Number of pollfds */
 	nfds_t nfds;
 
+	/*! Arrary of poll fds - multiples of 64 */
+	struct pollfd *fds;
+
 	/*! TX common buffer */
 	void *tx_buf;
 
@@ -802,17 +811,17 @@
 	int refcnt;
 
 	/*! poll fd */
-	struct pollfd pfd;
+	struct pollfd *pfd;
 
 	/*! partial receive */
 	tcp_rx_t *rx;
 
-	/*! Lock */
-	pthread_mutex_t lock;
-
 	/*! Is this the endpoint's listening socket? */
 	int is_listener;
 
+	/*! Poll fd index */
+	int idx;
+
 	/*! Entry to hang on tcp_ep->conns */
 	 TAILQ_ENTRY(tcp_conn) entry;
 
@@ -846,16 +855,6 @@
 	uint32_t bufsize;
 };
 
-typedef enum tcp_fd_type {
-	TCP_FD_UNUSED = 0,
-	TCP_FD_EP
-} tcp_fd_type_t;
-
-typedef struct tcp_fd_idx {
-	tcp_fd_type_t type;
-	cci__ep_t *ep;
-} tcp_fd_idx_t;
-
 struct tcp_globals {
 	/*! Mutex */
 	pthread_mutex_t lock;
diff -uNr cci-2.0/src/plugins/ctp/tcp/Makefile.in cci-2.0-patch/src/plugins/ctp/tcp/Makefile.in
--- cci-2.0/src/plugins/ctp/tcp/Makefile.in	2016-06-28 12:58:05.000000000 -0500
+++ cci-2.0-patch/src/plugins/ctp/tcp/Makefile.in	2017-03-02 00:37:07.224930783 -0600
@@ -112,10 +112,10 @@
 	$(top_srcdir)/config/ltversion.m4 \
 	$(top_srcdir)/config/lt~obsolete.m4 \
 	$(top_srcdir)/config/autogen_found_items.m4 \
-	$(top_srcdir)/src/plugins/ctp/verbs/configure.m4 \
-	$(top_srcdir)/src/plugins/ctp/eth/configure.m4 \
 	$(top_srcdir)/src/plugins/ctp/gni/configure.m4 \
 	$(top_srcdir)/src/plugins/ctp/sm/configure.m4 \
+	$(top_srcdir)/src/plugins/ctp/eth/configure.m4 \
+	$(top_srcdir)/src/plugins/ctp/verbs/configure.m4 \
 	$(top_srcdir)/configure.ac
 am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
 	$(ACLOCAL_M4)
diff -uNr cci-2.0/src/plugins/ctp/verbs/ctp_verbs_api.c cci-2.0-patch/src/plugins/ctp/verbs/ctp_verbs_api.c
--- cci-2.0/src/plugins/ctp/verbs/ctp_verbs_api.c	2016-06-28 12:56:52.000000000 -0500
+++ cci-2.0-patch/src/plugins/ctp/verbs/ctp_verbs_api.c	2017-03-02 00:36:35.870758702 -0600
@@ -1724,8 +1724,8 @@
 	}
 
 	ret = ibv_post_send(vconn->id->qp, &wr, &bad_wr);
-	if (ret == -1) {
-		ret = errno;
+	if (ret) {
+		ret = verbs_wc_to_cci_status(ret);
 		debug(CCI_DB_MSG,
 		      "unable to send id 0x%" PRIx64
 		      " buffer %p len %u header 0x%x", id, (void*)buffer, len, header);
@@ -2034,6 +2034,7 @@
 	pthread_rwlock_unlock(&vep->conn_tree_lock);
 	pthread_mutex_lock(&ep->lock);
 	TAILQ_INSERT_TAIL(&vep->conns, vconn, entry);
+	vconn->cci_disconn = 1;
 	pthread_mutex_unlock(&ep->lock);
 	debug(CCI_DB_CONN, "%s [%s]: added conn %p qp_num %u", __func__,
 		ep->uri, (void*)conn, vconn->qp_num);
@@ -2345,20 +2346,23 @@
 
 static const char *verbs_conn_state_str(verbs_conn_state_t state);
 
-static int ctp_verbs_disconnect(cci_connection_t * connection)
+static void verbs_destroy_conn(cci__ep_t *ep, cci__conn_t *conn)
 {
-	int ret = CCI_SUCCESS;
-	cci__conn_t *conn = container_of(connection, cci__conn_t, connection);
-	verbs_conn_t *vconn = conn->priv;
-	cci_endpoint_t *endpoint = connection->endpoint;
-	cci__ep_t *ep = container_of(endpoint, cci__ep_t, endpoint);
+	int ret = 0;
 	verbs_ep_t *vep = ep->priv;
+	verbs_conn_t *vconn = conn->priv;
 
-	CCI_ENTER;
+	debug(CCI_DB_CONN, "%s: conn %p vconn %p qp_num %u (%s)",
+		__func__, (void*) conn, (void*)vconn, vconn->qp_num, conn->uri);
 
-	debug(CCI_DB_CONN, "%s [%s]: conn %p state %s qp_num %u", __func__,
-		ep->uri, (void*)conn, verbs_conn_state_str(vconn->state),
-		vconn->qp_num);
+	if (vconn->rdma_disconn) {
+		ret = rdma_disconnect(vconn->id);
+		if (ret == -1) {
+			ret = errno;
+			debug(CCI_DB_WARN, "%s: rdma_disconnect() returned %s",
+			      __func__, strerror(ret));
+		}
+	}
 
 	pthread_rwlock_wrlock(&vep->conn_tree_lock);
 	tdelete(&vconn->qp_num, &vep->conn_tree, verbs_compare_u32);
@@ -2377,13 +2381,6 @@
 			free(vconn->conn_req->ptr);
 	}
 
-	ret = rdma_disconnect(vconn->id);
-	if (ret == -1) {
-		ret = errno;
-		debug(CCI_DB_WARN, "%s: rdma_disconnect() returned %s",
-		      __func__, strerror(ret));
-	}
-
 	if (vconn->rbuf) {
 		if (vconn->rmr) {
 			ret = ibv_dereg_mr(vconn->rmr);
@@ -2399,12 +2396,49 @@
 		free(vconn->rbuf);
 	}
 
-	rdma_destroy_ep(vconn->id);
-
 	free((void *)conn->uri);
 	free(vconn);
 	free(conn);
 
+	return;
+}
+
+static int ctp_verbs_disconnect(cci_connection_t * connection)
+{
+	int ret = CCI_SUCCESS;
+	cci__conn_t *conn = container_of(connection, cci__conn_t, connection);
+	verbs_conn_t *vconn = conn->priv;
+	cci_endpoint_t *endpoint = connection->endpoint;
+	cci__ep_t *ep = container_of(endpoint, cci__ep_t, endpoint);
+	verbs_ep_t *vep = ep->priv;
+	int rdma_disconn = 0;
+
+	CCI_ENTER;
+
+	debug(CCI_DB_CONN, "%s [%s]: conn %p state %s qp_num %u", __func__,
+		ep->uri, (void*)conn, verbs_conn_state_str(vconn->state),
+		vconn->qp_num);
+
+	vconn->cci_disconn = 0;
+
+	if (vconn->rdma_disconn) {
+		/* The conn is established and we are the one trying to
+		 * tear it down.
+		 */
+		ret = rdma_disconnect(vconn->id);
+		if (ret == -1) {
+			ret = errno;
+			debug(CCI_DB_WARN, "%s: rdma_disconnect() returned %s",
+			      __func__, strerror(ret));
+		}
+		vconn->rdma_disconn = 0;
+	} else {
+		/* We have already received the RDMA_CM_EVENT_DISCONNECTED
+		 * event. Go ahead and cleanup.
+		 */
+		verbs_destroy_conn(ep, conn);
+	}
+
 	CCI_EXIT;
 	return ret;
 }
@@ -2891,6 +2925,13 @@
 	vconn = conn->priv;
 	assert(vconn);
 
+	/* The RDMA connection is established. We will need to call
+	 * rdma_disconnect() in the future.
+	 */
+	pthread_mutex_lock(&ep->lock);
+	vconn->rdma_disconn = 1;
+	pthread_mutex_unlock(&ep->lock);
+
 	switch (vconn->state) {
 	case VERBS_CONN_ACTIVE:
 		ret = verbs_conn_est_active(ep, cm_evt);
@@ -2924,22 +2965,61 @@
 	vconn = conn->priv;
 	assert(vconn);
 
-	switch (vconn->state) {
-	case VERBS_CONN_ESTABLISHED:
-		vconn->state = VERBS_CONN_CLOSED;
-		debug(CCI_DB_CONN, "%s: marking vconn %p closed (%s)",
-			__func__, (void*)vconn, conn->uri);
-		break;
-	default:
-		debug(CCI_DB_INFO, "%s: incorrect conn state %s", __func__,
-		      verbs_conn_state_str(vconn->state));
-		break;
+	if (vconn->rdma_disconn) {
+		/* We did not initiate the disconnect. We will not get
+		 * another RDMA_CM_EVENT_DISCONNECTED, so go ahead and
+		 * call it now.
+		 */
+		ret = rdma_disconnect(vconn->id);
+		if (ret == -1) {
+			ret = errno;
+			debug(CCI_DB_WARN, "%s: rdma_disconnect() returned %s",
+			      __func__, strerror(ret));
+		}
+		vconn->rdma_disconn = 0;
+	}
+
+	/* Either way, we got the DISCONNECTED event, it is safe to cleanup
+	 * the QP and CM id.
+	 */
+	ret = rdma_destroy_ep(vconn->id);
+	if (ret == -1) {
+		ret = errno;
+		debug(CCI_DB_WARN, "%s: rdma_destroy_ep() returned %s",
+		      __func__, strerror(ret));
+	}
+
+	if (!vconn->cci_disconn) {
+		verbs_destroy_conn(ep, conn);
 	}
 
 	CCI_EXIT;
 	return ret;
 }
 
+static void
+verbs_handle_timewait_exit(cci__ep_t * ep, struct rdma_cm_event *cm_evt)
+{
+	/* The CM can reuse the QP now. We should have already torn down the
+	 * QP, destroyed the RDMA id, and freed the CCI conn. Simply
+	 * print the QP number and the possibly freed CCI conn address
+	 * for informational purposes.
+	 */
+	debug(CCI_DB_CONN, "%s: qp_num %u context (conn) %p", __func__,
+		cm_evt->id->qp->qp_num, cm_evt->id->context);
+
+	return;
+}
+
+static void
+verbs_handle_connect_error(cci__ep_t * ep, struct rdma_cm_event *cm_evt)
+{
+	debug(CCI_DB_WARN, "%s: qp_num %u context (conn) %p", __func__,
+		cm_evt->id->qp->qp_num, cm_evt->id->context);
+
+	return;
+}
+
 static int verbs_get_cm_event(cci__ep_t * ep)
 {
 	int ret = CCI_EAGAIN;
@@ -2986,6 +3066,12 @@
 			debug(CCI_DB_CONN, "%s: verbs_handle_conn_rejected()"
 			      "returned %s", __func__, strerror(ret));
 		break;
+	case RDMA_CM_EVENT_TIMEWAIT_EXIT:
+		verbs_handle_timewait_exit(ep, cm_evt);
+		break;
+	case RDMA_CM_EVENT_CONNECT_ERROR:
+		verbs_handle_connect_error(ep, cm_evt);
+		break;
 	default:
 		debug(CCI_DB_CONN, "ignoring %s event",
 		      rdma_event_str(cm_evt->event));
@@ -4337,7 +4423,7 @@
 
 	ret = ibv_post_send(vconn->id->qp, &wr, &bad_wr);
 	if (ret) {
-		ret = verbs_wc_to_cci_status(errno);
+		ret = verbs_wc_to_cci_status(ret);
 		debug(CCI_DB_MSG, "%s: ibv_post_send() failed with %s (cci %s)",
 				__func__, ibv_wc_status_str(errno),
 				cci_strerror(&(rma_op->evt.ep)->endpoint, ret));
diff -uNr cci-2.0/src/plugins/ctp/verbs/ctp_verbs.h cci-2.0-patch/src/plugins/ctp/verbs/ctp_verbs.h
--- cci-2.0/src/plugins/ctp/verbs/ctp_verbs.h	2016-06-28 12:56:52.000000000 -0500
+++ cci-2.0-patch/src/plugins/ctp/verbs/ctp_verbs.h	2017-03-02 00:36:35.870758702 -0600
@@ -392,7 +392,9 @@
 	uint32_t last;		/* last slot used */
 	uint32_t **slots;	/* pointers to buffer headers
 				   to poll */
-	int is_polling;		/* polling RDMA MSGs */
+	uint32_t is_polling :1;	/* polling RDMA MSGs */
+	uint32_t rdma_disconn :1; /* still needs rdma_disconnect */
+	uint32_t cci_disconn :1; /* still needs cci_disconnect */
 
 	/* for RO connections when using both SendRecv and RDMA */
 	uint16_t seqno;		/* last seqno sent */
diff -uNr cci-2.0/src/plugins/ctp/verbs/Makefile.in cci-2.0-patch/src/plugins/ctp/verbs/Makefile.in
--- cci-2.0/src/plugins/ctp/verbs/Makefile.in	2016-06-28 12:58:05.000000000 -0500
+++ cci-2.0-patch/src/plugins/ctp/verbs/Makefile.in	2017-03-02 00:37:07.258930970 -0600
@@ -111,10 +111,10 @@
 	$(top_srcdir)/config/ltversion.m4 \
 	$(top_srcdir)/config/lt~obsolete.m4 \
 	$(top_srcdir)/config/autogen_found_items.m4 \
-	$(top_srcdir)/src/plugins/ctp/verbs/configure.m4 \
-	$(top_srcdir)/src/plugins/ctp/eth/configure.m4 \
 	$(top_srcdir)/src/plugins/ctp/gni/configure.m4 \
 	$(top_srcdir)/src/plugins/ctp/sm/configure.m4 \
+	$(top_srcdir)/src/plugins/ctp/eth/configure.m4 \
+	$(top_srcdir)/src/plugins/ctp/verbs/configure.m4 \
 	$(top_srcdir)/configure.ac
 am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
 	$(ACLOCAL_M4)
diff -uNr cci-2.0/src/tests/connect_test.c cci-2.0-patch/src/tests/connect_test.c
--- cci-2.0/src/tests/connect_test.c	1969-12-31 18:00:00.000000000 -0600
+++ cci-2.0-patch/src/tests/connect_test.c	2017-03-02 00:36:35.871758708 -0600
@@ -0,0 +1,780 @@
+/*
+ * Copyright (c) 2016 UT-Battelle, LLC.  All rights reserved.
+ *
+ * See COPYING in top-level directory
+ *
+ * $COPYRIGHT$
+ *
+ */
+
+#include <stdio.h>
+#include <string.h>
+#include <strings.h>
+#include <stdlib.h>
+#include <unistd.h>
+#include <inttypes.h>
+#include <assert.h>
+#include <sys/time.h>
+#include <sys/select.h>
+#include <bsd/queue.h>
+#include <pthread.h>
+
+#include "cci.h"
+
+#define NUM_EPS		(1)
+#define NUM_EP_THREADS	(1)
+#define NUM_EP_CONNS	(8)
+#define CONN_MAX	(10000)
+
+char *name;			/* argv[0] */
+
+cci_device_t **devices = NULL;
+int blocking = 0;
+int nfds = 0;
+fd_set rfds;
+int attempts = 0;
+
+/* The client sends the CCI RMA handle for its test->control->buffer */
+typedef enum msg_type {
+	SERVER_INFO	= 0,	/* client <- server */
+	SEND,
+	RMA_DONE,
+	SHUTDOWN
+} msg_type_t;
+
+/* Must be four-byte aligned */
+typedef struct server_info {
+	cci_rma_handle_t handle;	/* server's RMA handle */
+	uint32_t len;			/* length of endpoint URI */
+	char uri[1];			/* start of URI */
+} info_t;
+
+typedef union msg {
+	struct msg_generic {
+		uint32_t type	:  4;	/* msg_type */
+		uint32_t pad	: 28;
+	} generic;
+
+	struct msg_server_info {
+		uint32_t type	:  4;	/* SERVER_INFO */
+		uint32_t count	:  8;	/* number of server infos */
+		uint32_t pad	: 20;
+	} info;
+
+	struct msg_shutdown {
+		uint32_t type	:  4;	/* SHUTDOWN */
+		uint32_t pad	: 28;
+	} shutdown;
+} msg_t;
+
+typedef struct conn conn_t;
+typedef struct thread thread_t;
+typedef struct ep ep_t;
+typedef struct server server_t;
+typedef struct test test_t;
+
+struct conn {
+	cci_connection_t *c;
+	char *server_uri;
+	TAILQ_ENTRY(conn) entry;	/* hang on ep->conns */
+	cci_conn_attribute_t attr;
+	int pattern;
+	int number;
+};
+
+struct thread {
+	ep_t *ep;			/* owning endpoint */
+	TAILQ_ENTRY(thread) entry;	/* hang on ep->threads */
+	pthread_t tid;
+	int id;
+	int conns_open;
+	int conns_closed;
+};
+
+struct ep {
+	test_t *test;
+	cci_endpoint_t *e;
+	TAILQ_HEAD(t, thread) threads;	/* running threads */
+	TAILQ_HEAD(c, conn) conns;	/* test connections */
+	TAILQ_ENTRY(ep) entry;		/* hang on test->eps */
+	pthread_mutex_t lock;		/* threads, conns, conns_open, conns_closed */
+	void *buffer;			/* RMA buffer */
+	cci_rma_handle_t *handle;
+	char *uri;
+	int id;
+	int conns_open;		/* aggregate of all threads */
+	int conns_closed;	/* aggregate of all threads */
+	int fd;
+};
+
+struct server {
+	cci_rma_handle_t *handle;
+	char *uri;		/* server's CCI endpoint URI */
+};
+
+struct test {
+	TAILQ_HEAD(e, ep) eps;		/* open CCI endpoints */
+	server_t *servers;		/* array of server endpoints */
+	pthread_mutex_t lock;		/* eps, next_conn */
+	ep_t *control;			/* control endpoint - not used for tests */
+	int num_eps;			/* open this many endpoints */
+	int num_ep_threads;		/* use this many threads per endpoint */
+	int num_ep_conns;		/* open conns per endpoint */
+	int next_conn;			/* incremental conn IDs */
+	int num_servers;		/* number of servers in array */
+	int conn_max;		/* End test after this many connections... */
+	int secs;		/*     or this many seconds                */
+	int blocking;
+#define ROLE_SERVER	(1)
+#define ROLE_CLIENT	(2)
+	int role;
+	int ready;
+	int done;
+};
+
+
+static void print_usage(void)
+{
+	fprintf(stderr, "usage: %s "
+			"[-e <num_endpoints>] "
+			"[-t <threads_per_enpoint>] "
+			"[-c <open_conns_per_endpoint>] "
+			"[-h <server_uri> | -s] "
+			"[-S <service>] "
+			"[-n <num_conns> | -T <secs>] "
+			"[-b]\n", name);
+	fprintf(stderr, "where:\n");
+	fprintf(stderr, "\t-e\tOpen this number of CCI endpoints (default %d)\n", NUM_EPS);
+	fprintf(stderr, "\t-t\tThreads per CCI endpoint (default %d)\n", NUM_EP_THREADS);
+	fprintf(stderr, "\t-c\tNumber of open connections per endpoint "
+			"(client only) (default %d)\n", NUM_EP_CONNS);
+	fprintf(stderr, "\t-h\tRun as client and connect to server at this URI\n");
+	fprintf(stderr, "\t-s\tRun as the server\n");
+	fprintf(stderr, "\t-S\tSpecify a service hint for the control endpoint()\n\n");
+	fprintf(stderr, "\t-n\tTest this number of connections (default %d)\n", CONN_MAX);
+	fprintf(stderr, "\t-T\tRun for this number of seconds\n");
+	fprintf(stderr, "\t-b\tBlock using the OS handle instead of polling\n");
+	fprintf(stderr, "Example:\n");
+	fprintf(stderr, "server$ %s -s -S 5000 -e 2 -t 8\n", name);
+	fprintf(stderr, "client$ %s -h tcp://host:5000 -e 1 -t 4 -c 20\n", name);
+	exit(EXIT_FAILURE);
+}
+
+static void check_return(test_t *test, char *func, int ret, int need_exit)
+{
+	conn_t *conn = TAILQ_FIRST(&test->control->conns);
+
+	if (ret) {
+		fprintf(stderr, "%s() returned %s\n", func,
+				cci_strerror(test->control->e, ret));
+		if (need_exit) {
+			cci_send(conn->c, "bye", 3, (void *)0xdeadbeef, CCI_FLAG_BLOCKING);
+			cci_finalize();
+			exit(EXIT_FAILURE);
+		}
+	}
+	return;
+}
+
+static void
+do_client(test_t *test)
+{
+	int ret = 0, try = 0, i = 0, done = 0;
+	conn_t *conn = TAILQ_FIRST(&test->control->conns);
+	cci_event_t *event = NULL;
+	msg_t *msg = NULL;
+	uintptr_t offset = 0;
+
+	/* connect to server */
+	do {
+		ret = cci_connect(test->control->e, conn->server_uri,
+				(void*)test->control->handle,
+				sizeof(*test->control->handle),
+				CCI_CONN_ATTR_RO, NULL, 0, NULL);
+		if (ret) {
+			fprintf(stderr, "cci_connect() failed with %s\n",
+					cci_strerror(test->control->e, ret));
+			continue;
+		}
+
+		do {
+			ret = cci_get_event(test->control->e, &event);
+		} while (ret);
+
+		assert(event->type == CCI_EVENT_CONNECT);
+
+		conn->c = event->connect.connection;
+
+		if (event->connect.status)
+			fprintf(stderr, "CONNECT event status is %d\n",
+					event->connect.status);
+
+		cci_return_event(event);
+
+		if (!conn->c)
+			sleep(1);
+
+	} while (!conn->c && try++ < 60);
+
+	if (!conn->c)
+		return;
+
+	/* wait for server's endpoint info */
+	do {
+		cci_get_event(test->control->e, &event);
+	} while (!event);
+
+	assert(event->type == CCI_EVENT_RECV);
+
+	msg = (void*) event->recv.ptr;
+	assert(msg->info.type == SERVER_INFO);
+
+	/* store server info */
+	test->num_servers = msg->info.count;
+
+	test->servers = calloc(test->num_servers, sizeof(*test->servers));
+	if (!test->servers) {
+		fprintf(stderr, "%s: calloc(test->servers) failed\n", __func__);
+		goto out;
+	}
+
+	offset = (uintptr_t)test->control->buffer;
+
+	for (i = 0; i < test->num_servers; i++) {
+		info_t *info = NULL;
+		server_t *server = NULL;
+
+		server = &test->servers[i];
+		server->handle = calloc(1, sizeof(*server->handle));
+		if (!server->handle) {
+			fprintf(stderr, "%s: calloc(server->handle[%d]) failed\n",
+					__func__, i);
+			break;
+		}
+
+		info = (void*)offset;
+
+		memcpy(&server->handle, &info->handle, sizeof(*server->handle));
+
+		server->uri = calloc(1, info->len + 1);
+		if (!server->uri) {
+			fprintf(stderr, "%s: calloc(server->uri[%d]) failed\n",
+					__func__, i);
+			break;
+		}
+		memcpy(server->uri, info->uri, info->len);
+
+		offset = (uintptr_t)&info->uri; /* move to the start of the URI */
+		offset += info->len; /* move to the end of the URI */
+		if (offset % 8) {
+			/* if not 8-byte aligned, align it */
+			offset += (8 - (offset % 8));
+			assert((offset % 8) == 0);
+		}
+	}
+
+	cci_return_event(event);
+
+	/* we are ready to go */
+
+	pthread_mutex_lock(&test->lock);
+	test->ready = 1;
+	pthread_mutex_unlock(&test->lock);
+
+	do {
+		int shutdown = 0;
+
+		sleep(1);
+
+		ret = cci_get_event(test->control->e, &event);
+		if (!ret) {
+			msg_t *msg = NULL;
+
+			assert(event->type == CCI_EVENT_RECV);
+
+			msg = (void*)event->recv.ptr;
+			assert(msg->shutdown.type == SHUTDOWN);
+
+			cci_return_event(event);
+
+			shutdown = 1;
+			done++;
+		}
+
+		pthread_mutex_lock(&test->lock);
+		if (test->done)
+			done++;
+
+		if (shutdown)
+			test->done = 1;
+		pthread_mutex_unlock(&test->lock);
+
+		if (!shutdown) {
+			msg_t shutdown;
+
+			shutdown.shutdown.type = SHUTDOWN;
+
+			ret = cci_send(conn->c, &shutdown, sizeof(shutdown),
+					(void*)0x987654321, 0);
+			check_return(test, "cci_send(shutdown)", ret, 1);
+
+			while (1) {
+				ret = cci_get_event(test->control->e, &event);
+				if (ret) continue;
+
+				if (event->type == CCI_EVENT_SEND) {
+					if (event->send.context == (void*)0x987654321)
+						break;
+				}
+
+				cci_return_event(event);
+			}
+		}
+	} while (!done);
+
+    out:
+	cci_disconnect(conn->c);
+
+	return;
+}
+
+static void *
+server_thread(void *arg)
+{
+	pthread_exit(NULL);
+}
+
+static void
+do_server(test_t *test)
+{
+	int ret = 0, len = 0, done = 0;
+	ep_t *ep = NULL;
+	conn_t *conn = TAILQ_FIRST(&test->control->conns);
+	cci_event_t *event = NULL;
+	msg_t msg;
+	uintptr_t offset = 0;
+	info_t *info = NULL;
+	cci_rma_handle_t client_handle;
+
+	/* wait for client to connect */
+	do {
+		ret = cci_get_event(test->control->e, &event);
+	} while (ret);
+
+	assert(event->type == CCI_EVENT_CONNECT_REQUEST);
+
+	memcpy((void*)&client_handle, event->request.data_ptr, event->request.data_len);
+
+	ret = cci_accept(event, NULL);
+	if (ret) {
+		fprintf(stderr, "%s: cci_accept() failed with %s\n",
+				__func__, cci_strerror(test->control->e, ret));
+		goto out;
+	}
+
+	ret = cci_return_event(event);
+	if (ret) {
+		fprintf(stderr, "%s: cci_return_event() failed with %s\n",
+				__func__, cci_strerror(test->control->e, ret));
+		goto out;
+	}
+
+	/* wait for the accept event */
+	do {
+		cci_get_event(test->control->e, &event);
+	} while (!event);
+
+	assert(event->type == CCI_EVENT_ACCEPT);
+
+	conn->c = event->accept.connection;
+
+	if (event->accept.status)
+		fprintf(stderr, "%s: ACCEPT failed with %s\n",
+				__func__, cci_strerror(test->control->e,
+					event->accept.status));
+
+	assert(conn->c);
+
+	/* send endpoint info */
+
+	TAILQ_FOREACH(ep, &test->eps, entry) {
+		len += sizeof(*info) + strlen(ep->uri) + 1;
+		if (len % 8)
+			len += (8 - (len % 8));
+	}
+
+	msg.info.type = SERVER_INFO;
+	msg.info.count = test->num_eps;
+
+	offset = (uintptr_t)test->control->buffer;
+
+	TAILQ_FOREACH(ep, &test->eps, entry) {
+		info = (void*)offset;
+
+		memcpy((void*)&info->handle, ep->handle, sizeof(info->handle));
+		info->len = strlen(ep->uri);
+		memcpy(info->uri, ep->uri, info->len);
+
+		/* ensure the offset is 8-byte aligned */
+		offset = (uintptr_t)&info->uri; /* move to the start of the URI */
+		offset += info->len; /* move to the end of the URI */
+		if (offset % 8) {
+			/* if not 8-byte aligned, align it */
+			offset += (8 - (offset % 8));
+			assert((offset % 8) == 0);
+		}
+	}
+
+	ret = cci_rma(conn->c, &msg, sizeof(msg),
+			test->control->handle, 0,
+			&client_handle, 0,
+			(uint64_t)(offset - (uintptr_t)test->control->buffer),
+			NULL, CCI_FLAG_WRITE);
+	check_return(test, "cci_rma", ret, 1);
+
+	do {
+		cci_get_event(test->control->e, &event);
+	} while (!event);
+
+	assert(event->type == CCI_EVENT_SEND);
+
+	ret = cci_return_event(event);
+	check_return(test, "cci_return_event(rma)", ret, 1);
+
+	do {
+		int shutdown = 0;
+
+		sleep(1);
+
+		ret = cci_get_event(test->control->e, &event);
+		if (!ret) {
+			msg_t *msg = NULL;
+
+			assert(event->type == CCI_EVENT_RECV);
+
+			msg = (void*)event->recv.ptr;
+			assert(msg->shutdown.type == SHUTDOWN);
+
+			cci_return_event(event);
+
+			shutdown = 1;
+			done++;
+		}
+
+		pthread_mutex_lock(&test->lock);
+		if (test->done)
+			done++;
+
+		if (shutdown)
+			test->done = 1;
+		pthread_mutex_unlock(&test->lock);
+
+		if (!shutdown) {
+			msg_t shutdown;
+
+			shutdown.shutdown.type = SHUTDOWN;
+
+			ret = cci_send(conn->c, &shutdown, sizeof(shutdown),
+					(void*)0x987654321, 0);
+			check_return(test, "cci_send(shutdown)", ret, 1);
+
+			while (1) {
+				ret = cci_get_event(test->control->e, &event);
+				if (ret) continue;
+
+				if (event->type == CCI_EVENT_SEND) {
+					if (event->send.context == (void*)0x987654321)
+						break;
+				}
+
+				cci_return_event(event);
+			}
+		}
+	} while (!done);
+
+    out:
+	pthread_mutex_lock(&test->lock);
+	test->done = 1;
+	pthread_mutex_unlock(&test->lock);
+
+	return;
+}
+
+static void *
+client_thread(void *arg)
+{
+	pthread_exit(NULL);
+}
+
+static int
+create_threads(test_t *test, ep_t *ep)
+{
+	int ret = 0, i = 0;
+	void *(*func)(void*) = test->role == ROLE_SERVER ? server_thread : client_thread;
+
+	for (i = 0; i < test->num_ep_threads; i++) {
+		thread_t *thread = NULL;
+
+		thread = calloc(1, sizeof(*thread));
+		if (!thread) {
+			ret = ENOMEM;
+			goto out;
+		}
+
+		thread->ep = ep;
+		thread->id = i;
+		TAILQ_INSERT_TAIL(&ep->threads, thread, entry);
+		ret = pthread_create(&thread->tid, NULL, func, (void*)thread);
+		if (ret) {
+			fprintf(stderr, "%s: pthread_create(%d) failed with %s\n",
+					__func__, i, strerror(ret));
+			goto out;
+		}
+	}
+
+    out:
+	return ret;
+}
+
+static int
+create_endpoints(test_t *test)
+{
+	int ret = 0, i = 0;
+
+	for (i = 0; i < test->num_eps; i++) {
+		ep_t *ep = NULL;
+		cci_os_handle_t *fd = NULL;
+
+		if (test->blocking)
+			fd = &ep->fd;
+
+		ep = calloc(1, sizeof(*ep));
+		if (!ep) {
+			fprintf(stderr, "%s: calloc(ep%d) failed\n", __func__, i);
+			ret = ENOMEM;
+			goto out;
+		}
+
+		ep->test = test;
+
+		ret = cci_create_endpoint(NULL, 0, &ep->e, fd);
+		if (ret) {
+			fprintf(stderr, "%s: cci_create_endpoint(%d) failed with %s (%d)\n",
+				__func__, i, cci_strerror(NULL, ret), ret);
+			goto out;
+		}
+
+		TAILQ_INIT(&ep->threads);
+		TAILQ_INIT(&ep->conns);
+		ret = pthread_mutex_init(&ep->lock, NULL);
+		if (ret) {
+			fprintf(stderr, "%s: calloc(ep%d) failed with %s\n",
+					__func__, i, strerror(ret));
+			goto out;
+		}
+
+		ep->buffer = malloc(1024*1024);
+		if (!ep->buffer) {
+			fprintf(stderr, "%s: malloc(ep%d) failed\n", __func__, i);
+			ret = ENOMEM;
+			goto out;
+		}
+
+		ret = cci_rma_register(ep->e, ep->buffer, 1024*1024,
+				CCI_FLAG_READ|CCI_FLAG_WRITE, &ep->handle);
+		if (ret) {
+			fprintf(stderr, "%s: cci_rma_register(%d) failed with %s (%d)\n",
+				__func__, i, cci_strerror(ep->e, ret), ret);
+			goto out;
+		}
+		ret = cci_get_opt(ep->e, CCI_OPT_ENDPT_URI, &ep->uri);
+		if (ret) {
+			fprintf(stderr, "%s: cci_get_opt(%d) failed with %s\n",
+					__func__, i, cci_strerror(ep->e, ret));
+			goto out;
+		}
+		ep->id = i;
+
+		TAILQ_INSERT_TAIL(&test->eps, ep, entry);
+
+		ret = create_threads(test, ep);
+		if (ret) goto out;
+	}
+
+    out:
+	return ret;
+}
+
+int main(int argc, char *argv[])
+{
+	int ret, c, is_server = 0;
+	uint32_t caps = 0;
+	char *service = NULL;
+	cci_os_handle_t *os_handle = NULL;
+	test_t *test = NULL;
+	conn_t *conn = NULL;
+
+	name = argv[0];
+
+	test = calloc(1, sizeof(*test));
+	if (!test) {
+		fprintf(stderr, "calloc(test) failed\n");
+		exit(EXIT_FAILURE);
+	}
+	TAILQ_INIT(&test->eps);
+	ret = pthread_mutex_init(&test->lock, NULL);
+	if (ret) {
+		fprintf(stderr, "pthread_mutex_init(test->lock) failed with %s\n",
+				strerror(ret));
+		goto out_w_test;
+	}
+	test->num_eps = NUM_EPS;
+	test->num_ep_threads = NUM_EP_THREADS;
+	test->num_ep_conns = NUM_EP_CONNS;
+	test->conn_max = CONN_MAX;
+	test->secs = 0;
+
+	test->control = calloc(1, sizeof(*test->control));
+	if (!test->control) {
+		fprintf(stderr, "calloc(test->control) failed\n");
+		goto out_w_test;
+	}
+	test->control->test = test;
+	TAILQ_INIT(&test->control->threads);
+	TAILQ_INIT(&test->control->conns);
+	ret = pthread_mutex_init(&test->control->lock, NULL);
+	if (ret) {
+		fprintf(stderr, "pthread_mutex_init(test->control->lock) failed with %s\n",
+				strerror(ret));
+		goto out_w_control;
+	}
+	test->control->buffer = calloc(1, 1024*1024);
+	if (!test->control->buffer) {
+		fprintf(stderr, "calloc(control->buffer) failed\n");
+		goto out_w_control;
+	}
+
+	conn = calloc(1, sizeof(*conn));
+	if (!conn) {
+		fprintf(stderr, "calloc(conn) failed\n");
+		goto out_w_buffer;
+	}
+	TAILQ_INSERT_TAIL(&test->control->conns, conn, entry);
+
+	while ((c = getopt(argc, argv, "e:t:c:h:sS:n:T:b")) != -1) {
+		switch (c) {
+		case 'e':
+			test->num_eps = strtol(optarg, NULL, 0);
+			/* the msg->info.count uses 8 bits */
+			assert(test->num_eps < 256);
+			break;
+		case 't':
+			test->num_ep_threads = strtol(optarg, NULL, 0);
+			break;
+		case 'c':
+			test->num_ep_conns = strtol(optarg, NULL, 0);
+			break;
+		case 'h':
+			test->role = ROLE_CLIENT;
+			conn->server_uri = strdup(optarg);
+			break;
+		case 's':
+			test->role = ROLE_SERVER;
+			is_server = 1;
+			break;
+		case 'S':
+			service = strdup(optarg);
+			if (!service)
+				fprintf(stderr, "strdup(service) failed.\n");
+			break;
+		case 'n':
+			test->conn_max = strtoul(optarg, NULL, 0);
+			break;
+		case 'T':
+			test->secs = strtoul(optarg, NULL, 0);
+			break;
+		case 'b':
+			test->blocking = 1;
+			os_handle = &test->control->fd;
+			break;
+		default:
+			print_usage();
+		}
+	}
+
+	if (!is_server && !conn->server_uri) {
+		fprintf(stderr, "Must select -h or -s\n");
+		print_usage();
+	}
+
+	ret = cci_init(CCI_ABI_VERSION, 0, &caps);
+	if (ret) {
+		fprintf(stderr, "cci_init() failed with %s\n",
+			cci_strerror(NULL, ret));
+		goto out_w_conn;
+	}
+
+	/* create an endpoint */
+	if (service) {
+		cci_device_t * const * devices = NULL;
+		ret = cci_get_devices(&devices);
+		if (ret != CCI_SUCCESS) {
+			fprintf(stderr, "%s: cci_get_devices() failed with %s\n,",
+				__func__, cci_strerror(NULL, ret));
+		}
+
+		ret = cci_create_endpoint_at(devices[0], service, 0, &test->control->e, os_handle);
+	} else {
+		ret = cci_create_endpoint(NULL, 0, &test->control->e, os_handle);
+	}
+	if (ret) {
+		fprintf(stderr, "cci_create_endpoint() failed with %s (%d)\n",
+			cci_strerror(NULL, ret), ret);
+		goto out_w_cci;
+	}
+
+	ret = cci_rma_register(test->control->e, test->control->buffer, 1024*1024,
+			CCI_FLAG_WRITE, &test->control->handle);
+	check_return(test, "cci_rma_register(control->buffer)", ret, 1);
+
+	ret = cci_get_opt(test->control->e, CCI_OPT_ENDPT_URI, &test->control->uri);
+	check_return(test, "cci_get_opt", ret, 1);
+
+	fprintf(stderr, "Opened %s\n", test->control->uri);
+
+	ret = create_endpoints(test);
+	if (ret) goto out_w_ep;
+
+	if (is_server)
+		do_server(test);
+	else
+		do_client(test);
+
+    out_w_ep:
+	free(test->control->uri);
+	ret = cci_destroy_endpoint(test->control->e);
+	if (ret)
+		fprintf(stderr, "cci_destroy_endpoint() failed with %s\n",
+			cci_strerror(NULL, ret));
+
+    out_w_cci:
+	ret = cci_finalize();
+	if (ret)
+		fprintf(stderr, "cci_finalize() failed with %s\n",
+			cci_strerror(NULL, ret));
+
+    out_w_conn:
+	free(conn);
+
+    out_w_buffer:
+	free(test->control->buffer);
+
+    out_w_control:
+	free(service);
+	free(test->control);
+
+    out_w_test:
+	free(test);
+
+	return 0;
+}
diff -uNr cci-2.0/src/tests/Makefile.in cci-2.0-patch/src/tests/Makefile.in
--- cci-2.0/src/tests/Makefile.in	2016-06-28 12:58:05.000000000 -0500
+++ cci-2.0-patch/src/tests/Makefile.in	2017-03-02 00:37:07.309931250 -0600
@@ -118,10 +118,10 @@
 	$(top_srcdir)/config/ltversion.m4 \
 	$(top_srcdir)/config/lt~obsolete.m4 \
 	$(top_srcdir)/config/autogen_found_items.m4 \
-	$(top_srcdir)/src/plugins/ctp/verbs/configure.m4 \
-	$(top_srcdir)/src/plugins/ctp/eth/configure.m4 \
 	$(top_srcdir)/src/plugins/ctp/gni/configure.m4 \
 	$(top_srcdir)/src/plugins/ctp/sm/configure.m4 \
+	$(top_srcdir)/src/plugins/ctp/eth/configure.m4 \
+	$(top_srcdir)/src/plugins/ctp/verbs/configure.m4 \
 	$(top_srcdir)/configure.ac
 am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
 	$(ACLOCAL_M4)
diff -uNr cci-2.0/src/util/Makefile.in cci-2.0-patch/src/util/Makefile.in
--- cci-2.0/src/util/Makefile.in	2016-06-28 12:58:05.000000000 -0500
+++ cci-2.0-patch/src/util/Makefile.in	2017-03-02 00:37:07.340931419 -0600
@@ -111,10 +111,10 @@
 	$(top_srcdir)/config/ltversion.m4 \
 	$(top_srcdir)/config/lt~obsolete.m4 \
 	$(top_srcdir)/config/autogen_found_items.m4 \
-	$(top_srcdir)/src/plugins/ctp/verbs/configure.m4 \
-	$(top_srcdir)/src/plugins/ctp/eth/configure.m4 \
 	$(top_srcdir)/src/plugins/ctp/gni/configure.m4 \
 	$(top_srcdir)/src/plugins/ctp/sm/configure.m4 \
+	$(top_srcdir)/src/plugins/ctp/eth/configure.m4 \
+	$(top_srcdir)/src/plugins/ctp/verbs/configure.m4 \
 	$(top_srcdir)/configure.ac
 am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
 	$(ACLOCAL_M4)
